{% load static %}
<html>
  <head>
    <title>مدیریت ساختمان آرشا</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap CSS (Local) -->
    <link rel="stylesheet" href="{% static 'vendor/bootstrap/4.3.1/css/bootstrap.min.css' %}">
    
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Persian Date Picker CSS (Local) -->
    <link rel="stylesheet" href="{% static 'vendor/persian-datepicker/1.2.0/css/persian-datepicker.min.css' %}">
    
    <!-- Custom Persian Calendar CSS -->
    <link rel="stylesheet" href="{% static 'construction/css/persian-calendar.css' %}">
    
    <!-- Custom CSS for RTL support -->
    <style>
        body {
            direction: rtl;
            text-align: right;
            font-family: 'Tahoma', 'Vazir', sans-serif;
        }
        .persian-datepicker {
            direction: rtl;
        }
        .table td:first-child {
            font-weight: bold;
        }
    </style>
    
    {% block extrahead %}{% endblock %}
  </head>
  <body>
    {% block content %}{% endblock %}
    
    <!-- jQuery (Local) -->
    <script src="{% static 'vendor/jquery/3.6.0/jquery.min.js' %}"></script>
    
    <!-- Bootstrap JS (Local) -->
    <script src="{% static 'vendor/bootstrap/4.3.1/js/bootstrap.min.js' %}"></script>
    
    <!-- Persian Date Libraries (Local) -->
    <script src="{% static 'vendor/persian-date/1.1.0/persian-date.min.js' %}"></script>
    <script src="{% static 'vendor/persian-datepicker/1.2.0/js/persian-datepicker.min.js' %}"></script>
    
    <!-- Initialize Persian Date Picker -->
    <script>
        $(document).ready(function() {
            // فعال‌سازی persian-datepicker برای فیلدهای تاریخ شمسی
            $('input[name*="shamsi"]').each(function() {
                var fieldName = $(this).attr('name');
                
                // تنظیم تاریخ امروز برای نمایش اولیه با اصلاح timezone
                var today = new Date();
                var todayForInit = new persianDate(today);
                
                $(this).pDatepicker({
                    format: 'YYYY-MM-DD',
                    initialValue: todayForInit,
                    initialValueType: 'persian',
                    calendar: {
                        persian: {
                            locale: 'fa',
                            leapYearMode: 'astronomical'
                        }
                    },
                    timePicker: {
                        enabled: false
                    },
                    navigator: {
                        enabled: true
                    },
                    toolbox: {
                        enabled: true,
                        calendarSwitch: {
                            enabled: false
                        },
                        todayButton: {
                            enabled: true,
                            text: {
                                fa: "امروز"
                            }
                        },
                        submitButton: {
                            enabled: true,
                            text: {
                                fa: "انتخاب"
                            }
                        }
                    },
                    // تنظیم تاریخ امروز به صورت صحیح
                    observer: true,
                    autoClose: true,
                    // تنظیم تاریخ پیش‌فرض روی امروز
                    viewMode: 'day',
                    minDate: false,
                    maxDate: false,
                    defaultDate: todayForInit,
                    onSelect: function(unix) {
                        try {
                            // استفاده از persianDate برای تاریخ انتخابی
                            var selectedDate = new persianDate(unix);
                            
                            console.log('تاریخ انتخابی شمسی:', selectedDate.format('YYYY-MM-DD'));
                            console.log('Unix timestamp:', unix);
                            
                            // تبدیل به تاریخ میلادی با اصلاح timezone
                            var gregorianDate = selectedDate.toDate();
                            
                            // اصلاح timezone offset برای جلوگیری از یک روز جلو بودن
                            var timezoneOffset = gregorianDate.getTimezoneOffset();
                            var correctedDate = new Date(gregorianDate.getTime() + (timezoneOffset * 60000));
                            
                            console.log('تاریخ میلادی قبل از اصلاح:', gregorianDate);
                            console.log('Timezone offset:', timezoneOffset);
                            console.log('تاریخ میلادی بعد از اصلاح:', correctedDate);
                            
                            // پیدا کردن فیلد میلادی مرتبط
                            var gregorianFieldName = fieldName.replace('_shamsi', '_gregorian');
                            var gregorianField = $("#id_" + gregorianFieldName);
                            
                            if (gregorianField.length) {
                                var year = correctedDate.getFullYear();
                                var month = String(correctedDate.getMonth() + 1).padStart(2, '0');
                                var day = String(correctedDate.getDate()).padStart(2, '0');
                                
                                gregorianField.val(year + '-' + month + '-' + day);
                                console.log('تاریخ میلادی نهایی:', year + '-' + month + '-' + day);
                            }
                        } catch(e) {
                            console.log('خطا در تبدیل تاریخ:', e);
                        }
                    }
                });
                
                // اضافه کردن کلاس و ویژگی‌های اضافی
                $(this).addClass('jalali-date-input');
                $(this).attr('dir', 'rtl');
                $(this).attr('readonly', 'readonly');
                $(this).attr('placeholder', 'انتخاب تاریخ شمسی...');
            });
            
            // نمایش تاریخ امروز در کنسول برای بررسی
            var today = new Date();
            var todayPersian = new persianDate(today);
            console.log('=== بررسی تاریخ امروز ===');
            console.log('تاریخ میلادی امروز:', today);
            console.log('تاریخ شمسی امروز:', todayPersian.format('dddd، DD MMMM YYYY'));
            console.log('تاریخ شمسی (فرمت کوتاه):', todayPersian.format('YYYY-MM-DD'));
            console.log('Unix timestamp امروز:', todayPersian.unix());
            
            // دیباگ: نمایش مقادیر فرم هنگام ارسال
            $('form').on('submit', function() {
                console.log('=== ارسال فرم ===');
                $('input[name*="shamsi"]').each(function() {
                    console.log($(this).attr('name') + ':', $(this).val());
                });
            });
        });
    </script>
    
    {% block extrascripts %}{% endblock %}
  </body>
</html>
