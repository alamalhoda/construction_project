{% extends "base.html" %}
{% load static %}

{% block title %}Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ - AI Assistant{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<style>
    /* CSS Variables - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ */
    :root {
        --capital-color: #667eea;
        --capital-color-light: rgba(102, 126, 234, 0.1);
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --text-primary: #2c3e50;
        --text-secondary: #6c757d;
        --text-muted: #8e9297;
        --bg-primary: #f8f9fa;
        --bg-secondary: #ffffff;
        --border-color: #e9ecef;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 8px 25px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.12);
    }

    /* Override base.html card styles - Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§Ø´Ø¯ */
    body #content,
    #content {
        padding: 0 !important;
        max-width: 100% !important;
        margin: 0 auto !important;
    }
    
    body #content.container,
    #content.container {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }
    
    body #content .card,
    #content .card {
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        background: transparent !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        display: block !important;
    }
    
    body #content .card-body,
    #content .card-body {
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        background: transparent !important;
        display: block !important;
    }
    
    body #content .card-text,
    #content .card-text {
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        background: transparent !important;
        display: block !important;
        all: unset !important;
    }
    
    /* Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ chat-container Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
    body .chat-container,
    .chat-container {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
        background-attachment: fixed !important;
        min-height: 100vh !important;
    }
    
    .chat-container {
        max-width: 1200px !important;
        margin: 20px auto !important;
        border: none !important;
        border-radius: 20px !important;
        overflow: hidden !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
        background: #ffffff !important;
        height: calc(100vh - 160px) !important;
        display: flex !important;
        flex-direction: column !important;
        transition: all 0.3s ease !important;
    }
    
    .chat-header {
        background: linear-gradient(135deg, var(--capital-color) 0%, var(--secondary-color) 100%) !important;
        color: white !important;
        padding: 20px 28px !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        border-bottom: none !important;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3) !important;
        position: relative !important;
        overflow: hidden !important;
    }
    
    .chat-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        pointer-events: none;
    }
    
    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        z-index: 1;
    }
    
    .chat-header-icon {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        animation: pulse 2s ease-in-out infinite;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
    }
    
    @keyframes pulse {
        0%, 100% { 
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        50% { 
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
        }
    }
    
    .chat-header-text h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
    }
    
    .chat-header-text p {
        margin: 4px 0 0 0;
        opacity: 0.9;
        font-size: 13px;
    }
    
    .chat-header-actions {
        display: flex;
        gap: 8px;
    }
    
    .header-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1;
    }
    
    .header-btn:hover {
        background: rgba(255, 255, 255, 0.35);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .header-btn:active {
        transform: translateY(0);
    }
    
    .chat-messages {
        flex: 1 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        padding: 24px 32px !important;
        background: #ffffff !important;
        direction: rtl !important;
        scroll-behavior: smooth !important;
        position: relative !important;
        min-height: 0 !important;
    }
    
    .chat-messages::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100px;
        background: linear-gradient(to bottom, rgba(102, 126, 234, 0.05), transparent);
        pointer-events: none;
        z-index: 0;
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
    }
    
    .message-wrapper {
        margin-bottom: 20px !important;
        animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
        display: flex !important;
        align-items: flex-start !important;
        gap: 12px !important;
        position: relative !important;
        z-index: 1 !important;
        width: 100% !important;
    }
    
    .message-wrapper.user-wrapper {
        flex-direction: row-reverse !important;
        justify-content: flex-start !important;
    }
    
    .message-wrapper:not(.user-wrapper) {
        justify-content: flex-start !important;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .message-avatar {
        width: 44px !important;
        height: 44px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 20px !important;
        flex-shrink: 0 !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        transition: transform 0.2s !important;
    }
    
    .message-wrapper:hover .message-avatar {
        transform: scale(1.05) !important;
    }
    
    .user-wrapper .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
    }
    
    .message-wrapper:not(.user-wrapper) .message-avatar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
        color: white !important;
    }
    
    .message {
        padding: 18px 24px !important;
        border-radius: 18px !important;
        max-width: 80% !important;
        word-wrap: break-word !important;
        line-height: 1.7 !important;
        position: relative !important;
        transition: all 0.3s ease !important;
        margin-bottom: 16px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }
    
    .message:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø± - Ø¸Ø§Ù‡Ø± Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…ØªÙØ§ÙˆØª */
    .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        margin-left: auto !important;
        margin-right: 0 !important;
        text-align: right !important;
        border-radius: 18px 18px 4px 18px !important;
        position: relative !important;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
        font-weight: 500 !important;
    }
    
    .user-message .message-header {
        color: rgba(255, 255, 255, 0.95) !important;
        font-size: 13px !important;
        margin-bottom: 8px !important;
        font-weight: 600 !important;
    }
    
    .user-message .message-content {
        color: white !important;
        font-size: 15px !important;
    }
    
    /* Ù¾ÛŒØ§Ù… Ø¯Ø³ØªÛŒØ§Ø± - Ø¸Ø§Ù‡Ø± Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…ØªÙØ§ÙˆØª */
    .assistant-message {
        background: #f8f9fa !important;
        border: 2px solid #e9ecef !important;
        margin-right: auto !important;
        margin-left: 0 !important;
        text-align: right !important;
        border-radius: 18px 18px 18px 4px !important;
        position: relative !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
    }
    
    .assistant-message .message-header {
        color: #6c757d !important;
        font-size: 13px !important;
        margin-bottom: 10px !important;
        font-weight: 600 !important;
    }
    
    .assistant-message .message-content {
        color: #2c3e50 !important;
        font-size: 15px !important;
        word-wrap: break-word !important;
        line-height: 1.7 !important;
    }
    
    .assistant-message .message-content br {
        display: block !important;
        content: "" !important;
        margin: 4px 0 !important;
    }
    
    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 12px;
        opacity: 0.85;
        font-weight: 500;
    }
    
    .user-message .message-header {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .assistant-message .message-header {
        color: var(--text-secondary);
    }
    
    .message-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .message-wrapper:hover .message-actions {
        opacity: 1;
    }
    
    .message-action-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .message-action-btn:hover {
        background: var(--bg-primary);
        color: var(--primary-color);
    }
    
    .assistant-message pre {
        background: #e9ecef !important;
        padding: 14px !important;
        border-radius: 8px !important;
        overflow-x: auto !important;
        margin: 12px 0 !important;
        direction: ltr !important;
        text-align: left !important;
        border: 1px solid #dee2e6 !important;
        font-family: 'Courier New', monospace !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
    }
    
    .assistant-message code {
        background: rgba(102, 126, 234, 0.1) !important;
        padding: 3px 8px !important;
        border-radius: 4px !important;
        font-family: 'Courier New', monospace !important;
        font-size: 0.9em !important;
        color: #667eea !important;
    }
    
    .assistant-message pre code {
        background: none !important;
        padding: 0 !important;
        color: inherit !important;
    }
    
    .assistant-message ul, .assistant-message ol {
        margin: 12px 0 !important;
        padding-right: 24px !important;
    }
    
    .assistant-message li {
        margin: 8px 0 !important;
        line-height: 1.6 !important;
    }
    
    .assistant-message strong {
        color: #2c3e50 !important;
        font-weight: 600 !important;
    }
    
    .assistant-message a {
        color: #667eea !important;
        text-decoration: underline !important;
    }
    
    .assistant-message a:hover {
        color: #764ba2 !important;
    }
    
    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Markdown */
    .assistant-message h1,
    .assistant-message h2,
    .assistant-message h3,
    .assistant-message h4,
    .assistant-message h5,
    .assistant-message h6 {
        color: #2c3e50 !important;
        font-weight: 600 !important;
        margin: 16px 0 12px 0 !important;
        line-height: 1.4 !important;
    }
    
    .assistant-message h1 {
        font-size: 24px !important;
        border-bottom: 2px solid var(--border-color) !important;
        padding-bottom: 8px !important;
    }
    
    .assistant-message h2 {
        font-size: 20px !important;
        border-bottom: 1px solid var(--border-color) !important;
        padding-bottom: 6px !important;
    }
    
    .assistant-message h3 {
        font-size: 18px !important;
    }
    
    .assistant-message h4 {
        font-size: 16px !important;
    }
    
    .assistant-message h5,
    .assistant-message h6 {
        font-size: 14px !important;
    }
    
    .assistant-message p {
        margin: 12px 0 !important;
        line-height: 1.7 !important;
    }
    
    .assistant-message em {
        font-style: italic !important;
        color: var(--text-primary) !important;
    }
    
    .assistant-message blockquote {
        border-right: 4px solid var(--capital-color) !important;
        padding: 12px 16px !important;
        margin: 16px 0 !important;
        background: var(--capital-color-light) !important;
        border-radius: 4px !important;
        font-style: italic !important;
        color: var(--text-secondary) !important;
    }
    
    .assistant-message hr {
        border: none !important;
        border-top: 2px solid var(--border-color) !important;
        margin: 24px 0 !important;
    }
    
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¬Ø¯Ø§ÙˆÙ„ Markdown */
    .assistant-message table,
    .assistant-message .message-content table,
    .message-content table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin: 20px 0 !important;
        background: white !important;
        border-radius: 8px !important;
        overflow: hidden !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
        display: table !important;
        table-layout: auto !important;
    }
    
    .assistant-message table thead,
    .assistant-message .message-content table thead,
    .message-content table thead {
        display: table-header-group !important;
    }
    
    .assistant-message table tbody,
    .assistant-message .message-content table tbody,
    .message-content table tbody {
        display: table-row-group !important;
    }
    
    .assistant-message table tr,
    .assistant-message .message-content table tr,
    .message-content table tr {
        display: table-row !important;
    }
    
    .assistant-message table th,
    .assistant-message .message-content table th,
    .message-content table th {
        background: linear-gradient(135deg, var(--capital-color) 0%, var(--secondary-color) 100%) !important;
        color: white !important;
        padding: 12px 16px !important;
        text-align: right !important;
        font-weight: 600 !important;
        border: none !important;
        display: table-cell !important;
        vertical-align: middle !important;
    }
    
    .assistant-message table td,
    .assistant-message .message-content table td,
    .message-content table td {
        padding: 10px 16px !important;
        border-top: 1px solid var(--border-color) !important;
        border-bottom: 1px solid var(--border-color) !important;
        text-align: right !important;
        display: table-cell !important;
        vertical-align: middle !important;
    }
    
    .assistant-message table tr:nth-child(even),
    .assistant-message .message-content table tr:nth-child(even),
    .message-content table tr:nth-child(even) {
        background: var(--bg-primary) !important;
    }
    
    .assistant-message table tr:hover,
    .assistant-message .message-content table tr:hover,
    .message-content table tr:hover {
        background: var(--capital-color-light) !important;
        transition: background 0.2s ease !important;
    }
    
    .assistant-message table tr:last-child td,
    .assistant-message .message-content table tr:last-child td,
    .message-content table tr:last-child td {
        border-bottom: none !important;
    }
    
    .assistant-message table thead tr th:first-child,
    .assistant-message .message-content table thead tr th:first-child,
    .message-content table thead tr th:first-child {
        border-top-right-radius: 8px !important;
    }
    
    .assistant-message table thead tr th:last-child,
    .assistant-message .message-content table thead tr th:last-child,
    .message-content table thead tr th:last-child {
        border-top-left-radius: 8px !important;
    }
    
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ØªØµØ§ÙˆÛŒØ± */
    .assistant-message img {
        max-width: 100% !important;
        height: auto !important;
        border-radius: 8px !important;
        margin: 12px 0 !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø®Ø· Ø§ÙÙ‚ÛŒ */
    .assistant-message del {
        text-decoration: line-through !important;
        opacity: 0.7 !important;
    }
    
    .typing-indicator {
        display: flex;
        gap: 6px;
        padding: 16px 20px;
        background: white;
        border: 1px solid rgba(102, 126, 234, 0.1);
        border-radius: 20px;
        max-width: 90px;
        margin-right: auto;
        margin-left: 0;
        border-bottom-left-radius: 6px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    #typing-indicator {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    #typing-indicator .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--text-muted);
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.5;
        }
        30% {
            transform: translateY(-10px);
            opacity: 1;
        }
    }
    
    .chat-input-container {
        padding: 20px 28px !important;
        background: #ffffff !important;
        border-top: 2px solid #e9ecef !important;
        display: flex !important;
        gap: 12px !important;
        align-items: flex-end !important;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05) !important;
        flex-shrink: 0 !important;
    }
    
    .chat-input-wrapper {
        flex: 1 !important;
        position: relative !important;
    }
    
    .chat-input {
        width: 100% !important;
        padding: 18px 24px !important;
        border: 2px solid #e9ecef !important;
        border-radius: 16px !important;
        font-size: 16px !important;
        outline: none !important;
        transition: all 0.3s !important;
        direction: rtl !important;
        font-family: 'Vazir', 'Tahoma', sans-serif !important;
        resize: none !important;
        min-height: 60px !important;
        max-height: 200px !important;
        background: #f8f9fa !important;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }
    
    .chat-input:focus {
        border-color: var(--capital-color) !important;
        background: white !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), inset 0 2px 4px rgba(0, 0, 0, 0.05) !important;
        transform: translateY(-1px) !important;
    }
    
    .chat-input::placeholder {
        color: #adb5bd !important;
        font-size: 15px !important;
    }
    
    .send-button {
        padding: 18px 36px !important;
        background: linear-gradient(135deg, var(--capital-color) 0%, var(--secondary-color) 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 16px !important;
        cursor: pointer !important;
        font-size: 16px !important;
        font-weight: 600 !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
        white-space: nowrap !important;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
        position: relative !important;
        overflow: hidden !important;
        min-height: 60px !important;
    }
    
    .send-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }
    
    .send-button:hover:not(:disabled)::before {
        width: 300px;
        height: 300px;
    }
    
    .send-button:hover:not(:disabled) {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }
    
    .send-button:active:not(:disabled) {
        transform: translateY(-1px) scale(0.98);
    }
    
    .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef5350;
        padding: 12px 16px;
        border-radius: 8px;
        margin: 12px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.4;
    }
    
    .empty-state h3 {
        margin: 0 0 8px 0;
        color: var(--text-secondary);
        font-size: 18px;
    }
    
    .empty-state p {
        margin: 0;
        font-size: 14px;
    }
    
    .toast {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--text-primary) 0%, #2c3e50 100%);
        color: white;
        padding: 16px 28px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        align-items: center;
        gap: 12px;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .toast.success {
        background: linear-gradient(135deg, #21ba45 0%, #16a085 100%);
    }
    
    .toast.error {
        background: linear-gradient(135deg, #dc3545 0%, #c62828 100%);
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }
    
    /* Utility Classes */
    .d-none {
        display: none !important;
    }
    
    @media (min-width: 768px) {
        .d-md-inline {
            display: inline !important;
        }
    }
    
    @media (max-width: 768px) {
        .chat-container {
            margin: 10px;
            height: calc(100vh - 120px);
            border-radius: 12px;
        }
        
        .chat-header {
            padding: 14px 16px;
            flex-wrap: wrap;
        }
        
        .chat-header-text h2 {
            font-size: 18px;
        }
        
        .chat-header-text p {
            font-size: 12px;
        }
        
        .header-btn {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .message {
            max-width: 90% !important;
            padding: 14px 18px !important;
        }
        
        .chat-input-container {
            padding: 16px !important;
        }
        
        .chat-input {
            min-height: 50px !important;
            font-size: 15px !important;
            padding: 14px 18px !important;
        }
        
        .send-button {
            padding: 14px 24px !important;
            font-size: 14px !important;
            min-height: 50px !important;
        }
        
        .send-button-text {
            display: none !important;
        }
        
        .message-avatar {
            width: 36px !important;
            height: 36px !important;
            font-size: 16px !important;
        }
        
        /* Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        .assistant-message table {
            font-size: 12px !important;
            display: block !important;
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch !important;
        }
        
        .assistant-message table th,
        .assistant-message table td {
            padding: 8px 10px !important;
            font-size: 12px !important;
        }
        
        .assistant-message h1 {
            font-size: 20px !important;
        }
        
        .assistant-message h2 {
            font-size: 18px !important;
        }
        
        .assistant-message h3 {
            font-size: 16px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div class="chat-header-left">
            <div class="chat-header-icon">ğŸ¤–</div>
            <div class="chat-header-text">
                <h2>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯</h2>
                <p>Ø³ÙˆØ§Ù„Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯</p>
            </div>
        </div>
        <div class="chat-header-actions">
            <button class="header-btn" onclick="clearChat()" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡">
                <i class="fas fa-trash-alt"></i>
                <span class="d-none d-md-inline">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</span>
            </button>
        </div>
    </div>
    
    <div class="chat-messages" id="messages">
        <div class="message-wrapper">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message assistant-message">
                <div class="message-header">
                    <span><i class="fas fa-robot"></i> Ø¯Ø³ØªÛŒØ§Ø±</span>
                    <span class="message-time" id="welcome-time"></span>
                </div>
                <div class="message-content">
                    ğŸ‘‹ Ø³Ù„Ø§Ù…! Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø´Ù…Ø§ Ù‡Ø³ØªÙ…. 
                    Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ØŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡ Ú©Ù…Ú© Ú©Ù†Ù….
                    <br><br>
                    <strong>Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª:</strong><br>
                    â€¢ "ÛŒÚ© Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø§ Ø±Ù‚Ù… 1000000 Ùˆ Ø¯Ø± Ø¯ÙˆØ±Ù‡ 1 Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†"<br>
                    â€¢ "Ù„ÛŒØ³Øª Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡"<br>
                    â€¢ "Ø¢Ù…Ø§Ø± Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡"<br>
                    â€¢ "Ù‡Ø²ÛŒÙ†Ù‡ Ø´Ù…Ø§Ø±Ù‡ 5 Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡"
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <textarea 
                id="messageInput" 
                class="chat-input" 
                placeholder="Ø¯Ø³ØªÙˆØ± ÛŒØ§ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
                autocomplete="off"
                rows="1"
            ></textarea>
        </div>
        <button onclick="sendMessage()" id="sendButton" class="send-button">
            <span id="sendButtonText" class="send-button-text">Ø§Ø±Ø³Ø§Ù„</span>
            <i class="fas fa-paper-plane" id="sendButtonIcon"></i>
        </button>
    </div>
</div>

<div id="toast" class="toast" style="display: none;"></div>

<script id="assistant-config" type="application/json">
{
    "enabled": {% if assistant_enabled %}true{% else %}false{% endif %},
    "url": "{{ assistant_url|default:''|escapejs }}"
}
</script>

<script>
    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¯Ø³ØªÛŒØ§Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª
    const config = JSON.parse(document.getElementById('assistant-config').textContent);
    const ASSISTANT_ENABLED = config.enabled;
    const ASSISTANT_URL = config.url;
    
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const sendButtonText = document.getElementById('sendButtonText');
    const sendButtonIcon = document.getElementById('sendButtonIcon');
    const STORAGE_KEY = 'chat_history';
    
    // Ø§Ú¯Ø± Ø¯Ø³ØªÛŒØ§Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªØŒ UI Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†
    if (!ASSISTANT_ENABLED) {
        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
        if (messagesDiv) {
            messagesDiv.innerHTML = `
                <div class="message-wrapper">
                    <div class="message assistant-message">
                        <div class="message-header">
                            <i class="fas fa-robot"></i>
                            <span>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
                        </div>
                        <div class="message-content">
                            <div style="padding: 20px; text-align: center; color: #6c757d;">
                                <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 15px; color: #667eea;"></i>
                                <h3 style="margin-bottom: 10px;">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª</h3>
                                <p style="margin-bottom: 15px;">Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø³Ø§ÛŒØ± Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>
                                <p style="font-size: 0.9em; color: #8e9297;">
                                    Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒØ§Ø±ØŒ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ… ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† input Ùˆ button
        if (messageInput) {
            messageInput.disabled = true;
            messageInput.placeholder = 'Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';
        }
        if (sendButton) {
            sendButton.disabled = true;
        }
        
        // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ù‚ÛŒÙ‡ Ú©Ø¯
        console.warn('AI Assistant is not enabled');
    }
    
    // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
    let reprocessScheduled = false;
    let saveHistoryTimeout = null;
    let processedMessages = new Set(); // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø¬Ø¯Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    let markedCheckInterval = null;
    
    // ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
    document.addEventListener('DOMContentLoaded', function() {
        const welcomeTime = document.getElementById('welcome-time');
        if (welcomeTime) {
            welcomeTime.textContent = getCurrentTime();
        }
        
        // Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ø¨Ø¹Ø¯ Ø§Ø² Ù„ÙˆØ¯ Ø´Ø¯Ù† marked.js)
        loadChatHistory();
        autoResizeTextarea();
    });
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ
    function getCurrentTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }
    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª marked.js Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Markdown
    function initializeMarked() {
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,  // ØªØ¨Ø¯ÛŒÙ„ Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ <br>
                gfm: true,     // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² GitHub Flavored Markdown (Ø¬Ø¯Ø§ÙˆÙ„ØŒ Ùˆ ØºÛŒØ±Ù‡)
                headerIds: false,
                mangle: false,
                pedantic: false,
                sanitize: false,
                smartLists: true,
                smartypants: false
            });
            return true;
        }
        return false;
    }
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ù„ÙˆØ¯ Ø´Ø¯Ù† marked.js
    let markedReady = false;
    function checkMarkedReady() {
        if (typeof marked !== 'undefined') {
            markedReady = initializeMarked();
            return true;
        }
        return false;
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§ debounce
    function scheduleReprocess() {
        if (reprocessScheduled) return;
        reprocessScheduled = true;
        
        requestAnimationFrame(() => {
            reprocessExistingMessages();
            reprocessScheduled = false;
        });
    }
    
    // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ initialize Ú©Ø±Ø¯Ù† marked.js (Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡)
    if (!checkMarkedReady()) {
        // Ø§Ú¯Ø± marked.js Ù‡Ù†ÙˆØ² Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ØŒ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†
        let checkCount = 0;
        const maxChecks = 50; // Ø­Ø¯Ø§Ú©Ø«Ø± 5 Ø«Ø§Ù†ÛŒÙ‡ (50 * 100ms)
        
        markedCheckInterval = setInterval(() => {
            checkCount++;
            if (checkMarkedReady()) {
                clearInterval(markedCheckInterval);
                markedCheckInterval = null;
                // Ø¨Ø¹Ø¯ Ø§Ø² Ù„ÙˆØ¯ Ø´Ø¯Ù† marked.jsØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
                scheduleReprocess();
            } else if (checkCount >= maxChecks) {
                clearInterval(markedCheckInterval);
                markedCheckInterval = null;
                // Ø­ØªÛŒ Ø§Ú¯Ø± marked.js Ù„ÙˆØ¯ Ù†Ø´Ø¯ØŒ Ø³Ø¹ÛŒ Ú©Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
                scheduleReprocess();
            }
        }, 100);
    } else {
        // Ø§Ú¯Ø± marked.js Ø§Ø² Ø§Ø¨ØªØ¯Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø¨Ø¹Ø¯ Ø§Ø² Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø¬Ø¯Ø¯ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
        scheduleReprocess();
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø¬Ø¯Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± ØµÙØ­Ù‡
    function reprocessExistingMessages() {
        const messageWrappers = messagesDiv.querySelectorAll('.message-wrapper:not(.user-wrapper)');
        const fragment = document.createDocumentFragment();
        let processedCount = 0;
        const maxProcessPerFrame = 5; // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø­Ø¯Ø§Ú©Ø«Ø± 5 Ù¾ÛŒØ§Ù… Ø¯Ø± Ù‡Ø± ÙØ±ÛŒÙ…
        
        function processBatch(startIndex) {
            const endIndex = Math.min(startIndex + maxProcessPerFrame, messageWrappers.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const wrapper = messageWrappers[i];
                const contentElement = wrapper.querySelector('.message-content');
                if (!contentElement) continue;
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…
                const messageId = contentElement.getAttribute('data-message-id') || 
                                 `msg-${Date.now()}-${Math.random()}`;
                
                // Ø§Ú¯Ø± Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡ØŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
                if (processedMessages.has(messageId)) continue;
                
                // Ú¯Ø±ÙØªÙ† Ù…ØªÙ† Ø®Ø§Ù… Ø§Ø² data-raw-text Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯
                const rawText = contentElement.getAttribute('data-raw-text');
                const text = rawText || contentElement.textContent || '';
                
                if (!text.trim()) continue;
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù¾ÛŒØ§Ù… Ø´Ø§Ù…Ù„ Markdown Ø§Ø³Øª ÛŒØ§ Ù†Ù‡ (Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡)
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„Ù markdown: Ø¬Ø¯Ø§ÙˆÙ„ØŒ boldØŒ italicØŒ Ú©Ø¯ØŒ headersØŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ØŒ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ØŒ blockquote
                const hasTable = text.includes('|');
                const hasMarkdown = hasTable || 
                    text.includes('**') || text.includes('__') ||  // bold
                    text.includes('*') || text.includes('_') ||    // italic
                    text.includes('`') ||                          // code
                    text.includes('#') ||                           // headers
                    text.includes('[') || text.includes('](') ||   // links
                    text.includes('![') ||                         // images
                    text.includes('- ') || text.includes('* ') ||  // lists
                    text.includes('> ') ||                         // blockquote
                    text.includes('```');                          // code blocks
                
                // Ø§Ú¯Ø± Markdown Ø¯Ø§Ø±Ø¯ Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø´Ø¯Ù‡ØŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
                if (hasMarkdown) {
                    const existingTable = contentElement.querySelector('table');
                    
                    // ÙÙ‚Ø· Ø§Ú¯Ø± Ø¬Ø¯ÙˆÙ„ Ù†Ø¯Ø§Ø±Ø¯ ÛŒØ§ Ù…ØªÙ† Ø®Ø§Ù… ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ØŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
                    if (hasTable && !existingTable) {
                        try {
                            const formattedHtml = formatMessage(text);
                            if (formattedHtml && formattedHtml !== contentElement.innerHTML) {
                                contentElement.setAttribute('data-raw-text', text);
                                contentElement.setAttribute('data-message-id', messageId);
                                contentElement.innerHTML = formattedHtml;
                                processedMessages.add(messageId);
                                processedCount++;
                            }
                        } catch (error) {
                            console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø¬Ø¯Ø¯ Ù¾ÛŒØ§Ù…:', error);
                        }
                    } else if (!hasTable && !existingTable) {
                        // Ø¨Ø±Ø§ÛŒ Markdown ØºÛŒØ± Ø§Ø² Ø¬Ø¯ÙˆÙ„ØŒ ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
                        try {
                            const formattedHtml = formatMessage(text);
                            if (formattedHtml && formattedHtml !== contentElement.innerHTML) {
                                contentElement.setAttribute('data-raw-text', text);
                                contentElement.setAttribute('data-message-id', messageId);
                                contentElement.innerHTML = formattedHtml;
                                processedMessages.add(messageId);
                                processedCount++;
                            }
                        } catch (error) {
                            console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø¬Ø¯Ø¯ Ù¾ÛŒØ§Ù…:', error);
                        }
                    } else {
                        // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· ID Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                        contentElement.setAttribute('data-message-id', messageId);
                        processedMessages.add(messageId);
                    }
                } else {
                    // Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† MarkdownØŒ ÙÙ‚Ø· ID Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                    contentElement.setAttribute('data-message-id', messageId);
                    processedMessages.add(messageId);
                }
            }
            
            // Ø§Ú¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø¯Ø± ÙØ±ÛŒÙ… Ø¨Ø¹Ø¯ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡
            if (endIndex < messageWrappers.length) {
                requestAnimationFrame(() => processBatch(endIndex));
            }
        }
        
        // Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ
        if (messageWrappers.length > 0) {
            processBatch(0);
        }
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¬Ø¯Ø§ÙˆÙ„ Markdown (fallback)
    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù‡Ù… Ù…ØªÙ† Ø®Ø§Ù… Ùˆ Ù‡Ù… HTML Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†Ø¯
    function parseMarkdownTable(text) {
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
        if (!text || typeof text !== 'string') {
            return '';
        }
        
        try {
            // Ø§Ú¯Ø± Ù…ØªÙ† Ø´Ø§Ù…Ù„ ØªÚ¯â€ŒÙ‡Ø§ÛŒ HTML Ø§Ø³ØªØŒ Ø§Ø¨ØªØ¯Ø§ Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø¨Ø§ placeholder Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            const htmlPlaceholders = [];
            let htmlIndex = 0;
            let processedText;
            try {
                processedText = text.replace(/<[^>]+>/g, (tag) => {
                    const placeholder = `__HTML_PLACEHOLDER_${htmlIndex}__`;
                    htmlPlaceholders[htmlIndex] = tag;
                    htmlIndex++;
                    return placeholder;
                });
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ HTML tags:', e);
                processedText = text;
            }
        // Ø§Ù„Ú¯ÙˆÛŒ Ø¬Ø¯ÙˆÙ„ Markdown: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø§ Ø§Ù„Ú¯ÙˆÛŒ | col1 | col2 |
        // Ø§ÛŒÙ† regex Ø¬Ø¯Ø§ÙˆÙ„ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø´Ø§Ù…Ù„ Ø®Ø· Ù‡Ø¯Ø±ØŒ Ø®Ø· separator Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø®Ø· Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª
        // Ù‡Ù…Ú†Ù†ÛŒÙ† Ø¬Ø¯Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø·ÛŒ Ø±Ø§ Ù‡Ù… Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        
            // Ø§Ø¨ØªØ¯Ø§ Ø¬Ø¯Ø§ÙˆÙ„ Ú†Ù†Ø¯ Ø®Ø·ÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            // Ø§Ù„Ú¯ÙˆÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø§ Ø®Ø· Ù‡Ø¯Ø±ï¼Œ separator Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø®Ø· Ø¯Ø§Ø¯Ù‡
            let tableRegex;
            let matches;
            try {
                tableRegex = /(\|[^\n]+\|\s*\n\|[\s\-:]+\|\s*\n(?:\|[^\n]+\|\s*\n?)+)/g;
                matches = processedText.match(tableRegex);
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± regex Ø¬Ø¯Ø§ÙˆÙ„ Ú†Ù†Ø¯ Ø®Ø·ÛŒ:', e);
                matches = null;
            }
            
            if (matches) {
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¬Ø¯Ø§ÙˆÙ„ Ú†Ù†Ø¯ Ø®Ø·ÛŒ
                matches.forEach(match => {
                    try {
                const lines = match.trim().split(/\r?\n/).map(line => line.trim()).filter(line => line && line.startsWith('|'));
                if (lines.length < 2) return;
                
                // Ø®Ø· Ø§ÙˆÙ„: Ù‡Ø¯Ø±
                const headers = lines[0].split('|').map(h => h.trim()).filter(h => h);
                // Ø®Ø· Ø¯ÙˆÙ…: separator (Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                // Ø®Ø·ÙˆØ· Ø¨Ø¹Ø¯ÛŒ: Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                const rows = lines.slice(2).map(line => {
                    return line.split('|').map(cell => cell.trim()).filter((cell, index) => index > 0 && index < line.split('|').length - 1);
                }).filter(row => row.length > 0);
                
                if (headers.length === 0 || rows.length === 0) return;
                
                let tableHtml = '<table><thead><tr>';
                headers.forEach(header => {
                    tableHtml += `<th>${escapeHtml(header)}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';
                
                rows.forEach(row => {
                    tableHtml += '<tr>';
                    headers.forEach((_, index) => {
                        const cell = row[index] || '';
                        tableHtml += `<td>${escapeHtml(cell)}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                
                        tableHtml += '</tbody></table>';
                        processedText = processedText.replace(match, tableHtml);
                    } catch (e) {
                        console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÛŒÚ© Ø¬Ø¯ÙˆÙ„ Ú†Ù†Ø¯ Ø®Ø·ÛŒ:', e);
                        // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ Ø¨Ø§ Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    }
                });
            }
            
            // Ø§Ú¯Ø± Ø¬Ø¯ÙˆÙ„ Ú†Ù†Ø¯ Ø®Ø·ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø¬Ø¯Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø·ÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        // Ø§Ù„Ú¯ÙˆÛŒ Ø¬Ø¯ÙˆÙ„ ÛŒÚ© Ø®Ø·ÛŒ: | header1 | header2 | |---|---| | data1 | data2 |
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ù„Ú¯ÙˆÛŒ: |...|...|...||---|...|...|...|
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² || Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø³Ø·Ø±Ù‡Ø§
        
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø´Ø§Ù…Ù„ | Ùˆ --- Ù‡Ø³ØªÙ†Ø¯ Ùˆ Ø´Ø§Ù…Ù„ || Ù‡Ø³ØªÙ†Ø¯ (Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø³Ø·Ø±Ù‡Ø§)
            // Ø§Ù„Ú¯ÙˆÛŒ: |...|...|...||---|...|...|...| Ú©Ù‡ Ø´Ø§Ù…Ù„ || Ø§Ø³Øª
            let singleLineMatches;
            try {
                const singleLineTablePattern = /(\|[^|]+\|(?:\s*\|\s*[^|]+\|)+\s*\|\s*[\s\-:]+\s*\|(?:\s*\|\s*[^|]+\|)+)/g;
                singleLineMatches = processedText.match(singleLineTablePattern);
                
                // Ø§Ú¯Ø± regex Ø¨Ø§Ù„Ø§ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ø§Ø² Ø±ÙˆØ´ Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ù„Ú¯ÙˆÛŒ: |...|...|...||---|...|...|...| Ú©Ù‡ Ø´Ø§Ù…Ù„ || Ø§Ø³Øª
                if (!singleLineMatches) {
                    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø´Ø§Ù…Ù„ | Ùˆ --- Ù‡Ø³ØªÙ†Ø¯ Ùˆ Ø´Ø§Ù…Ù„ || Ù‡Ø³ØªÙ†Ø¯
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÛŒÚ© regex Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ú©Ù‡ ØªÙ…Ø§Ù… Ø¬Ø¯Ø§ÙˆÙ„ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                    const simpleTablePattern = /(\|[^|]+\|(?:\s*\|\s*[^|]+\|)+\s*\|\s*[\s\-:]+\s*\|(?:\s*\|\s*[^|]+\|)+)/g;
                    singleLineMatches = processedText.match(simpleTablePattern);
                }
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± regex Ø¬Ø¯Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø·ÛŒ:', e);
                singleLineMatches = null;
            }
            
            if (singleLineMatches) {
                singleLineMatches.forEach(match => {
                    try {
                // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø·Ø±Ù‡Ø§ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² || Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡
                // Ø§Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ø§Ø´ÛŒÙ… Ú©Ù‡ || Ø¯Ø§Ø®Ù„ Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ Ù†Ø¨Ø§Ø´Ø¯
                // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒØŒ Ø§Ø² split Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                // Ø§Ø¨ØªØ¯Ø§ || Ø±Ø§ Ø¨Ù‡ ÛŒÚ© Ú©Ø§Ø±Ø§Ú©ØªØ± Ø®Ø§Øµ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                const normalizedMatch = match.replace(/\|\s*\|/g, '||ROW_SEPARATOR||');
                const rows = normalizedMatch.split('||ROW_SEPARATOR||').map(r => r.trim()).filter(r => r);
                
                if (rows.length < 2) return;
                
                // Ø®Ø· Ø§ÙˆÙ„: Ù‡Ø¯Ø±
                const headerRow = rows[0];
                const headers = headerRow.split('|').map(h => h.trim()).filter(h => h);
                
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† separator (Ø³Ø·Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ ÙÙ‚Ø· Ø´Ø§Ù…Ù„ - ÛŒØ§ : Ù‡Ø³ØªÙ†Ø¯)
                const separatorIndex = rows.findIndex(row => {
                    const cleaned = row.replace(/\|/g, '').trim();
                    return /^[\s\-:]+$/.test(cleaned);
                });
                
                if (separatorIndex < 0) return;
                
                // Ø®Ø·ÙˆØ· Ø¯Ø§Ø¯Ù‡ (Ø¨Ø¹Ø¯ Ø§Ø² separator)
                const dataRows = rows.slice(separatorIndex + 1).map(row => {
                    return row.split('|').map(cell => cell.trim()).filter(cell => cell);
                }).filter(row => row.length > 0);
                
                if (headers.length === 0 || dataRows.length === 0) return;
                
                let tableHtml = '<table><thead><tr>';
                headers.forEach(header => {
                    tableHtml += `<th>${escapeHtml(header)}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';
                
                dataRows.forEach(row => {
                    tableHtml += '<tr>';
                    headers.forEach((_, index) => {
                        const cell = row[index] || '';
                        tableHtml += `<td>${escapeHtml(cell)}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                
                        tableHtml += '</tbody></table>';
                        processedText = processedText.replace(match, tableHtml);
                    } catch (e) {
                        console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÛŒÚ© Ø¬Ø¯ÙˆÙ„ ÛŒÚ© Ø®Ø·ÛŒ:', e);
                        // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ Ø¨Ø§ Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    }
                });
            }
        
            // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ placeholderÙ‡Ø§ Ø¨Ø§ ØªÚ¯â€ŒÙ‡Ø§ÛŒ HTML
            try {
                htmlPlaceholders.forEach((tag, index) => {
                    const placeholder = `__HTML_PLACEHOLDER_${index}__`;
                    processedText = processedText.replace(placeholder, tag);
                });
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ HTML placeholders:', e);
            }
            
            return processedText;
        } catch (error) {
            // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒØŒ Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø±Ø§ escape Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ…
            console.error('Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ Ø¯Ø± parseMarkdownTable:', error);
            return escapeHtml(text);
        }
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Markdown
    function formatMessage(text) {
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
        if (!text || typeof text !== 'string') {
            return '';
        }
        
        try {
            // Ø§Ø¨ØªØ¯Ø§ Ø¬Ø¯Ø§ÙˆÙ„ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ù‚Ø¨Ù„ Ø§Ø² marked.js)
            // Ú†ÙˆÙ† marked.js Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¬Ø¯Ø§ÙˆÙ„ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ú©Ù†Ø¯
            const tablePlaceholders = [];
            let tableIndex = 0;
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¬Ø¯Ø§ÙˆÙ„ Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¨Ø§ placeholder
            // Ø§Ù„Ú¯ÙˆÛŒ Ø¬Ø¯Ø§ÙˆÙ„ Ú†Ù†Ø¯ Ø®Ø·ÛŒ - Ø¨Ø§ try-catch Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§
            let processedText = text;
            try {
                processedText = text.replace(/(\|[^\n]+\|\s*\n\|[\s\-:]+\|\s*\n(?:\|[^\n]+\|\s*\n?)+)/g, (match) => {
                    const placeholder = `__TABLE_PLACEHOLDER_${tableIndex}__`;
                    tablePlaceholders[tableIndex] = match;
                    tableIndex++;
                    return placeholder;
                });
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¬Ø¯Ø§ÙˆÙ„ Ú†Ù†Ø¯ Ø®Ø·ÛŒ:', e);
                processedText = text;
            }
            
            // Ø§Ù„Ú¯ÙˆÛŒ Ø¬Ø¯Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø·ÛŒ (Ø¨Ø§ ||) - Ø¨Ø§ try-catch
            try {
                processedText = processedText.replace(/(\|[^|]+\|(?:\s*\|\s*[^|]+\|)+\s*\|\s*[\s\-:]+\s*\|(?:\s*\|\s*[^|]+\|)+)/g, (match) => {
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† match Ù‚Ø¨Ù„Ø§Ù‹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡ Ø§Ø³Øª ÛŒØ§ Ù†Ù‡
                    if (!match.includes('__TABLE_PLACEHOLDER_')) {
                        const placeholder = `__TABLE_PLACEHOLDER_${tableIndex}__`;
                        tablePlaceholders[tableIndex] = match;
                        tableIndex++;
                        return placeholder;
                    }
                    return match;
                });
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¬Ø¯Ø§ÙˆÙ„ ÛŒÚ© Ø®Ø·ÛŒ:', e);
            }
            
            // Ø§Ú¯Ø± marked.js Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªØŒ Ø§Ø² Ø¢Ù† Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³Ø§ÛŒØ± Ø¹Ù†Ø§ØµØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (typeof marked !== 'undefined' && markedReady) {
                try {
                    // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ marked.js (Ø¨Ø§ breaks: true Ú©Ù‡ Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù‡ <br> ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
                    let html = marked.parse(processedText);
                    
                    // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ placeholderÙ‡Ø§ Ø¨Ø§ Ø¬Ø¯Ø§ÙˆÙ„ HTML - Ø¨Ø§ error handling
                    tablePlaceholders.forEach((tableText, index) => {
                        try {
                            const placeholder = `__TABLE_PLACEHOLDER_${index}__`;
                            const tableHtml = parseMarkdownTable(tableText);
                            html = html.replace(placeholder, tableHtml);
                        } catch (e) {
                            console.warn(`Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¬Ø¯ÙˆÙ„ ${index}:`, e);
                            // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ placeholder Ø±Ø§ Ø¨Ø§ Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                            const placeholder = `__TABLE_PLACEHOLDER_${index}__`;
                            html = html.replace(placeholder, escapeHtml(tableText));
                        }
                    });
                    
                    return html;
                } catch (error) {
                    console.error('Error parsing markdown with marked.js:', error);
                    // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø¨Ù‡ Ø±ÙˆØ´ fallback Ø¨Ø±Ú¯Ø±Ø¯
                }
            }
        
            // Fallback: Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¬Ø¯Ø§ÙˆÙ„ Ùˆ Ø³Ø§ÛŒØ± Ø¹Ù†Ø§ØµØ±
            // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ placeholderÙ‡Ø§ Ø¨Ø§ Ø¬Ø¯Ø§ÙˆÙ„ HTML - Ø¨Ø§ error handling
            tablePlaceholders.forEach((tableText, index) => {
                try {
                    const placeholder = `__TABLE_PLACEHOLDER_${index}__`;
                    const tableHtml = parseMarkdownTable(tableText);
                    processedText = processedText.replace(placeholder, tableHtml);
                } catch (e) {
                    console.warn(`Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¬Ø¯ÙˆÙ„ ${index} (fallback):`, e);
                    // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ placeholder Ø±Ø§ Ø¨Ø§ Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    const placeholder = `__TABLE_PLACEHOLDER_${index}__`;
                    processedText = processedText.replace(placeholder, escapeHtml(tableText));
                }
            });
            
            // Fallback: Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³Ø§Ø¯Ù‡ Markdown (Ø±ÙˆØ´ Ù‚Ø¯ÛŒÙ…ÛŒ)
            try {
                // ØªØ¨Ø¯ÛŒÙ„ Ú©Ø¯Ù‡Ø§ÛŒ Ø¨Ù„ÙˆÚ©ÛŒ (Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± Ú†ÛŒØ² Ø¯ÛŒÚ¯Ø±ÛŒ)
                processedText = processedText.replace(/```(\w+)?\n?([\s\S]*?)```/g, function(match, lang, code) {
                    try {
                        return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
                    } catch (e) {
                        return escapeHtml(match);
                    }
                });
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ø¯Ù‡Ø§ÛŒ Ø¨Ù„ÙˆÚ©ÛŒ:', e);
            }
            
            try {
                // ØªØ¨Ø¯ÛŒÙ„ Ú©Ø¯Ù‡Ø§ÛŒ inline (Ø¨Ø¹Ø¯ Ø§Ø² Ú©Ø¯Ù‡Ø§ÛŒ Ø¨Ù„ÙˆÚ©ÛŒ)
                processedText = processedText.replace(/`([^`\n]+)`/g, function(match, code) {
                    try {
                        return `<code>${escapeHtml(code)}</code>`;
                    } catch (e) {
                        return escapeHtml(match);
                    }
                });
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ø¯Ù‡Ø§ÛŒ inline:', e);
            }
            
            // ØªØ¨Ø¯ÛŒÙ„ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ (Ù‚Ø¨Ù„ Ø§Ø² ØªØ¨Ø¯ÛŒÙ„ Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯) - Ø¨Ø§ error handling
            try {
                const lines = processedText.split('\n');
                let inList = false;
                let formattedLines = [];
                
                lines.forEach((line, index) => {
                    try {
                        const listMatch = line.match(/^[\s]*[-â€¢]\s+(.+)$/);
                        if (listMatch) {
                            if (!inList) {
                                formattedLines.push('<ul>');
                                inList = true;
                            }
                            formattedLines.push(`<li>${escapeHtml(listMatch[1])}</li>`);
                        } else {
                            if (inList) {
                                formattedLines.push('</ul>');
                                inList = false;
                            }
                            if (line.trim() || index < lines.length - 1) {
                                formattedLines.push(escapeHtml(line));
                            }
                        }
                    } catch (e) {
                        // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÛŒÚ© Ø®Ø·ØŒ Ø¢Ù† Ø±Ø§ escape Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                        formattedLines.push(escapeHtml(line));
                    }
                });
                
                if (inList) {
                    formattedLines.push('</ul>');
                }
                
                processedText = formattedLines.join('\n');
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§:', e);
                // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ù…ØªÙ† Ø±Ø§ escape Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                processedText = escapeHtml(processedText);
            }
            
            try {
                // ØªØ¨Ø¯ÛŒÙ„ Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯
                processedText = processedText.replace(/\n/g, '<br>');
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯:', e);
            }
            
            try {
                // ØªØ¨Ø¯ÛŒÙ„ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§
                processedText = processedText.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
            } catch (e) {
                console.warn('Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§:', e);
            }
            
            return processedText;
        } catch (error) {
            // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒØŒ Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø±Ø§ escape Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ…
            console.error('Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ Ø¯Ø± formatMessage:', error);
            return escapeHtml(text);
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function addMessage(text, isUser) {
        try {
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ text Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
            if (text === null || text === undefined) {
                text = '';
            }
            text = String(text);
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${isUser ? 'user-wrapper' : ''}`;
            
            // Ø¢ÙˆØ§ØªØ§Ø±
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
            
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            
            const senderName = document.createElement('span');
            senderName.innerHTML = isUser ? '<i class="fas fa-user"></i> Ø´Ù…Ø§' : '<i class="fas fa-robot"></i> Ø¯Ø³ØªÛŒØ§Ø±';
            
            const messageTime = document.createElement('span');
            messageTime.className = 'message-time';
            messageTime.textContent = getCurrentTime();
            
            messageHeader.appendChild(senderName);
            messageHeader.appendChild(messageTime);
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù…ØªÙ† Ø®Ø§Ù… Ø¯Ø± data attribute Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± saveChatHistory
            messageContent.setAttribute('data-raw-text', text);
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…
            const messageId = `msg-${Date.now()}-${Math.random()}`;
            messageContent.setAttribute('data-message-id', messageId);
            
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² try-catch Ø¨Ø±Ø§ÛŒ formatMessage
            try {
                if (isUser) {
                    messageContent.innerHTML = escapeHtml(text);
                } else {
                    // Ù¾Ø±Ø¯Ø§Ø²Ø´ Markdown Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² requestAnimationFrame Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯
                    if (text.length > 1000) {
                        messageContent.innerHTML = '<div style="opacity: 0.5;">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</div>';
                        requestAnimationFrame(() => {
                            try {
                                const formattedHtml = formatMessage(text);
                                messageContent.innerHTML = formattedHtml;
                                processedMessages.add(messageId);
                            } catch (error) {
                                console.error('Ø®Ø·Ø§ Ø¯Ø± format Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…:', error);
                                messageContent.innerHTML = escapeHtml(text);
                            }
                        });
                    } else {
                        messageContent.innerHTML = formatMessage(text);
                        processedMessages.add(messageId);
                    }
                }
            } catch (formatError) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± format Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…:', formatError);
                // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø§Ø² escapeHtml Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                messageContent.innerHTML = escapeHtml(text);
            }
            
            if (!isUser) {
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.title = 'Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†';
                copyBtn.onclick = () => copyToClipboard(text);
                
                messageActions.appendChild(copyBtn);
                messageHeader.appendChild(messageActions);
            }
            
            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(messageContent);
            messageWrapper.appendChild(avatar);
            messageWrapper.appendChild(messageDiv);
            messagesDiv.appendChild(messageWrapper);
            
            scrollToBottom();
            
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² try-catch Ø¨Ø±Ø§ÛŒ saveChatHistory
            try {
                saveChatHistory();
            } catch (saveError) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡:', saveError);
                // Ø®Ø·Ø§ Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ú†ÙˆÙ† Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª
            }
        } catch (error) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± addMessage:', error);
            // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            const errorWrapper = document.createElement('div');
            errorWrapper.className = 'message-wrapper';
            errorWrapper.innerHTML = `<div class="message assistant-message"><div class="message-content">Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…: ${escapeHtml(String(text))}</div></div>`;
            messagesDiv.appendChild(errorWrapper);
            scrollToBottom();
        }
    }
    
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message-wrapper';
        typingDiv.id = 'typing-indicator';
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';
        
        const typingContent = document.createElement('div');
        typingContent.className = 'typing-indicator';
        
        for (let i = 0; i < 3; i++) {
            const dot = document.createElement('div');
            dot.className = 'typing-dot';
            typingContent.appendChild(dot);
        }
        
        typingDiv.appendChild(avatar);
        typingDiv.appendChild(typingContent);
        messagesDiv.appendChild(typingDiv);
        scrollToBottom();
    }
    
    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    function setLoading(loading) {
        if (loading) {
            sendButton.disabled = true;
            sendButtonText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
            sendButtonIcon.className = 'fas fa-spinner fa-spin';
            showTypingIndicator();
        } else {
            sendButton.disabled = false;
            sendButtonText.textContent = 'Ø§Ø±Ø³Ø§Ù„';
            sendButtonIcon.className = 'fas fa-paper-plane';
            hideTypingIndicator();
        }
    }
    
    async function sendMessage() {
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¯Ø³ØªÛŒØ§Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª
        if (!ASSISTANT_ENABLED) {
            showToast('Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª', 'error');
            return;
        }
        
        const message = messageInput.value.trim();
        
        if (!message) return;
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
        addMessage(message, true);
        messageInput.value = '';
        autoResizeTextarea();
        setLoading(true);
        
        try {
            // Ø§ÛŒØ¬Ø§Ø¯ AbortController Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 200000); // 200 Ø«Ø§Ù†ÛŒÙ‡ (3.3 Ø¯Ù‚ÛŒÙ‚Ù‡)
            
            const response = await fetch('{% url "assistant:chat_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include',
                signal: controller.signal, // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† signal Ø¨Ø±Ø§ÛŒ timeout
                body: JSON.stringify({ 
                    message: message,
                    use_rag: false
                })
            });
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† timeout Ø¨Ø¹Ø¯ Ø§Ø² Ø¯Ø±ÛŒØ§ÙØª response
            clearTimeout(timeoutId);
            
            // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª HTTP response Ù‚Ø¨Ù„ Ø§Ø² Ø®ÙˆØ§Ù†Ø¯Ù† body
            // Ø§Ú¯Ø± status Ø®Ø·Ø§ Ø§Ø³Øª (Ù…Ø«Ù„ 504, 500, 503 Ùˆ ØºÛŒØ±Ù‡)ØŒ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø®Ø·Ø§ Ø±Ø§ throw Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (!response.ok) {
                // Ø®ÙˆØ§Ù†Ø¯Ù† response body Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
                let errorText = '';
                try {
                    errorText = await response.text();
                } catch (e) {
                    // Ø§Ú¯Ø± Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ù…ØªÙ† Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†ÛŒÙ…ØŒ Ø§Ø² status code Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    errorText = '';
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ response HTML Ø§Ø³Øª (Ù…Ø«Ù„Ø§Ù‹ ØµÙØ­Ù‡ Ø®Ø·Ø§ Django ÛŒØ§ Gateway Timeout)
                if (errorText.trim().startsWith('<!DOCTYPE') || errorText.trim().startsWith('<html')) {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø§Ø² HTML
                    const errorMatch = errorText.match(/<title>(.*?)<\/title>/i) || 
                                     errorText.match(/<h1>(.*?)<\/h1>/i) ||
                                     errorText.match(/<p[^>]*>(.*?)<\/p>/i);
                    const htmlError = errorMatch ? errorMatch[1] : `Ø®Ø·Ø§ÛŒ HTTP ${response.status}`;
                    
                    // Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø± Ø§Ø³Ø§Ø³ status code
                    if (response.status === 504) {
                        throw new Error(`â±ï¸ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ (Gateway Timeout). Ø³Ø±ÙˆØ± Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.`);
                    } else if (response.status === 503) {
                        throw new Error(`âš ï¸ Ø³Ø±ÙˆÛŒØ³ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.`);
                    } else {
                        throw new Error(`Ø®Ø·Ø§ÛŒ HTTP ${response.status}: ${htmlError}`);
                    }
                }
                
                // Ø§Ú¯Ø± response Ø®Ø§Ù„ÛŒ Ø§Ø³Øª
                if (!errorText || errorText.trim() === '') {
                    if (response.status === 504) {
                        throw new Error(`â±ï¸ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ (Gateway Timeout). Ø³Ø±ÙˆØ± Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø§Ø³Øª.`);
                    } else {
                        throw new Error(`Ø®Ø·Ø§ÛŒ HTTP ${response.status}: ${response.statusText || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'}`);
                    }
                }
                
                // Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… JSON parse Ú©Ù†ÛŒÙ… (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø®Ø·Ø§ Ø¨Ù‡ ØµÙˆØ±Øª JSON Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
                try {
                    const errorData = JSON.parse(errorText);
                    const errorMessage = errorData.error || errorData.message || `Ø®Ø·Ø§ÛŒ HTTP ${response.status}`;
                    throw new Error(errorMessage);
                } catch (e) {
                    // Ø§Ú¯Ø± JSON Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² Ù…ØªÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    throw new Error(`Ø®Ø·Ø§ÛŒ HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }
            }
            
            // Ø§Ú¯Ø± status OK Ø§Ø³ØªØŒ response body Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
            // Ø®ÙˆØ§Ù†Ø¯Ù† response body ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ "body stream already read")
            let responseText;
            try {
                responseText = await response.text();
            } catch (e) {
                throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±: ${e.message}`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Content-Type header
            const contentType = response.headers.get('content-type') || '';
            const isJson = contentType.includes('application/json');
            
            // Parse Ú©Ø±Ø¯Ù† JSON Ø§Ø² Ù…ØªÙ†
            let data;
            try {
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ responseText Ø®Ø§Ù„ÛŒ Ù†Ø¨Ø§Ø´Ø¯
                if (!responseText || responseText.trim() === '') {
                    data = { success: false, error: 'Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ø®Ø§Ù„ÛŒ Ø§Ø³Øª' };
                } else {
                    // Ø§Ú¯Ø± Content-Type JSON Ù†ÛŒØ³Øª Ø§Ù…Ø§ Ù…ØªÙ† Ø¨Ø§ { ÛŒØ§ [ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… parse Ú©Ù†ÛŒÙ…
                    if (!isJson && (responseText.trim().startsWith('{') || responseText.trim().startsWith('['))) {
                        console.warn('âš ï¸ Content-Type JSON Ù†ÛŒØ³Øª Ø§Ù…Ø§ Ù…ØªÙ† Ø´Ø¨ÛŒÙ‡ JSON Ø§Ø³Øª. ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ parse...');
                    }
                    
                    data = JSON.parse(responseText);
                }
            } catch (e) {
                // Ø§Ú¯Ø± JSON parse Ù†Ø´Ø¯
                console.error('Ø®Ø·Ø§ Ø¯Ø± parse Ú©Ø±Ø¯Ù† JSON:', {
                    error: e.message,
                    responseText: responseText.substring(0, 500),
                    status: response.status,
                    statusText: response.statusText,
                    contentType: contentType,
                    isJson: isJson
                });
                
                throw new Error(`Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª - ÙØ±Ù…Øª JSON Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ø®Ø·Ø§: ${e.message}`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± response (Ø§Ú¯Ø± Ø¨Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ø³ÛŒØ¯ÛŒÙ…ØŒ response.ok Ø§Ø³Øª)
            if (data && typeof data === 'object') {
                if (data.success) {
                    const output = data.output || 'Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.';
                    console.log('âœ… Ù¾Ø§Ø³Ø® Ù…ÙˆÙÙ‚ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:', output.substring(0, 100) + '...');
                    addMessage(output, false);
                    // Ø¨Ø¹Ø¯ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ØŒ return Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ catch block Ø§Ø¬Ø±Ø§ Ù†Ø´ÙˆØ¯
                    return;
                } else {
                    const errorMessage = data.error || data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ';
                    console.error('âŒ Ø®Ø·Ø§ Ø§Ø² Ø³Ø±ÙˆØ±:', errorMessage);
                    addMessage(`âŒ Ø®Ø·Ø§: ${errorMessage}`, false);
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø®', 'error');
                    return;
                }
            } else {
                // Ø§Ú¯Ø± response Ø³Ø§Ø®ØªØ§Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø±ÛŒ Ø¯Ø§Ø±Ø¯
                console.error('âŒ Ø³Ø§Ø®ØªØ§Ø± response Ù†Ø§Ù…Ø¹ØªØ¨Ø±:', data);
                addMessage('âŒ Ø®Ø·Ø§: Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', false);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø®', 'error');
                return;
            }
        } catch (error) {
            // ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ parseØŒ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
            console.error('Error:', error);
            const errorMessage = error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† ÛŒÚ© Ø®Ø·Ø§ÛŒ timeout Ø§Ø³Øª
            if (error.name === 'AbortError' || errorMessage.includes('aborted') || errorMessage.includes('timeout') || errorMessage.includes('Gateway Timeout')) {
                addMessage('â±ï¸ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯. Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Øª Ùˆ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ø¯ÛŒÚ¯Ø± Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.', false);
                showToast('Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ - Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´', 'warning');
            } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                addMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', false);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
            } else {
                // Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ØŒ Ù¾ÛŒØ§Ù… Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                // Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø§Ø² Ù‚Ø¨Ù„ Ø´Ø§Ù…Ù„ emoji ÛŒØ§ ÙØ±Ù…Øª Ø®Ø§Øµ Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
                addMessage(errorMessage.startsWith('â±ï¸') || errorMessage.startsWith('âš ï¸') || errorMessage.startsWith('âŒ') 
                    ? errorMessage 
                    : `âŒ Ø®Ø·Ø§: ${errorMessage}`, false);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª', 'error');
            }
        } finally {
            setLoading(false);
        }
    }
    
    async function clearChat() {
        if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† intervalÙ‡Ø§ Ùˆ timeoutÙ‡Ø§
            if (markedCheckInterval) {
                clearInterval(markedCheckInterval);
                markedCheckInterval = null;
            }
            if (saveHistoryTimeout) {
                clearTimeout(saveHistoryTimeout);
                saveHistoryTimeout = null;
            }
            if (scrollTimeout) {
                cancelAnimationFrame(scrollTimeout);
                scrollTimeout = null;
            }
            if (resizeTimeout) {
                cancelAnimationFrame(resizeTimeout);
                resizeTimeout = null;
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† cache Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡
            processedMessages.clear();
            reprocessScheduled = false;
            
            // Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
            const welcomeMessage = messagesDiv.querySelector('.message-wrapper:first-child');
            messagesDiv.innerHTML = '';
            if (welcomeMessage) {
                messagesDiv.appendChild(welcomeMessage);
            }
            localStorage.removeItem(STORAGE_KEY);
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø² session Ø¯Ø± backend
            try {
                const response = await fetch('{% url "assistant:clear_chat_history" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª Ù¾Ø§Ú© Ø´Ø¯', 'success');
                } else {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡', 'error');
                }
            } catch (error) {
                console.error('Error clearing chat history:', error);
                showToast('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ù„ÛŒ Ù¾Ø§Ú© Ø´Ø¯', 'success');
            }
        }
    }
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
        }).catch(() => {
            // Fallback Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
        });
    }
    
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fas fa-${icon}"></i> <span>${message}</span>`;
        toast.style.display = 'flex';
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(-50%) translateY(20px)';
            setTimeout(() => {
                toast.style.display = 'none';
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            }, 300);
        }, 3000);
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„
    let scrollTimeout = null;
    function scrollToBottom() {
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² requestAnimationFrame Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù†Ø±Ù…
        if (scrollTimeout) {
            cancelAnimationFrame(scrollTimeout);
        }
        scrollTimeout = requestAnimationFrame(() => {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            scrollTimeout = null;
        });
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ debounce
    function saveChatHistory() {
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† timeout Ù‚Ø¨Ù„ÛŒ
        if (saveHistoryTimeout) {
            clearTimeout(saveHistoryTimeout);
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø§ ØªØ§Ø®ÛŒØ± 500ms (debounce)
        saveHistoryTimeout = setTimeout(() => {
            try {
                const messages = Array.from(messagesDiv.querySelectorAll('.message-wrapper')).slice(1).map(wrapper => {
                    const message = wrapper.querySelector('.message');
                    const contentElement = wrapper.querySelector('.message-content');
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ element Ù‡Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯
                    if (!message || !contentElement) {
                        return null; // Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
                    }
                    
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² data-raw-text Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯ (Ù…ØªÙ† Ø®Ø§Ù…)ØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø§Ø² textContent
                    const rawText = contentElement.getAttribute('data-raw-text');
                    const content = rawText || contentElement.textContent || '';
                    const isUser = message.classList.contains('user-message');
                    return { text: content, isUser };
                }).filter(msg => msg !== null); // Ø­Ø°Ù Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ null
                
                // ÙÙ‚Ø· Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
                const currentHistory = localStorage.getItem(STORAGE_KEY);
                const currentMessages = currentHistory ? JSON.parse(currentHistory) : [];
                
                // Ù…Ù‚Ø§ÛŒØ³Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ ØºÛŒØ±Ø¶Ø±ÙˆØ±ÛŒ
                if (messages.length !== currentMessages.length || 
                    JSON.stringify(messages) !== JSON.stringify(currentMessages)) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡:', error);
                // Ø®Ø·Ø§ Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ú†ÙˆÙ† Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª
            }
            saveHistoryTimeout = null;
        }, 500);
    }
    
    function loadChatHistory() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const messages = JSON.parse(saved);
                
                // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ
                const loadMessages = () => {
                    let index = 0;
                    const batchSize = 3; // Ù„ÙˆØ¯ 3 Ù¾ÛŒØ§Ù… Ø¯Ø± Ù‡Ø± ÙØ±ÛŒÙ…
                    
                    function loadBatch() {
                        const endIndex = Math.min(index + batchSize, messages.length);
                        
                        for (let i = index; i < endIndex; i++) {
                            addMessage(messages[i].text, messages[i].isUser);
                        }
                        
                        index = endIndex;
                        
                        if (index < messages.length) {
                            requestAnimationFrame(loadBatch);
                        } else {
                            // Ø¨Ø¹Ø¯ Ø§Ø² Ù„ÙˆØ¯ Ø´Ø¯Ù† ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ØŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø¬Ø¯Ø¯ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
                            scheduleReprocess();
                        }
                    }
                    
                    loadBatch();
                };
                
                // Ø§Ú¯Ø± marked.js Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ù„ÙˆØ¯ Ú©Ù†
                if (markedReady) {
                    loadMessages();
                } else {
                    // Ø§Ú¯Ø± marked.js Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³ØªØŒ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†
                    let checkCount = 0;
                    const maxChecks = 50;
                    
                    const loadInterval = setInterval(() => {
                        checkCount++;
                        if (markedReady) {
                            clearInterval(loadInterval);
                            loadMessages();
                        } else if (checkCount >= maxChecks) {
                            clearInterval(loadInterval);
                            // Ø­ØªÛŒ Ø§Ú¯Ø± marked.js Ù„ÙˆØ¯ Ù†Ø´Ø¯ØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                            loadMessages();
                        }
                    }, 100);
                }
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ textarea Ø¨Ø§ debounce
    let resizeTimeout = null;
    function autoResizeTextarea() {
        if (resizeTimeout) {
            cancelAnimationFrame(resizeTimeout);
        }
        resizeTimeout = requestAnimationFrame(() => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
            resizeTimeout = null;
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Enter (Shift+Enter Ø¨Ø±Ø§ÛŒ Ø®Ø· Ø¬Ø¯ÛŒØ¯)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± textarea
    messageInput.addEventListener('input', autoResizeTextarea);
    
    // ÙÙˆÚ©ÙˆØ³ Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙˆÛŒ input
    messageInput.focus();
    
    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
    window.addEventListener('load', scrollToBottom);
</script>
{% endblock %}

