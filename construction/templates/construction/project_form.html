{% extends "base.html" %}
{% load static %}
{% load jformat %}
{% block content %}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        {% if object %}
                            ویرایش پروژه
                        {% else %}
                            افزودن پروژه جدید
                        {% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        <a class="btn btn-outline-secondary" href="{% url 'construction_Project_list' %}">
                            <i class="fas fa-arrow-right"></i> بازگشت به لیست پروژه‌ها
                        </a>
                    </p>
                    
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <strong>خطا:</strong> لطفاً موارد زیر را بررسی کنید:
                                <ul class="mb-0 mt-2">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        
                        <div class="form-group">
                            <label for="{{ form.name.id_for_label }}" class="form-label">نام پروژه <span class="text-danger">*</span></label>
                            {{ form.name }}
                        </div>
                        
                        {% if object %}
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle"></i>
                                <strong>نکته مهم:</strong> در صورت تغییر تاریخ پایان پروژه، مقادیر "روز مانده تا پایان پروژه" برای همه تراکنش‌ها به‌طور خودکار به‌روزرسانی می‌شوند. 
                                پس از ذخیره تغییرات، لطفاً به صفحه 
                                <a href="/dashboard/interest-rate-manager/" target="_blank" class="alert-link">مدیریت نرخ سود</a>
                                مراجعه کرده و با استفاده از دکمه "محاسبه مجدد سودها" اقدام به محاسبه مجدد سودهای تراکنش‌ها کنید.
                            </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.start_date_shamsi.id_for_label }}" class="form-label">تاریخ شروع (شمسی) <span class="text-danger">*</span></label>
                                    {{ form.start_date_shamsi }}
                                    <small class="form-text text-muted">فرمت: YYYY-MM-DD</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.end_date_shamsi.id_for_label }}" class="form-label">تاریخ پایان (شمسی) <span class="text-danger">*</span></label>
                                    {{ form.end_date_shamsi }}
                                    <small class="form-text text-muted">فرمت: YYYY-MM-DD</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.total_infrastructure.id_for_label }}" class="form-label">زیر بنای کل</label>
                                    <input type="text" name="total_infrastructure" id="{{ form.total_infrastructure.id_for_label }}" class="form-control" 
                                           placeholder="مثال: 1500.50" 
                                           oninput="formatNumber(this)"
                                           onblur="validateNumber(this)"
                                           value="{{ form.total_infrastructure.value|default:'' }}">
                                    <small class="form-text text-muted">{{ form.total_infrastructure.help_text }}</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.construction_contractor_percentage.id_for_label }}" class="form-label">درصد پیمان ساخت</label>
                                    <input type="text" name="construction_contractor_percentage" id="{{ form.construction_contractor_percentage.id_for_label }}" class="form-control" 
                                           placeholder="مثال: 0.15" 
                                           oninput="formatNumber(this)"
                                           onblur="validateNumber(this)"
                                           value="{{ form.construction_contractor_percentage.value|default:'' }}">
                                    <small class="form-text text-muted">{{ form.construction_contractor_percentage.help_text }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.correction_factor.id_for_label }}" class="form-label">ضریب اصلاحی</label>
                                    <input type="number" name="correction_factor" id="{{ form.correction_factor.id_for_label }}" class="form-control" style="direction: ltr;"
                                           placeholder="مثال: 1.0000000000" 
                                           step="0.0000000001"
                                           min="0"
                                           value="{{ form.correction_factor.value|default:'1.0000000000' }}">
                                    <small class="form-text text-muted">{{ form.correction_factor.help_text }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.color.id_for_label }}" class="form-label">رنگ آیکون پروژه</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="color" name="color" id="{{ form.color.id_for_label }}" 
                                               value="{{ form.color.value|default:'#667eea' }}" 
                                               class="form-control" 
                                               style="width: 80px; height: 40px; cursor: pointer; padding: 2px;">
                                        <input type="text" name="color_text" id="color_text" 
                                               class="form-control" 
                                               placeholder="#667eea"
                                               value="{{ form.color.value|default:'#667eea' }}"
                                               style="flex: 1; direction: ltr;"
                                               onchange="document.getElementById('{{ form.color.id_for_label }}').value = this.value;">
                                    </div>
                                    <small class="form-text text-muted">{{ form.color.help_text }}</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.icon.id_for_label }}" class="form-label">آیکون پروژه</label>
                                    <select name="icon" id="{{ form.icon.id_for_label }}" class="form-control" 
                                            onchange="updateIconPreview(this.value)">
                                        {% for value, label in form.icon.field.choices %}
                                        <option value="{{ value }}" {% if form.icon.value == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    <div id="icon-preview" class="mt-2" style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                        <i class="fas {{ form.icon.value|default:'fa-building' }}" style="font-size: 2rem; color: {{ form.color.value|default:'#667eea' }};"></i>
                                    </div>
                                    <small class="form-text text-muted">{{ form.icon.help_text }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.gradient_primary_color.id_for_label }}" class="form-label">رنگ اول گرادیانت تم</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="color" name="gradient_primary_color" id="{{ form.gradient_primary_color.id_for_label }}" 
                                               value="{{ form.gradient_primary_color.value|default:'#667eea' }}" 
                                               class="form-control" 
                                               style="width: 80px; height: 40px; cursor: pointer; padding: 2px;"
                                               onchange="updateGradientPreview(); document.getElementById('gradient_primary_text').value = this.value;">
                                        <input type="text" name="gradient_primary_text" id="gradient_primary_text" 
                                               class="form-control" 
                                               placeholder="#667eea"
                                               value="{{ form.gradient_primary_color.value|default:'#667eea' }}"
                                               style="flex: 1; direction: ltr;"
                                               onchange="var colorInput = document.getElementById('{{ form.gradient_primary_color.id_for_label }}'); if (/^#[0-9A-F]{6}$/i.test(this.value)) { colorInput.value = this.value; updateGradientPreview(); }">
                                    </div>
                                    <small class="form-text text-muted">{{ form.gradient_primary_color.help_text }}</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.gradient_secondary_color.id_for_label }}" class="form-label">رنگ دوم گرادیانت تم</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="color" name="gradient_secondary_color" id="{{ form.gradient_secondary_color.id_for_label }}" 
                                               value="{{ form.gradient_secondary_color.value|default:'#764ba2' }}" 
                                               class="form-control" 
                                               style="width: 80px; height: 40px; cursor: pointer; padding: 2px;"
                                               onchange="updateGradientPreview(); document.getElementById('gradient_secondary_text').value = this.value;">
                                        <input type="text" name="gradient_secondary_text" id="gradient_secondary_text" 
                                               class="form-control" 
                                               placeholder="#764ba2"
                                               value="{{ form.gradient_secondary_color.value|default:'#764ba2' }}"
                                               style="flex: 1; direction: ltr;"
                                               onchange="var colorInput = document.getElementById('{{ form.gradient_secondary_color.id_for_label }}'); if (/^#[0-9A-F]{6}$/i.test(this.value)) { colorInput.value = this.value; updateGradientPreview(); }">
                                    </div>
                                    <small class="form-text text-muted">{{ form.gradient_secondary_color.help_text }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- پیش‌نمایش گرادیانت -->
                        <div class="form-group">
                            <label class="form-label">پیش‌نمایش گرادیانت تم</label>
                            <div id="gradient-preview" 
                                 style="width: 100%; height: 100px; border-radius: 10px; border: 2px solid #dee2e6; margin-top: 10px; background: linear-gradient(90deg, {{ form.gradient_primary_color.value|default:'#667eea' }} 0%, {{ form.gradient_secondary_color.value|default:'#764ba2' }} 100%); transition: all 0.3s ease;">
                            </div>
                            <small class="form-text text-muted">این گرادیانت به عنوان پس‌زمینه صفحات داشبورد استفاده می‌شود</small>
                        </div>
                        
                    </div>
                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}" class="form-label">توضیحات</label>
                            <!-- Container for Quill editor -->
                            <div id="description-editor" style="height: 200px; direction: rtl; text-align: right;">
                                {{ form.description.value|default:''|safe }}
                            </div>
                            <!-- Hidden input to store HTML content -->
                            <input type="hidden" id="{{ form.description.id_for_label }}" name="description" value="{{ form.description.value|default:'' }}">
                            <small class="form-text text-muted">می‌توانید توضیحات اضافی درباره پروژه را در اینجا وارد کنید</small>
                        </div>
                        
                        <div class="form-actions mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> ذخیره
                            </button>
                            <a href="{% url 'construction_Project_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> انصراف
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrahead %}
<!-- Quill Editor CSS -->
<link href="{% static 'vendor/quill/1.3.6/css/quill.snow.css' %}" rel="stylesheet">
<style>
    /* استایل‌های RTL برای Quill Editor */
    .ql-editor {
        direction: rtl;
        text-align: right;
        font-family: 'Vazir', 'Tahoma', sans-serif;
    }
    
    .ql-toolbar {
        direction: rtl;
        text-align: right;
    }
    
    .ql-container {
        direction: rtl;
    }
    
    /* بهبود ظاهر ادیتور */
    .ql-snow {
        border: 1px solid #1c242b;
        border-radius: 0.25rem;
    }
    
    .ql-snow .ql-tooltip {
        direction: rtl;
    }
</style>
{% endblock %}

{% block extrascripts %}
<!-- Quill Editor JS -->
<script src="{% static 'vendor/quill/1.3.6/js/quill.min.js' %}"></script>
<script>
    // همگام‌سازی color picker با text input
    document.getElementById('{{ form.color.id_for_label }}').addEventListener('change', function() {
        document.getElementById('color_text').value = this.value;
        updateIconPreviewColor();
    });
    
    document.getElementById('color_text').addEventListener('change', function() {
        var colorInput = document.getElementById('{{ form.color.id_for_label }}');
        if (/^#[0-9A-F]{6}$/i.test(this.value)) {
            colorInput.value = this.value;
            updateIconPreviewColor();
        }
    });
    
    // تابع به‌روزرسانی پیش‌نمایش آیکون
    function updateIconPreview(iconClass) {
        var preview = document.getElementById('icon-preview');
        var icon = preview.querySelector('i');
        icon.className = 'fas ' + iconClass;
        updateIconPreviewColor();
    }
    
    // تابع به‌روزرسانی رنگ آیکون
    function updateIconPreviewColor() {
        var preview = document.getElementById('icon-preview');
        var icon = preview.querySelector('i');
        var colorValue = document.getElementById('{{ form.color.id_for_label }}').value || '#667eea';
        icon.style.color = colorValue;
    }
    
    // به‌روزرسانی رنگ هنگام تغییر color picker
    document.getElementById('{{ form.color.id_for_label }}').addEventListener('input', function() {
        document.getElementById('color_text').value = this.value;
        updateIconPreviewColor();
    });
    
    // همگام‌سازی gradient color picker با text input
    var gradientPrimaryInput = document.getElementById('{{ form.gradient_primary_color.id_for_label }}');
    var gradientSecondaryInput = document.getElementById('{{ form.gradient_secondary_color.id_for_label }}');
    
    if (gradientPrimaryInput) {
        gradientPrimaryInput.addEventListener('input', function() {
            document.getElementById('gradient_primary_text').value = this.value;
            updateGradientPreview();
        });
    }
    
    if (gradientSecondaryInput) {
        gradientSecondaryInput.addEventListener('input', function() {
            document.getElementById('gradient_secondary_text').value = this.value;
            updateGradientPreview();
        });
    }
    
    // تابع به‌روزرسانی پیش‌نمایش گرادیانت
    function updateGradientPreview() {
        var preview = document.getElementById('gradient-preview');
        if (!preview) return;
        
        var primaryColor = gradientPrimaryInput ? (gradientPrimaryInput.value || '#667eea') : '#667eea';
        var secondaryColor = gradientSecondaryInput ? (gradientSecondaryInput.value || '#764ba2') : '#764ba2';
        preview.style.background = `linear-gradient(90deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
    }
    
    // مقداردهی اولیه پیش‌نمایش گرادیانت
    if (document.getElementById('gradient-preview')) {
        updateGradientPreview();
    }
    
    // راه‌اندازی Quill Editor
    var quill = new Quill('#description-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                ['clean']
            ]
        },
        placeholder: 'توضیحات اضافی درباره پروژه...',
        direction: 'rtl'
    });

    // همگام‌سازی محتوای ادیتور با فیلد مخفی فرم
    var descriptionInput = document.getElementById('{{ form.description.id_for_label }}');
    
    // بارگذاری محتوای اولیه در ادیتور
    if (descriptionInput.value) {
        quill.root.innerHTML = descriptionInput.value;
    }
    
    // به‌روزرسانی فیلد مخفی هنگام تغییر محتوا
    quill.on('text-change', function() {
        descriptionInput.value = quill.root.innerHTML;
    });
    
    // همگام‌سازی قبل از ارسال فرم
    document.querySelector('form').addEventListener('submit', function() {
        descriptionInput.value = quill.root.innerHTML;
    });
</script>
{% endblock %}