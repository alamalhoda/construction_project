{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-key"></i> تغییر رمز عبور
                    </h4>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        <a class="btn btn-outline-secondary" href="{% url 'user_profile' %}">
                            <i class="fas fa-arrow-right"></i> بازگشت به پروفایل
                        </a>
                    </p>
                    
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert">
                                    <span>&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" id="changePasswordForm">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <strong>خطا:</strong> لطفاً موارد زیر را بررسی کنید:
                                <ul class="mb-0 mt-2">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        
                        <div class="form-group">
                            <label for="old_password_field" class="form-label">
                                <i class="fas fa-lock"></i> رمز عبور فعلی <span class="text-danger">*</span>
                            </label>
                            <input type="password" 
                                   name="old_password" 
                                   id="old_password_field" 
                                   class="form-control" 
                                   required>
                            {% if form.old_password.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.old_password.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="new_password1_field" class="form-label">
                                <i class="fas fa-key"></i> رمز عبور جدید <span class="text-danger">*</span>
                            </label>
                            <input type="password" 
                                   name="new_password1" 
                                   id="new_password1_field" 
                                   class="form-control" 
                                   required>
                            {% if form.new_password1.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.new_password1.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <div class="password-requirements mt-2">
                                <h6>الزامات رمز عبور:</h6>
                                <ul class="mb-0">
                                    <li id="length-req">حداقل 8 کاراکتر</li>
                                    <li id="not-similar-req">نباید شبیه نام کاربری باشد</li>
                                    <li id="not-common-req">نباید رمز عبور رایج باشد</li>
                                    <li id="not-numeric-req">نباید کاملاً عددی باشد</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="new_password2_field" class="form-label">
                                <i class="fas fa-check"></i> تأیید رمز عبور جدید <span class="text-danger">*</span>
                            </label>
                            <input type="password" 
                                   name="new_password2" 
                                   id="new_password2_field" 
                                   class="form-control" 
                                   required>
                            {% if form.new_password2.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.new_password2.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-actions mt-4">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save"></i> تغییر رمز عبور
                            </button>
                            <a href="{% url 'user_profile' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> انصراف
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-shield-alt"></i> نکات امنیتی
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>رمز عبور قوی انتخاب کنید</li>
                        <li>رمز عبور را با کسی به اشتراک نگذارید</li>
                        <li>به طور منظم رمز عبور خود را تغییر دهید</li>
                        <li>از رمز عبور یکسان در سایت‌های مختلف استفاده نکنید</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.password-requirements {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    font-size: 0.85rem;
    color: #666;
}

.password-requirements h6 {
    margin-bottom: 8px;
    color: #333;
    font-weight: 600;
}

.password-requirements ul {
    margin: 0;
    padding-right: 20px;
}

.password-requirements li {
    margin-bottom: 4px;
    transition: color 0.3s ease;
}

.password-requirements li.valid {
    color: #28a745;
}

.password-requirements li.invalid {
    color: #dc3545;
}

.form-control {
    border-radius: 8px;
    border: 2px solid #e1e5e9;
    padding: 12px 15px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.form-control.is-invalid {
    border-color: #dc3545;
}

.btn {
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
}

.alert {
    border-radius: 8px;
    border: none;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    color: #212529;
}

.card-header h4,
.card-header h5,
.card-header h6 {
    color: #212529 !important;
    font-weight: 600;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // صبر کردن کمی تا مطمئن شویم DOM کاملاً لود شده
    setTimeout(function() {
        // جستجوی فیلدها با ID های مشخص
        const newPassword1 = document.getElementById('new_password1_field');
        const newPassword2 = document.getElementById('new_password2_field');
        
        const submitBtn = document.getElementById('submitBtn');
        
        console.log('فیلدهای یافت شده:', {
            newPassword1: newPassword1,
            newPassword2: newPassword2,
            submitBtn: submitBtn,
            allPasswordInputs: document.querySelectorAll('input[type="password"]')
        });
        
        // بررسی وجود فیلدها
        if (!newPassword1 || !newPassword2 || !submitBtn) {
            console.error('فیلدهای فرم یافت نشدند');
            console.log('تمام input های موجود:', document.querySelectorAll('input'));
            return;
        }
        
        // بررسی الزامات رمز عبور
        function checkPasswordRequirements() {
            const password = newPassword1.value;
            const username = '{{ user.username }}';
            
            // حداقل 8 کاراکتر
            const lengthValid = password.length >= 8;
            const lengthReq = document.getElementById('length-req');
            if (lengthReq) lengthReq.className = lengthValid ? 'valid' : 'invalid';
            
            // نباید شبیه نام کاربری باشد
            const notSimilar = !password.toLowerCase().includes(username.toLowerCase());
            const notSimilarReq = document.getElementById('not-similar-req');
            if (notSimilarReq) notSimilarReq.className = notSimilar ? 'valid' : 'invalid';
            
            // نباید کاملاً عددی باشد
            const notNumeric = !/^\d+$/.test(password);
            const notNumericReq = document.getElementById('not-numeric-req');
            if (notNumericReq) notNumericReq.className = notNumeric ? 'valid' : 'invalid';
            
            // رمزهای رایج (لیست ساده)
            const commonPasswords = ['123456', 'password', '123456789', '12345678', '12345', '1234567', '1234567890'];
            const notCommon = !commonPasswords.includes(password.toLowerCase());
            const notCommonReq = document.getElementById('not-common-req');
            if (notCommonReq) notCommonReq.className = notCommon ? 'valid' : 'invalid';
            
            return lengthValid && notSimilar && notNumeric && notCommon;
        }
        
        // بررسی تطابق رمز عبور
        function checkPasswordMatch() {
            const password1 = newPassword1.value;
            const password2 = newPassword2.value;
            
            if (password2 && password1 !== password2) {
                newPassword2.classList.add('is-invalid');
                if (!newPassword2.nextElementSibling || !newPassword2.nextElementSibling.classList.contains('invalid-feedback')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback d-block';
                    errorDiv.textContent = 'رمز عبور و تأیید آن مطابقت ندارند.';
                    newPassword2.parentNode.appendChild(errorDiv);
                }
                return false;
            } else {
                newPassword2.classList.remove('is-invalid');
                const errorDiv = newPassword2.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
                return true;
            }
        }
        
        // بررسی کلی فرم
        function validateForm() {
            const requirementsValid = checkPasswordRequirements();
            const passwordsMatch = checkPasswordMatch();
            
            submitBtn.disabled = !(requirementsValid && passwordsMatch && newPassword1.value && newPassword2.value);
        }
        
        // Event listeners
        newPassword1.addEventListener('input', function() {
            checkPasswordRequirements();
            checkPasswordMatch();
            validateForm();
        });
        
        newPassword2.addEventListener('input', function() {
            checkPasswordMatch();
            validateForm();
        });
        
        // بررسی اولیه
        validateForm();
        
        // نمایش/مخفی کردن رمز عبور
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const toggleBtn = input.parentNode.querySelector('.password-toggle');
            if (!toggleBtn) return;
            
            if (input.type === 'password') {
                input.type = 'text';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                input.type = 'password';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }
        
        // اضافه کردن دکمه نمایش/مخفی کردن رمز عبور
        [newPassword1, newPassword2].forEach(input => {
            if (input) {
                const wrapper = document.createElement('div');
                wrapper.className = 'input-group';
                
                input.parentNode.insertBefore(wrapper, input);
                wrapper.appendChild(input);
                
                const toggleBtn = document.createElement('div');
                toggleBtn.className = 'input-group-append';
                toggleBtn.innerHTML = '<button class="btn btn-outline-secondary password-toggle" type="button" onclick="togglePasswordVisibility(\'' + input.id + '\')"><i class="fas fa-eye"></i></button>';
                wrapper.appendChild(toggleBtn);
            }
        });
        
        // تعریف تابع global
        window.togglePasswordVisibility = togglePasswordVisibility;
        
    }, 100); // صبر 100 میلی‌ثانیه
});
</script>

{% endblock %}
