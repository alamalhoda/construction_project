{% extends "auth_base.html" %}
{% load static %}

{% block title %}ورود به API{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white text-center">
                    <h4>🔐 ورود به API</h4>
                    <p class="mb-0">سیستم مدیریت پروژه ساختمانی</p>
                </div>
                <div class="card-body">
                    <form id="loginForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="username" class="form-label">نام کاربری:</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">رمز عبور:</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="loginBtn">
                                <span class="spinner-border spinner-border-sm d-none" id="spinner"></span>
                                ورود
                            </button>
                        </div>
                    </form>
                    
                    <div id="alertContainer" class="mt-3"></div>
                    
                    <div class="mt-4">
                        <h6>📋 راهنمای استفاده از API:</h6>
                        <ul class="list-unstyled">
                            <li>• پس از ورود، token دریافت خواهید کرد</li>
                            <li>• از token برای دسترسی به API استفاده کنید</li>
                            <li>• API در آدرس <code>/api/v1/</code> در دسترس است</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6>🔗 لینک‌های مفید</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <a href="/admin/" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                                🏠 Django Admin
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="/api/v1/status/" class="btn btn-outline-info btn-sm w-100 mb-2">
                                📊 وضعیت API
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const loginBtn = document.getElementById('loginBtn');
    const spinner = document.getElementById('spinner');
    const alertContainer = document.getElementById('alertContainer');
    
    // نمایش loading
    loginBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        const response = await fetch('/api/v1/auth/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // ورود موفق
            alertContainer.innerHTML = `
                <div class="alert alert-success">
                    <h6>✅ ورود موفقیت‌آمیز!</h6>
                    <p>خوش آمدید <strong>${data.user.username}</strong></p>
                    <hr>
                    <h6>🔑 Token شما:</h6>
                    <div class="input-group">
                        <input type="text" class="form-control" value="${data.token}" readonly id="tokenInput">
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToken()">کپی</button>
                    </div>
                    <hr>
                    <h6>📋 نحوه استفاده:</h6>
                    <p>برای دسترسی به API، header زیر را به درخواست‌های خود اضافه کنید:</p>
                    <code>Authorization: Token ${data.token}</code>
                </div>
            `;
            
            // ذخیره token در localStorage
            localStorage.setItem('api_token', data.token);
            localStorage.setItem('user_info', JSON.stringify(data.user));
            
        } else {
            // خطا در ورود
            alertContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h6>❌ خطا در ورود</h6>
                    <p>${data.error}</p>
                </div>
            `;
        }
        
    } catch (error) {
        alertContainer.innerHTML = `
            <div class="alert alert-danger">
                <h6>❌ خطا در ارتباط</h6>
                <p>خطا در ارتباط با سرور: ${error.message}</p>
            </div>
        `;
    } finally {
        // مخفی کردن loading
        loginBtn.disabled = false;
        spinner.classList.add('d-none');
    }
});

function copyToken() {
    const tokenInput = document.getElementById('tokenInput');
    tokenInput.select();
    document.execCommand('copy');
    
    // نمایش پیام کپی موفق
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'کپی شد!';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-outline-secondary');
    
    setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');
    }, 2000);
}

// بررسی token موجود
window.addEventListener('load', function() {
    const token = localStorage.getItem('api_token');
    const userInfo = localStorage.getItem('user_info');
    
    if (token && userInfo) {
        const user = JSON.parse(userInfo);
        document.getElementById('alertContainer').innerHTML = `
            <div class="alert alert-info">
                <h6>ℹ️ شما قبلاً وارد شده‌اید</h6>
                <p>کاربر: <strong>${user.username}</strong></p>
                <p>Token: <code>${token.substring(0, 20)}...</code></p>
                <button class="btn btn-sm btn-outline-danger" onclick="logout()">خروج</button>
            </div>
        `;
    }
});

async function logout() {
    try {
        const token = localStorage.getItem('api_token');
        
        await fetch('/api/v1/auth/logout/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${token}`,
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        // پاک کردن localStorage
        localStorage.removeItem('api_token');
        localStorage.removeItem('user_info');
        
        // رفرش صفحه
        location.reload();
        
    } catch (error) {
        console.error('Error logging out:', error);
    }
}
</script>
{% endblock %}
