<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پروفایل مالی مشارکت کننده</title>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Vazir Font CSS -->
    <link rel="stylesheet" href="/static/fonts/vazir.css">
    
    <!-- Financial Calculations Service -->
    <script src="/static/js/financial-calculations.js"></script>
    
    <style>
        /* CSS Variables for Theme System */
        :root {
            /* Light Theme Colors */
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --gold-color: #ffd700;
            --gold-color-light: rgba(255, 215, 0, 0.1);
            
            /* Project Standard Colors - Financial Categories */
            --deposit-color: #2185d0;           /* آبی - آورده */
            --deposit-color-light: rgba(33, 133, 208, 0.1);
            --withdrawal-color: #db2828;        /* قرمز - برداشت */
            --withdrawal-color-light: rgba(219, 40, 40, 0.1);
            --profit-color: #21ba45;            /* سبز - سود مشارکت */
            --profit-color-light: rgba(33, 186, 69, 0.1);
            --capital-color: #aa26ff;           /* بنفش - سرمایه موجود */
            --capital-color-light: rgba(170, 38, 255, 0.1);
            --expense-color: #dc3545;           /* قرمز تیره - هزینه‌ها */
            --expense-color-light: rgba(220, 53, 69, 0.1);
            --refund-color: #ffc107;            /* زرد - مرجوعی */
            --refund-color-light: rgba(255, 193, 7, 0.1);
            --balance-color: #6c757d;           /* خاکستری - مانده */
            --balance-color-light: rgba(108, 117, 125, 0.1);
            --total-color: #6c757d;             /* خاکستری - مجموع */
            --total-color-light: rgba(108, 117, 125, 0.1);
            --loan-deposit-color: #5ca5e8;      /* آبی روشن - آورده وام (نزدیک به #2185d0 اما روشن‌تر) */
            --loan-deposit-color-light: rgba(92, 165, 232, 0.1);
            
            /* Background Colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-overlay: rgba(255, 255, 255, 0.95);
            
            /* Text Colors */
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-muted: #8e9297;
            --text-white: #ffffff;
            
            /* Border & Shadow */
            --border-color: #e9ecef;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 8px 25px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.12);
            
            /* Chart Colors */
            --chart-primary: rgba(54, 162, 235, 1);
            --chart-secondary: rgba(255, 99, 132, 1);
            --chart-success: rgba(75, 192, 192, 1);
            --chart-warning: rgba(255, 206, 86, 1);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --gold-color: #ffd700;
            --gold-color-light: rgba(255, 215, 0, 0.15);
            
            /* Project Standard Colors - Financial Categories (Dark Theme) */
            --deposit-color: #4fc3f7;           /* آبی روشن‌تر - آورده */
            --deposit-color-light: rgba(79, 195, 247, 0.2);
            --withdrawal-color: #f48fb1;        /* قرمز روشن‌تر - برداشت */
            --withdrawal-color-light: rgba(244, 143, 177, 0.2);
            --profit-color: #81c784;            /* سبز روشن‌تر - سود مشارکت */
            --profit-color-light: rgba(129, 199, 132, 0.2);
            --capital-color: #c77dff;           /* بنفش روشن‌تر - سرمایه موجود */
            --capital-color-light: rgba(199, 125, 255, 0.2);
            --expense-color: #f48fb1;           /* قرمز روشن‌تر - هزینه‌ها */
            --expense-color-light: rgba(244, 143, 177, 0.2);
            --refund-color: #ffeb3b;            /* زرد روشن‌تر - مرجوعی */
            --refund-color-light: rgba(255, 235, 59, 0.2);
            --balance-color: #b0bec5;           /* خاکستری روشن‌تر - مانده */
            --balance-color-light: rgba(176, 190, 197, 0.2);
            --total-color: #b0bec5;             /* خاکستری روشن‌تر - مجموع */
            --total-color-light: rgba(176, 190, 197, 0.2);
            --loan-deposit-color: #7eb8f0;      /* آبی روشن‌تر برای حالت تاریک */
            --loan-deposit-color-light: rgba(126, 184, 240, 0.15);
            
            /* Dark Background Colors */
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-card: #2d2d2d;
            --bg-overlay: rgba(45, 45, 45, 0.95);
            
            /* Dark Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #888888;
            --text-white: #ffffff;
            
            /* Dark Border & Shadow */
            --border-color: #404040;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 25px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Vazir','Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
            color: var(--text-primary);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Unified Header Design */
        .unified-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            border-radius: 20px 20px 0 0;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .unified-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .unified-header-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .unified-header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .unified-header h1 i {
            font-size: 2.5rem;
            opacity: 0.9;
        }

        .unified-header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 25px;
            font-weight: 300;
        }

        .unified-header .navigation-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .unified-header .nav-link {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unified-header .nav-link:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .unified-header .nav-link i {
            font-size: 1.1rem;
        }

        /* Legacy header styles for backward compatibility */
        .header {
            text-align: center;
            color: var(--text-white);
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: absolute;
            top: 0;
            left: 0;
            background: var(--bg-overlay);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .theme-toggle i {
            font-size: 16px;
        }

        .investor-selector {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .investor-selector h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .investor-selector select {
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
            padding: 12px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            min-width: 300px;
            cursor: pointer;
        }

        .investor-selector select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .investor-info {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
            display: none;
            border: 1px solid var(--border-color);
        }

        .investor-info.show {
            display: block;
        }

        .investor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .investor-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pdf-report-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Vazir', 'Tahoma', Arial, sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .pdf-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .pdf-report-btn i {
            font-size: 1rem;
        }

        .investor-name {
            font-size: 2rem;
            color: #333;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .investor-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .investor-type-badge i {
            font-size: 0.85rem;
        }

        .investor-type-badge.owner {
            background: #667eea;
            color: white;
        }

        .investor-type-badge.investor {
            background: #21ba45;
            color: white;
        }

        .investor-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* استایل‌های قدیمی حذف شده - استایل‌های جدید در پایین */

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-container h3 {
            text-align: center;
            color: var(--text-primary);
            margin: 0;
            font-size: 1.3rem;
            flex: 1;
        }

        .chart-download-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-family: 'Vazir', 'Tahoma', Arial, sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .chart-download-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .chart-download-btn i {
            font-size: 0.9rem;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
        }




        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 50px 0;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .unified-header {
                padding: 25px 20px;
                border-radius: 15px 15px 0 0;
            }

            .unified-header h1 {
                font-size: 2.2rem;
                flex-direction: column;
                gap: 10px;
            }

            .unified-header h1 i {
                font-size: 2rem;
            }

            .unified-header .subtitle {
                font-size: 1.1rem;
            }

            .unified-header .navigation-links {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .unified-header .nav-link {
                padding: 10px 20px;
                font-size: 0.95rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .stats-section {
                padding: 15px;
            }

            .section-title {
                font-size: 1.1rem;
            }

            .section-title i {
                font-size: 1rem;
            }

            .investor-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .investor-actions {
                width: 100%;
                flex-direction: column;
            }

            .pdf-report-btn {
                width: 100%;
                justify-content: center;
            }

            .investor-selector select {
                min-width: 250px;
            }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 15px;
        }

        .loading-overlay .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Advanced Layout & Grid System */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }






        /* Stats Section Enhancement */
        .stats-section {
            margin-bottom: 30px;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .stats-section.unit-section {
            background: linear-gradient(135deg, rgba(170, 38, 255, 0.03), rgba(118, 75, 162, 0.03));
            border: 2px solid rgba(170, 38, 255, 0.2);
        }

        .section-title {
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary-color);
            font-size: 1.3rem;
        }

        .unit-section .section-title i {
            color: #17a2b8;
        }

        /* Variant switching: پیش‌فرض پنهان، با کلاس is-active نمایش داده می‌شود */
        .unit-section [data-variant] { display: none; }
        .unit-section [data-variant].is-active { display: grid; }

        /* Stats Grid Enhancement */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 0;
            padding: 0;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            min-height: 120px;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .stat-card h4 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0;
        }

        /* Golden Profit Index Card */
        .stat-card.profit-index-card {
            background: linear-gradient(135deg, var(--gold-color-light) 0%, var(--bg-card) 100%);
            border: 2px solid var(--gold-color);
            box-shadow: 0 8px 25px var(--gold-color-light);
            position: relative;
            overflow: hidden;
        }

        .stat-card.profit-index-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--gold-color), #ffed4e);
        }

        .stat-card.profit-index-card h4 {
            color: var(--gold-color);
            text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
            font-weight: 800;
        }

        .stat-card.profit-index-card p {
            color: var(--text-primary);
            font-weight: 500;
        }

        .stat-card.profit-index-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px var(--gold-color-light);
        }

        /* کارت آورده (Deposit Card) */
        .stat-card.deposit-card {
            border: 2px solid var(--deposit-color);
            background: linear-gradient(135deg, var(--deposit-color-light), rgba(33, 133, 208, 0.05));
        }

        .stat-card.deposit-card h4 {
            color: var(--deposit-color);
            font-weight: 700;
        }

        /* کارت آورده وام (Loan Deposit Card) */
        .stat-card.loan-deposit-card {
            border: 2px solid var(--loan-deposit-color);
            background: linear-gradient(135deg, var(--loan-deposit-color-light), rgba(92, 165, 232, 0.05));
        }

        .stat-card.loan-deposit-card h4 {
            color: var(--loan-deposit-color);
            font-weight: 700;
        }

        /* کارت برداشت (Withdrawal Card) */
        .stat-card.withdrawal-card {
            border: 2px solid var(--withdrawal-color);
            background: linear-gradient(135deg, var(--withdrawal-color-light), rgba(219, 40, 40, 0.05));
        }

        .stat-card.withdrawal-card h4 {
            color: var(--withdrawal-color);
            font-weight: 700;
        }

        /* کارت سرمایه موجود (Capital Card) */
        .stat-card.capital-card {
            border: 2px solid var(--capital-color);
            background: linear-gradient(135deg, var(--capital-color-light), rgba(170, 38, 255, 0.05));
        }

        .stat-card.capital-card h4 {
            color: var(--capital-color);
            font-weight: 700;
        }

        /* کارت سود (Profit Card) */
        .stat-card.profit-card {
            border: 2px solid var(--profit-color);
            background: linear-gradient(135deg, var(--profit-color-light), rgba(33, 186, 69, 0.05));
        }

        .stat-card.profit-card h4 {
            color: var(--profit-color);
            font-weight: 700;
        }

        /* کارت مانده (Balance Card) */
        .stat-card.balance-card {
            border: 2px solid var(--balance-color);
            background: linear-gradient(135deg, var(--balance-color-light), rgba(108, 117, 125, 0.05));
        }

        .stat-card.balance-card h4 {
            color: var(--balance-color);
            font-weight: 700;
        }

        /* Current Period Section - Special styling */
        .current-period-section {
            grid-column: 1 / -1;
            position: relative;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 193, 7, 0.05) 100%);
            border-radius: 20px;
            border: 2px dashed var(--gold-color);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.15);
        }

        .current-period-badge {
            position: absolute;
            top: -15px;
            right: 30px;
            background: linear-gradient(135deg, var(--gold-color) 0%, #ffc107 100%);
            color: rgb(0, 0, 0);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
        }

        .current-period-badge i {
            font-size: 1rem;
        }

        .stats-section .current-period-section .stat-card {
            border: 3px solid !important;
            background: var(--bg-card) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
            transform: none !important;
        }

        .stats-section .current-period-section .stat-card:hover {
            transform: translateY(-8px) !important;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2) !important;
        }

        .stats-section .current-period-section .current-final-cost-card {
            border-color: var(--expense-color) !important;
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, var(--bg-card) 100%) !important;
        }

        .stats-section .current-period-section .current-building-fund-card {
            border-color: var(--balance-color) !important;
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.03) 0%, var(--bg-card) 100%) !important;
        }

        .stats-section .current-period-section .stat-card h4 {
            font-size: 2.3rem !important;
            font-weight: 700 !important;
            color: rgb(0, 0, 0) !important;
        }

        .stats-section .current-period-section .stat-card i {
            color: rgb(0, 0, 0) !important;
            font-size: 3rem !important;
        }

        .stats-section .current-period-section .stat-card p {
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            color: rgb(0, 0, 0) !important;
        }

        .stats-section .current-period-section .current-final-cost-card i {
            color: var(--expense-color) !important;
        }

        .stats-section .current-period-section .current-final-cost-card h4 {
            color: var(--expense-color) !important;
        }

        .stats-section .current-period-section .current-final-cost-card p {
            color: var(--expense-color) !important;
        }

        .current-period-section .current-final-cost-card i {
            color: var(--expense-color) !important;
        }

        .current-period-section .current-final-cost-card h4 {
            color: var(--expense-color) !important;
        }

        .current-period-section .current-final-cost-card p {
            color: var(--expense-color) !important;
        }

        /* Responsive Breakpoints */
        @media (max-width: 768px) {
            .current-period-section {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
                padding: 20px !important;
                margin: 15px 0 !important;
            }

            .current-period-badge {
                top: -12px !important;
                right: 20px !important;
                padding: 6px 15px !important;
                font-size: 0.85rem !important;
            }

            .charts-grid {
                gap: 20px;
            }
            
            .chart-container {
                padding: 20px;
            }
            
            .chart-wrapper {
                height: 400px;
            }

            .chart-header {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .chart-download-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .chart-container {
                padding: 15px;
            }
            
            .chart-wrapper {
                height: 350px;
            }
        }

        /* Print Styles */
        @media print {
            .chart-download-btn {
                display: none !important;
            }

            .theme-toggle {
                display: none !important;
            }

            .pdf-report-btn {
                display: none !important;
            }
        }

        /* Chart Legend Styles */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-color);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .chart-info {
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chart-info small {
            color: var(--text-muted);
            font-size: 12px;
        }

        .chart-info i {
            margin-right: 5px;
            color: var(--primary-color);
        }

    </style>
</head>
<body>
   
    <div class="main-container">
        <div class="container">
        <div class="unified-header">
            <div class="unified-header-content">
                <h1>
                    <i class="fas fa-user-tie"></i>
                    پروفایل مالی مشارکت کننده
                </h1>
                <p class="subtitle">نمایش جامع وضعیت مالی </p>
                <div class="navigation-links">
                    <a href="/user-dashboard/" class="nav-link">
                        <i class="fas fa-home"></i>
                        صفحه اصلی
                    </a>
                    <a href="/dashboard/project/" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        خلاصه مالی
                    </a>
                    <a href="/dashboard/transaction-manager/" class="nav-link">
                        <i class="fas fa-money-bill-wave"></i>
                        مدیریت تراکنش‌ها
                    </a>
                    <a href="/dashboard/expense-dashboard/" class="nav-link">
                        <i class="fas fa-chart-pie"></i>
                        لیست هزینه ها
                    </a>
                    <a href="/dashboard/interest-rate-manager/" class="nav-link">
                        <i class="fas fa-percentage"></i>
                        مدیریت سود
                    </a>
                </div>
            </div>
        </div>

        <!-- Theme Toggle Button (moved outside header) -->
        <div style="text-align: left; margin-bottom: 20px;">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon" id="themeIcon"></i>
                <span id="themeText">حالت تیره</span>
            </button>
        </div>

        <div class="dashboard-layout">
        <div class="investor-selector">
            <h3><i class="fas fa-search"></i> انتخاب مشارکت کننده</h3>
            <select id="investorSelect">
                <option value="">-- انتخاب کنید --</option>
            </select>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> در حال بارگذاری داده‌ها...
        </div>

        <div id="error" class="error" style="display: none;">
            خطا در بارگذاری داده‌ها
        </div>

        <div id="investorInfo" class="investor-info">

            <div class="investor-header">
                <div class="investor-name">
                    <span id="investorName">نام مشارکت کننده</span>
                    <span id="investorType" class="investor-type-badge"></span>
                </div>
                <div class="investor-actions">
                    <a href="#" class="pdf-report-btn" id="pdfReportBtn" style="display: none;">
                        <i class="fas fa-file-pdf"></i>
                        گزارش PDF
                    </a>
                </div>
            </div>

            <!-- اطلاعات مالی مشارکت کننده -->
            <div class="stats-section">
                <h3 class="section-title">
                    <i class="fas fa-wallet"></i>
                    اطلاعات مالی
                </h3>
                <div class="stats-grid">
                    <div class="stat-card deposit-card">
                        <h4 id="totalPrincipalDeposit">-</h4>
                        <p>آورده نقدی (تومان)</p>
                    </div>
                    <div class="stat-card loan-deposit-card">
                        <h4 id="totalLoanDeposit">-</h4>
                        <p>آورده وام (تومان)</p>
                    </div>
                    <div class="stat-card deposit-card" style="border: 3px solid var(--deposit-color); background: linear-gradient(135deg, var(--deposit-color-light), rgba(33, 133, 208, 0.15));">
                        <h4 id="totalPrincipal">-</h4>
                        <p>مجموع آورده (تومان)</p>
                    </div>
                    <div class="stat-card withdrawal-card">
                        <h4 id="totalWithdrawal">-</h4>
                        <p>کل برداشت (تومان)</p>
                    </div>
                    <div class="stat-card capital-card">
                        <h4 id="netPrincipal">-</h4>
                        <p>سرمایه موجود (تومان)</p>
                    </div>
                    <div class="stat-card profit-card">
                        <h4 id="totalProfit">-</h4>
                        <p>کل سود (تومان)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="totalBalance">-</h4>
                        <p>سرمایه+سود مشارکت (تومان)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="capitalRatio">-</h4>
                        <p>نسبت سرمایه به سرمایه کل</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="profitRatioToTotal">-</h4>
                        <p>نسبت سود به سود کل</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="totalRatioToGrandTotal">-</h4>
                        <p>نسبت (سرمایه+سود) به (سرمایه کل+سود کل)</p>
                    </div>
                    <div class="stat-card profit-index-card">
                        <h4 id="profitIndex">-</h4>
                        <p>شاخص نفع (نسبت سود به سودکل/ نسبت سرمایه به سرمایه کل )</p>
                    </div>
                    <div class="stat-card balance-card">
                        <h4 id="contractDate">-</h4>
                        <p>تاریخ قرارداد</p>
                    </div>
                </div>
            </div>

            <!-- کارت‌های ویژه دوره جاری -->
            <div class="current-period-section">
                <div class="current-period-badge">
                    <i class="fas fa-star"></i>
                 وضعیت فعلی پروژه
                </div>
                <div class="stat-card current-final-cost-card">
                    <i class="fas fa-calendar-check"></i>
                    <h4 id="currentFinalCost">-</h4>
                    <p>هزینه خالص فعلی (تومان)</p>
                </div>
                <div class="stat-card current-building-fund-card">
                    <i class="fas fa-building"></i>
                    <h4 id="currentBuildingFundBalance">-</h4>
                    <p>مانده صندوق فعلی (تومان)</p>
                </div>
            </div>

            <!-- اطلاعات واحد انتخاب شده -->
            <div class="stats-section unit-section">
                <h3 class="section-title">
                    <i class="fas fa-building"></i>
                    اطلاعات واحد انتخاب شده
                </h3>

                <!-- حالت مالک -->
                <div class="stats-grid" data-variant="owner">
                    <div class="stat-card" style="border: 2px solid #17a2b8; background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(20, 143, 163, 0.1));">
                        <h4 id="unitName">-</h4>
                        <p>نام واحد</p>
                    </div>
                    <div class="stat-card" style="border: 2px solid #fd7e14; background: linear-gradient(135deg, rgba(253, 126, 20, 0.1), rgba(230, 109, 8, 0.1));">
                        <h4 id="unitArea">-</h4>
                        <p>مساحت واحد (متر مربع)</p>
                    </div>
                    <div class="stat-card" style="border: 2px solid #9c27b0; background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(142, 36, 170, 0.1));">
                        <h4 id="totalUnitsPrice">-</h4>
                        <p>قیمت واحد انتخاب شده (تومان)</p>
                    </div>
                    <div class="stat-card" style="border: 2px solid #6f42c1; background: linear-gradient(135deg, rgba(111, 66, 193, 0.1), rgba(102, 16, 242, 0.1));">
                        <h4 id="averagePricePerMeter">-</h4>
                        <p>میانگین وزنی قیمت هر متر (تومان/متر مربع)</p>
                    </div>
                    <div class="stat-card" style="border: 2px solid #ff8c00; background: linear-gradient(135deg, rgba(255, 140, 0, 0.1), rgba(255, 165, 0, 0.1));">
                        <h4 id="ownershipArea">-</h4>
                        <p>مالکیت فعلی(متر مربع)</p>
                    </div>
                    <div class="stat-card" style="border: 2px solid #20c997; background: linear-gradient(135deg, rgba(32, 201, 151, 0.1), rgba(16, 172, 132, 0.1));">
                        <h4 id="finalPayment">-</h4>
                        <p>پرداخت نهایی جهت تسویه حساب (تومان)</p>
                    </div>
                    <div class="stat-card" style="border: 2px solid #e83e8c; background: linear-gradient(135deg, rgba(232, 62, 140, 0.1), rgba(219, 30, 118, 0.1));">
                        <h4 id="transferPricePerMeter">-</h4>
                        <p>قیمت واگذار شده به مشارکت کننده(تومان/متر مربع)</p>
                    </div>
                    <div class="stat-card" style="border: 2px solid var(--expense-color); background: linear-gradient(135deg, var(--expense-color-light), rgba(220, 53, 69, 0.05));">
                        <h4 id="currentUnitCost">-</h4>
                        <p>هزینه فعلی واحد (تومان)</p>
                    </div>
                </div>

                <!-- حالت سرمایه‌گذار: فقط نمایش مالکیت محاسبه‌شده -->
                <div class="stats-grid" data-variant="investor" hidden>
                    <div class="stat-card" style="border: 2px solid #ff8c00; background: linear-gradient(135deg, rgba(255, 140, 0, 0.1), rgba(255, 165, 0, 0.1));">
                        <h4 id="ownershipAreaInvestor">-</h4>
                        <p>مالکیت محاسبه شده (متر مربع)</p>
                    </div>
                    <div class="stat-card" style="border: 2px solid var(--balance-color); background: linear-gradient(135deg, var(--balance-color-light), rgba(108, 117, 125, 0.05));">
                        <h4 id="valuePerMeterInvestor">-</h4>
                        <p></p>میانگین وزنی قیمت هر متر ساختمان(تومان/متر مربع)</p>
                    </div>
                </div>
            </div>

            <!-- Charts Section with New Grid Layout -->
            <div class="charts-grid">

                <!-- Investor Trend Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-line"></i> ترند سرمایه موجود و هزینه واحد</h3>
                        <button class="chart-download-btn" onclick="downloadChart('investorTrendChart', 'ترند_سرمایه_و_هزینه')">
                            <i class="fas fa-download"></i>
                            دانلود تصویر
                        </button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="investorTrendChart"></canvas>
                    </div>
                    <div class="chart-info">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            هزینه واحد = (هزینه خالص تجمعی ÷ کل متراژ مفید) × متراژ واحد
                        </small>
                    </div>
                </div>

                <!-- Principal Transaction Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-line"></i> روند تراکنش‌های آورده و برداشت</h3>
                        <button class="chart-download-btn" onclick="downloadChart('principalTransactionChart', 'روند_تراکنش_ها')">
                            <i class="fas fa-download"></i>
                            دانلود تصویر
                        </button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="principalTransactionChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Principal Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-area"></i> نمودار ماهانه آورده، برداشت و سرمایه موجود</h3>
                        <button class="chart-download-btn" onclick="downloadChart('monthlyPrincipalChart', 'نمودار_ماهانه_آورده_برداشت')">
                            <i class="fas fa-download"></i>
                            دانلود تصویر
                        </button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyPrincipalChart"></canvas>
                    </div>
                </div>

                <!-- Activity Distribution Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-pie"></i> توزیع تراکنش‌ها</h3>
                        <button class="chart-download-btn" onclick="downloadChart('activityDistributionChart', 'توزیع_تراکنش_ها')">
                            <i class="fas fa-download"></i>
                            دانلود تصویر
                        </button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="activityDistributionChart"></canvas>
                    </div>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تنظیم فونت پیش‌فرض Chart.js به Vazir
        Chart.defaults.font.family = "'Vazir', 'Tahoma', 'Arial', sans-serif";
        Chart.defaults.font.size = 12;
        
        // تنظیمات اضافی برای نمودارها
        Chart.defaults.plugins.legend.labels.font = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 13
        };
        Chart.defaults.plugins.tooltip.titleFont = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 14
        };
        Chart.defaults.plugins.tooltip.bodyFont = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 12
        };
        Chart.defaults.scales.category.ticks.font = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 11
        };
        Chart.defaults.scales.linear.ticks.font = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 11
        };

        let selectedInvestor = null;
        let charts = {}; // نگهداری نمودارها
        
        // کش داده‌ها برای جلوگیری از فراخوانی تکراری API
        let cachedInvestorData = {}; // کش اطلاعات مشارکت‌کنندگان

        // متغیر برای تبدیل مبالغ (1 میلیون) - برای نمودارها
        const BASE_AMOUNT = 1000000;
        
        // متغیر سراسری برای نام پروژه
        let projectName = '';
        
        // تابع فرمت‌کننده اعداد با جداکننده هزارگان انگلیسی
        function formatNumberWithCommas(number) {
            if (number === null || number === undefined || isNaN(number)) {
                return '0';
            }
            return Math.round(number).toLocaleString('en-US');
        }
        
        // تابع فراخوانی API آمار کلی
        async function fetchGlobalStatistics() {
            try {
                const response = await fetch('/api/v1/Transaction/statistics/');
                if (response.ok) {
                    globalStatistics = await response.json();
                    console.log('آمار کلی دریافت شد:', globalStatistics);
                    return globalStatistics;
                } else {
                    console.warn('خطا در دریافت آمار کلی:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('خطا در فراخوانی API آمار کلی:', error);
                return null;
            }
        }
        
        // تابع دریافت نام پروژه از API
        async function fetchProjectName() {
            try {
                const response = await fetch('/api/v1/Project/');
                if (response.ok) {
                    const projectsData = await response.json();
                    const projects = Array.isArray(projectsData) ? projectsData : (projectsData.results || []);
                    if (projects.length > 0) {
                        projectName = projects[0].name || '';
                        console.log('نام پروژه دریافت شد:', projectName);
                    }
                } else {
                    console.warn('خطا در دریافت اطلاعات پروژه:', response.status);
                }
            } catch (error) {
                console.error('خطا در فراخوانی API پروژه:', error);
            }
        }

        // Download Chart as Image
        function downloadChart(chartId, fileName) {
            const chart = charts[chartId];
            if (!chart) {
                alert('نمودار یافت نشد');
                return;
            }

            try {
                // دریافت نام مشارکت کننده
                const investorNameElement = document.getElementById('investorName');
                const investorName = investorNameElement ? investorNameElement.textContent.trim() : 'نامشخص';
                
                // تبدیل نمودار به تصویر با کیفیت بالا
                const url = chart.toBase64Image('image/png', 1);
                
                // ایجاد لینک دانلود با نام مشارکت کننده
                const link = document.createElement('a');
                link.download = `${investorName}_${fileName}_${getCurrentPersianDate()}.png`;
                link.href = url;
                link.click();
            } catch (error) {
                console.error('خطا در دانلود نمودار:', error);
                alert('خطا در دانلود نمودار');
            }
        }

        // Get current Persian date for file naming
        function getCurrentPersianDate() {
            const date = new Date();
            return date.toLocaleDateString('fa-IR').replace(/\//g, '-');
        }

        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'حالت روشن';
            } else {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'حالت تیره';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }


        

        // تابع loadData() حذف شد چون دیگر نیازی نیست
        // داده‌ها به صورت فیلتر شده و تنها هنگام انتخاب مشارکت کننده بارگذاری می‌شوند

        // پر کردن select مشارکت کنندگان
        function populateInvestorSelectFromAPI() {
            // بارگذاری موازی لیست مشارکت کنندگان و آمار کلی
            Promise.all([
                fetch('/api/v1/Investor/'),
                fetchGlobalStatistics()
            ])
            .then(([investorsResponse, statsResponse]) => {
                if (!investorsResponse.ok) {
                    throw new Error(`HTTP error! status: ${investorsResponse.status}`);
                }
                return investorsResponse.json();
            })
                .then(data => {
                    // Django REST Framework returns a 'results' array for list views
                    const investors = data.results || data;
                    
            const select = document.getElementById('investorSelect');
            
                    // پاک کردن گزینه‌های قبلی
                    select.innerHTML = '<option value="">انتخاب مشارکت کننده...</option>';
                    
                    // اضافه کردن مشارکت کنندگان جدید
            investors.forEach(investor => {
                const option = document.createElement('option');
                        option.value = investor.id;
                        option.textContent = investor.first_name + ' ' + investor.last_name;
                select.appendChild(option);
            });

            // اضافه کردن event listener
            select.addEventListener('change', function() {
                if (this.value) {
                    showInvestorProfile(this.value);
                } else {
                    hideInvestorProfile();
                        }
                    });
                })
                .catch(error => {
                    console.error('خطا در بارگذاری مشارکت کنندگان:', error);
                    showError('خطا در ارتباط با سرور برای دریافت لیست مشارکت کنندگان');
                });
        }

        // جایگزین: استفاده از HTML view موجود  
        function populateInvestorSelectFromHTML() {
            // خواندن لیست مشارکت کنندگان از HTML view موجود در construction
            fetch('/construction/Investor/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text(); // HTML content به جای JSON
                })
                .then(htmlContent => {
                    // Parse HTML content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    
            const select = document.getElementById('investorSelect');
                    select.innerHTML = '<option value="">انتخاب مشارکت کننده...</option>';
                    
                    // فرض می‌کنم که در HTML view، لیست مشارکت کنندگان در جدولی نمایش داده می‌شود
                    // باید ساختار واقعی HTML view را ببینیم
                    const rows = doc.querySelectorAll('table tbody tr'); // نمونه selector
                    
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 2) {
                            const firstName = cells[0].textContent.trim();
                            const lastName = cells[1].textContent.trim();
                            
                const option = document.createElement('option');
                            option.value = firstName;
                            option.textContent = firstName + ' ' + lastName;
                select.appendChild(option);
                        }
            });

            // اضافه کردن event listener
            select.addEventListener('change', function() {
                if (this.value) {
                    showInvestorProfile(this.value);
                } else {
                    hideInvestorProfile();
                }
                    });
                })
                .catch(error => {
                    console.error('خطا در بارگذاری مشارکت کنندگان:', error);
                    showError('خطا در ارتباط با سرور برای دریافت لیست مشارکت کنندگان');
                });
        }

        // استفاده از API (روش فعلی - بهتر برای JavaScript)
        function populateInvestorSelect() {
            // برای سادگی از API استفاده می‌کنیم
            populateInvestorSelectFromAPI();
        }

        // تابع جدید: بارگذاری تراکنش‌های یک مشارکت کننده خاص از سرور
        function loadInvestorTransactions(investorId) {
            console.log('بارگذاری تراکنش‌های مشارکت کننده:', investorId);
            
            // نمایش loading برای بخش پروفایل
            const investorInfo = document.getElementById('investorInfo');
            if (investorInfo) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'investor-loading';
                loadingDiv.className = 'loading-overlay';
                loadingDiv.innerHTML = '<div class="spinner"></div><p>در حال بارگذاری اطلاعات مشارکت کننده...</p>';
                investorInfo.appendChild(loadingDiv);
            }
            
            // بارگذاری تراکنش‌های این مشارکت کننده با فیلتر
            return fetch(`/api/v1/Transaction/?investor=${investorId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const transactions = data.results || data;
                    
                    // تبدیل داده‌ها به فرمت مشابه CSV
                    const investorTransactions = transactions.map(transaction => ({
                        project_id: transaction.project?.name || '',
                        investor_name: `${transaction.investor?.first_name || ''} ${transaction.investor?.last_name || ''}`.trim(),
                        investor_id: transaction.investor?.id || '',
                        entry_type: transaction.transaction_type || '',
                        amount: parseFloat(transaction.amount) || 0,
                        date_shamsi: transaction.date_shamsi || '',
                        date_gregorian: transaction.date_gregorian || '',
                        period_label: transaction.period?.label || '',
                        row_index: transaction.id,
                        day_remaining: transaction.day_remaining || 0,
                        day_from_start: transaction.day_from_start || 0
                    }));
                    
                    console.log(`${investorTransactions.length} تراکنش برای مشارکت کننده بارگذاری شد`);
                    
                    // حذف loading
                    const loadingElement = document.getElementById('investor-loading');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    return investorTransactions;
                })
                .catch(error => {
                    console.error('خطا در بارگذاری تراکنش‌های مشارکت کننده:', error);
                    
                    // حذف loading
                    const loadingElement = document.getElementById('investor-loading');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    showError('خطا در بارگذاری اطلاعات مشارکت کننده: ' + error.message);
                    return [];
                });
        }

        // تابع کمکی: گرفتن تراکنش‌های یک نوع خاص از لیست
        function getTransactionsByType(transactions, transactionType) {
            return transactions.filter(transaction => 
                transaction.entry_type === transactionType
            );
        }

        // نمایش پروفایل مشارکت کننده
        function showInvestorProfile(investorId) {
            console.log('نمایش پروفایل برای:', investorId);
            selectedInvestor = investorId;
            document.getElementById('investorInfo').classList.add('show');
            
            // پاک کردن نمودارهای قبلی
            destroyCharts();
            
            // بارگذاری تراکنش‌های این مشارکت کننده از سرور
            loadInvestorTransactions(investorId)
                .then(investorTransactions => {
                    if (investorTransactions && investorTransactions.length > 0) {
                        // اطلاعات تفصیلی را به‌روزرسانی کنیم
                        updateInvestorInfoWithData(investorId, investorTransactions);
                        
                        // ایجاد نمودارها با داده‌های فیلتر شده
                        try {
                            createActivityDistributionChart(investorTransactions);
                            // createMonthlyComparisonChart(investorTransactions); // حذف شده
                            createPrincipalTransactionChart(investorTransactions);
                            createMonthlyPrincipalChart(investorTransactions);
                            // بارگذاری نمودار ترند مشارکت کننده با استفاده از همان داده‌های تراکنش‌ها
                            loadInvestorTrendData(investorId, investorTransactions);
                        } catch (error) {
                            console.error('خطا در ایجاد نمودارها:', error);
                        }
                    } else {
                        // اگر تراکنشی وجود نداشت
                        updateInvestorInfoWithData(investorId, []);
                        showError('هیچ تراکنشی برای این مشارکت کننده یافت نشد');
                    }
                })
                .catch(error => {
                    console.error('خطا در نمایش پروفایل مشارکت کننده:', error);
                    showError('خطا در بارگذاری پروفایل مشارکت کننده');
                });
        }


        // تابع جدید: دریافت محاسبات از سرور
        async function updateInvestorStatsFromServer(investorId, investorName) {
            try {
                console.log(`📡 دریافت آمار مشارکت کننده ${investorId} از سرور...`);
                
                // دریافت آمار تفصیلی مشارکت کننده از API (شامل محاسبات جداگانه آورده و آورده وام)
                const investorStats = await window.financialService.getInvestorStatistics(investorId);
                
                // دریافت نسبت‌های مشارکت کننده از API
                let investorRatios = null;
                try {
                    const response = await fetch(`/api/v1/Investor/${investorId}/ratios/`);
                    if (response.ok) {
                        investorRatios = await response.json();
                    }
                } catch (error) {
                    console.warn('⚠️ خطا در دریافت نسبت‌ها:', error);
                }
                
                // دریافت مالکیت مشارکت کننده از API
                let investorOwnership = null;
                try {
                    const response = await fetch(`/api/v1/Investor/${investorId}/ownership/`);
                    if (response.ok) {
                        investorOwnership = await response.json();
                        console.log('✅ مالکیت مشارکت کننده از سرور دریافت شد:', investorOwnership);
                    }
                } catch (error) {
                    console.warn('⚠️ خطا در دریافت مالکیت:', error);
                }
                
                if (investorStats && !investorStats.error) {
                    console.log('✅ آمار مشارکت کننده از سرور دریافت شد:', investorStats);
                    
                    // تبدیل داده‌های سرور به فرمت قابل مقایسه (استفاده از amounts_toman)
                    const serverCalculations = {
                        totalPrincipalDeposit: investorStats.amounts_toman?.total_principal_deposit || 0,  // فقط آورده عادی
                        totalLoanDeposit: investorStats.amounts_toman?.total_loan_deposit || 0,  // فقط آورده وام
                        totalPrincipal: investorStats.amounts_toman?.total_principal || 0,  // مجموع آورده + آورده وام
                        totalWithdrawal: Math.abs(investorStats.amounts_toman?.total_withdrawal || 0),
                        totalProfit: investorStats.amounts_toman?.total_profit || 0,
                        netPrincipal: investorStats.amounts_toman?.net_principal || 0,
                        totalBalance: investorStats.amounts_toman?.total_balance || 0,
                        capitalRatio: investorRatios?.capital_ratio_formatted || '0.00%',
                        profitRatioToTotal: investorRatios?.profit_ratio_formatted || '0.00%',
                        totalRatioToGrandTotal: investorRatios?.total_ratio_formatted || '0.00%',
                        profitIndex: investorRatios?.profit_index || '0.00',
                        ownershipArea: investorOwnership?.ownership_area || 0,
                        ownershipPercentage: investorOwnership?.ownership_percentage || 0,
                        finalPayment: investorOwnership?.final_payment || 0,
                        transferPricePerMeter: investorOwnership?.transfer_price_per_meter || 0,
                        totalUnitsPrice: investorOwnership?.total_units_price || 0,
                        averagePricePerMeter: investorOwnership?.average_price_per_meter || 0,
                        value_per_meter: investorOwnership?.value_per_meter || 0,
                        currentUnitCost: investorOwnership?.current_unit_cost || 0
                    };


                    // به‌روزرسانی UI با مقادیر سرور
                    updateUIWithServerData(serverCalculations);
                    
                    console.log('✅ UI با داده‌های سرور به‌روزرسانی شد');
                } else {
                    console.warn('⚠️ خطا در دریافت آمار سرور:', investorStats?.error || 'خطای نامشخص');
                    console.log('🔄 استفاده از محاسبات محلی ادامه می‌یابد');
                }
                
            } catch (error) {
                console.error('❌ خطا در دریافت محاسبات از سرور:', error);
                console.log('🔄 استفاده از محاسبات محلی ادامه می‌یابد');
            }
        }

        // تابع به‌روزرسانی UI با داده‌های سرور
        function updateUIWithServerData(serverCalculations) {
            // به‌روزرسانی المان‌های HTML با مقادیر سرور
            const elements = [
                { id: 'totalPrincipalDeposit', value: serverCalculations.totalPrincipalDeposit },
                { id: 'totalLoanDeposit', value: serverCalculations.totalLoanDeposit },
                { id: 'totalPrincipal', value: serverCalculations.totalPrincipal },
                { id: 'totalWithdrawal', value: serverCalculations.totalWithdrawal },
                { id: 'netPrincipal', value: serverCalculations.netPrincipal },
                { id: 'totalProfit', value: serverCalculations.totalProfit },
                { id: 'totalBalance', value: serverCalculations.totalBalance },
                { id: 'capitalRatio', value: serverCalculations.capitalRatio },
                { id: 'profitRatioToTotal', value: serverCalculations.profitRatioToTotal },
                { id: 'totalRatioToGrandTotal', value: serverCalculations.totalRatioToGrandTotal },
                { id: 'profitIndex', value: serverCalculations.profitIndex },
                { id: 'ownershipArea', value: serverCalculations.ownershipArea },
                { id: 'ownershipAreaInvestor', value: serverCalculations.ownershipArea },
                { id: 'valuePerMeterInvestor', value: serverCalculations.value_per_meter },
                { id: 'finalPayment', value: serverCalculations.finalPayment },
                { id: 'transferPricePerMeter', value: serverCalculations.transferPricePerMeter },
                { id: 'totalUnitsPrice', value: serverCalculations.totalUnitsPrice },
                { id: 'averagePricePerMeter', value: serverCalculations.averagePricePerMeter },
                { id: 'currentUnitCost', value: serverCalculations.currentUnitCost }
            ];

            elements.forEach(element => {
                const domElement = document.getElementById(element.id);
                if (domElement) {
                    if (element.id.includes('Ratio') || element.id.includes('Index')) {
                        // برای نسبت‌ها و شاخص‌ها، مقدار را مستقیماً نمایش دهیم
                        if (element.id === 'profitIndex') {
                            // شاخص نفع را تا ۲ رقم اعشار فرمت کن
                            const profitIndexValue = parseFloat(element.value);
                            // اگر شاخص نفع صفر است (برای سرمایه‌گذاران)، "-" نمایش بده
                            const formatted = profitIndexValue === 0 ? '-' : profitIndexValue.toFixed(2);
                            domElement.textContent = formatted;
                        } else {
                            domElement.textContent = element.value;
                        }
                    } else if (element.id.includes('ownershipArea')) {
                        // برای مالکیت (متر مربع)، فرمت اعشار با 3 رقم
                        const formatted = parseFloat(element.value).toLocaleString('en-US', {
                            minimumFractionDigits: 3,
                            maximumFractionDigits: 3
                        });
                        domElement.textContent = formatted;
                    } else if (element.id === 'transferPricePerMeter' || element.id === 'averagePricePerMeter' || element.id === 'valuePerMeterInvestor') {
                        // برای قیمت واگذار شده و میانگین وزنی قیمت هر متر، فرمت عددی با جداکننده
                        const v = parseFloat(element.value);
                        domElement.textContent = (isNaN(v) || v <= 0) ? '-' : formatNumberWithCommas(v);
                    } else if (element.id === 'currentUnitCost') {
                        // برای هزینه فعلی واحد، فرمت عددی با جداکننده
                        const v = parseFloat(element.value);
                        domElement.textContent = (isNaN(v) || v <= 0) ? '-' : formatNumberWithCommas(v);
                    } else if (element.id === 'finalPayment') {
                        // برای پرداخت نهایی، نمایش با علامت مثبت/منفی
                        const value = parseFloat(element.value);
                        const formatted = formatNumberWithCommas(Math.abs(value));
                        if (value >= 0) {
                            domElement.textContent = formatted;
                            domElement.style.color = '#28a745'; // سبز برای مثبت (اضافه پرداخت کرده)
                        } else {
                            domElement.textContent = '-' + formatted;
                            domElement.style.color = '#dc3545'; // قرمز برای منفی (باید بپردازد)
                        }
                    } else {
                        // برای مبالغ، فرمت عددی اعمال کنیم
                        domElement.textContent = formatNumberWithCommas(element.value);
                    }
                }
            });

            // اضافه کردن نشانگر "از سرور" برای نمایش منبع داده
            addServerDataIndicator();

            // بارگذاری داده‌های دوره فعلی (هزینه خالص فعلی و مانده صندوق فعلی)
            loadCurrentPeriodData();
        }

        // تابع بارگذاری داده‌های دوره فعلی
        async function loadCurrentPeriodData() {
            try {
                const response = await fetch('/api/v1/Period/period_summary/');
                if (!response.ok) {
                    console.warn('خطا در دریافت داده‌های دوره فعلی:', response.status);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success && result.current && result.current.current_cumulative_totals) {
                    const currentData = result.current.current_cumulative_totals;
                    
                    const formatNumber = (num) => {
                        return new Intl.NumberFormat('en-US').format(Math.round(num || 0));
                    };
                    
                    const currentFinalCostElement = document.getElementById('currentFinalCost');
                    if (currentFinalCostElement) {
                        currentFinalCostElement.textContent = formatNumber(currentData.final_cost);
                    }
                    
                    const currentBuildingFundBalanceElement = document.getElementById('currentBuildingFundBalance');
                    if (currentBuildingFundBalanceElement) {
                        currentBuildingFundBalanceElement.textContent = formatNumber(currentData.final_fund_balance);
                    }
                    
                    console.log('✅ داده‌های دوره فعلی بارگذاری شدند');
                } else {
                    console.warn('⚠️ داده‌های دوره فعلی یافت نشد');
                    document.getElementById('currentFinalCost').textContent = '0';
                    document.getElementById('currentBuildingFundBalance').textContent = '0';
                }
            } catch (error) {
                console.error('❌ خطا در بارگذاری داده‌های دوره فعلی:', error);
                document.getElementById('currentFinalCost').textContent = '-';
                document.getElementById('currentBuildingFundBalance').textContent = '-';
            }
        }


        // تابع اضافه کردن نشانگر داده‌های سرور
        function addServerDataIndicator() {
            // حذف نشانگر قبلی اگر وجود دارد
            const existingIndicator = document.querySelector('.server-data-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            // اضافه کردن نشانگر جدید
            const indicator = document.createElement('div');
            indicator.className = 'server-data-indicator';
            indicator.innerHTML = `
                <i class="fas fa-server"></i>
                <span>داده‌های محاسباتی از سرور</span>
            `;
            indicator.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: #d4edda;
                color: #155724;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 5px;
            `;

            document.body.appendChild(indicator);

            // حذف خودکار بعد از 5 ثانیه
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 5000);
        }

        // به‌روزرسانی اطلاعات کلی مشارکت کننده با داده‌های جدید از API
        async function updateInvestorInfoWithData(investorId, investorTransactions) {
            // فعال‌سازی دکمه گزارش PDF
            const pdfBtn = document.getElementById('pdfReportBtn');
            if (pdfBtn) {
                pdfBtn.href = `/dashboard/investor-pdf/?investor_id=${investorId}`;
                pdfBtn.style.display = 'inline-flex';
            }

            // بررسی کش: اگر اطلاعات قبلاً دریافت شده، از کش استفاده کن
            if (cachedInvestorData[investorId]) {
                console.log('✅ استفاده از کش برای مشارکت‌کننده', investorId);
                updateInvestorUI(cachedInvestorData[investorId]);
                return;
            }

            // دریافت یکباره اطلاعات مشارکت کننده (نام، تاریخ، واحدها)
            try {
                const response = await fetch(`/api/v1/Investor/${investorId}/`);
                const investorData = await response.json();
                
                // ذخیره در کش
                cachedInvestorData[investorId] = investorData;
                
                console.log('🔍 اطلاعات کامل مشارکت کننده:', investorData);
                console.log('🔍 واحدهای مشارکت کننده:', investorData.units);
                
                updateInvestorUI(investorData);
            } catch (error) {
                console.error('خطا در دریافت اطلاعات مشارکت کننده:', error);
                document.getElementById('investorName').textContent = 'نام نامشخص';
                document.getElementById('unitName').textContent = 'خطا در بارگذاری';
                document.getElementById('unitArea').textContent = '0';
            }
            
            // دریافت محاسبات از سرور
            await updateInvestorStatsFromServer(investorId, investorId);
        }
        
        // تابع کمکی برای به‌روزرسانی UI با اطلاعات مشارکت‌کننده
        function updateInvestorUI(investorData) {
            // به‌روزرسانی نام و تاریخ قرارداد
            const investorName = `${investorData.first_name} ${investorData.last_name}`;
            document.getElementById('investorName').textContent = investorName;
            
            // به‌روزرسانی نوع سرمایه‌گذار
            const investorTypeEl = document.getElementById('investorType');
            if (investorTypeEl && investorData.participation_type) {
                const typeLabels = {
                    'owner': '<i class="fas fa-building"></i> مالک',
                    'investor': '<i class="fas fa-hand-holding-usd"></i> سرمایه‌گذار'
                };
                investorTypeEl.innerHTML = typeLabels[investorData.participation_type] || investorData.participation_type;
                investorTypeEl.className = 'investor-type-badge ' + investorData.participation_type;
            }

            // تنظیم نمایش بخش اطلاعات واحد بر اساس نوع سرمایه‌گذار (سوئیچ پایدار با data-variant)
            const variant = investorData.participation_type === 'investor' ? 'investor' : 'owner';
            showVariant(variant);
            
            const contractDateEl = document.getElementById('contractDate');
            if (contractDateEl) {
                contractDateEl.textContent = investorData.contract_date_shamsi || '-';
            }
            
            // به‌روزرسانی اطلاعات واحدها
            if (investorData.units && investorData.units.length > 0) {
                const unitNames = investorData.units.map(unit => unit.name).join(', ');
                const totalArea = investorData.units.reduce((sum, unit) => sum + (parseFloat(unit.area) || 0), 0);
                
                document.getElementById('unitName').textContent = unitNames;
                document.getElementById('unitArea').textContent = totalArea.toLocaleString('en-US');
                
                console.log('🔍 نام واحدها:', unitNames);
                console.log('🔍 مساحت کل:', totalArea);
            } else {
                document.getElementById('unitName').textContent = 'هیچ واحدی یافت نشد';
                document.getElementById('unitArea').textContent = '0';
                console.warn('⚠️ هیچ واحدی برای مشارکت کننده یافت نشد');
            }
        }

        // سوئیچ پایدار بین حالت‌ها: owner | investor
        function showVariant(variant) {
            const unitSection = document.querySelector('.unit-section');
            if (!unitSection) return;
            const variantBlocks = unitSection.querySelectorAll('[data-variant]');
            variantBlocks.forEach(el => {
                const isMatch = el.getAttribute('data-variant') === variant;
                el.classList.toggle('is-active', isMatch);
            });
            const sectionTitle = unitSection.querySelector('.section-title');
            if (sectionTitle) {
                sectionTitle.innerHTML = variant === 'investor'
                    ? '<i class="fas fa-calculator"></i> مالکیت محاسبه شده'
                    : '<i class="fas fa-building"></i> اطلاعات واحد انتخاب شده';
            }
        }


        // پاک کردن نمودارهای قبلی
        function destroyCharts() {
            // پاک کردن نمودارهای Chart.js
            Object.keys(charts).forEach(chartName => {
                if (charts[chartName]) {
                    try {
                        charts[chartName].destroy();
                        charts[chartName] = null;
                    } catch (e) {
                        console.log('خطا در پاک کردن نمودار:', chartName, e);
                    }
                }
            });
            charts = {}; // پاک کردن object
        }

        // مخفی کردن پروفایل
        function hideInvestorProfile() {
            selectedInvestor = null;
            document.getElementById('investorInfo').classList.remove('show');
        }




        // نمودار توزیع فعالیت‌ها
        function createActivityDistributionChart(investorTransactions) {
            // داده‌های فیلتر شده از سرور استفاده می‌کنیم
            const principalData = investorTransactions.filter(row => ['principal_deposit','loan_deposit'].includes(row.entry_type));
            const withdrawalData = investorTransactions.filter(row => row.entry_type === 'principal_withdrawal');
            const profitData = investorTransactions.filter(row => row.entry_type === 'profit_accrual');

            const totalPrincipal = principalData.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);
            const totalWithdrawal = Math.abs(withdrawalData.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0));
            const totalProfit = profitData.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);

            const ctx = document.getElementById('activityDistributionChart').getContext('2d');
            charts.activityDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['آورده', 'برداشت', 'سود'],
                    datasets: [{
                        data: [totalPrincipal, totalWithdrawal, totalProfit].map(amount => amount / BASE_AMOUNT),
                        backgroundColor: [
                            '#2185d0', // آبی - آورده
                            '#db2828', // قرمز - برداشت
                            '#21ba45'  // سبز - سود مشارکت
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: projectName ? true : false,
                            text: projectName ? `پروژه: ${projectName}` : '',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            padding: {
                                bottom: 10
                            }
                        },
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + ' میلیون تومان';
                                }
                            }
                        }
                    }
                }
            });
        }

        // نمودار ترکیبی آورده و برداشت (میله‌ای + خطی)
        function createPrincipalTransactionChart(investorTransactions) {
            // فیلتر کردن تراکنش‌های آورده و برداشت
            const principalTransactions = investorTransactions.filter(row => 
                ['principal_deposit','loan_deposit','principal_withdrawal'].includes(row.entry_type)
            );
            
            // مرتب کردن بر اساس تاریخ
            principalTransactions.sort((a, b) => {
                if (a.date_shamsi && b.date_shamsi) {
                    return a.date_shamsi.localeCompare(b.date_shamsi);
                }
                return 0;
            });
            
            // آماده‌سازی داده‌ها برای نمودار
            const labels = [];
            const depositAmounts = [];
            const withdrawalAmounts = [];
            const cumulativeAmounts = []; // سرمایه موجود
            
            let cumulative = 0;
            
            principalTransactions.forEach(transaction => {
                const date = transaction.date_shamsi || 'نامعلوم';
                const amount = parseFloat(transaction.amount || 0);
                
                labels.push(date);
                
                if (['principal_deposit','loan_deposit'].includes(transaction.entry_type)) {
                    depositAmounts.push(amount / BASE_AMOUNT);
                    withdrawalAmounts.push(0);
                    cumulative += amount;
                } else { // principal_withdrawal
                    depositAmounts.push(0);
                    withdrawalAmounts.push(Math.abs(amount) / BASE_AMOUNT); // نمایش مثبت برای برداشت
                    cumulative += amount; // withdrawal معمولاً منفی است
                }
                
                cumulativeAmounts.push(cumulative / BASE_AMOUNT);
            });
            
            const ctx = document.getElementById('principalTransactionChart').getContext('2d');
            charts.principalTransactionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'آورده(میلیون تومان)',
                            data: depositAmounts,
                            backgroundColor: 'rgba(33, 133, 208, 0.8)', // آبی - آورده
                            borderColor: 'rgba(33, 133, 208, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            type: 'bar', 
                            label: 'برداشت (میلیون تومان)',
                            data: withdrawalAmounts,
                            backgroundColor: 'rgba(219, 40, 40, 0.8)', // قرمز - برداشت
                            borderColor: 'rgba(219, 40, 40, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'سرمایه موجود(میلیون تومان)',
                            data: cumulativeAmounts,
                            borderColor: 'rgba(170, 38, 255, 1)', // بنفش - سرمایه موجود
                            backgroundColor: 'rgba(170, 38, 255, 0.2)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: projectName ? `پروژه: ${projectName} - روند تراکنش‌های آورده و برداشت` : 'روند تراکنش‌های آورده و برداشت'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: { 
                                display: true, 
                                text: 'تاریخ' 
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: { 
                                display: true, 
                                text: 'مبلغ تراکنش (میلیون تومان)' 
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: false,
                            title: { 
                                display: true, 
                                text: 'سرمایه موجود (میلیون تومان)' 
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // نمودار ماهانه آورده و برداشت (بدون سود)
        function createMonthlyPrincipalChart(investorTransactions) {
            // فیلتر کردن فقط تراکنش‌های آورده و برداشت
            const principalTransactions = investorTransactions.filter(row => 
                ['principal_deposit','loan_deposit','principal_withdrawal'].includes(row.entry_type)
            );
            
            const monthlyData = {};
            principalTransactions.forEach(row => {
                if (row.date_shamsi) {
                    const month = row.date_shamsi.substring(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { principal: 0, withdrawal: 0 };
                    }
                    
                    const amount = parseFloat(row.amount || 0);
                    if (['principal_deposit','loan_deposit'].includes(row.entry_type)) {
                        monthlyData[month].principal += amount;
                    } else { // principal_withdrawal
                        monthlyData[month].withdrawal += amount;
                    }
                }
            });

            const months = Object.keys(monthlyData).sort();
            const principals = months.map(month => monthlyData[month].principal / BASE_AMOUNT);
            const withdrawals = months.map(month => Math.abs(monthlyData[month].withdrawal) / BASE_AMOUNT);
            
            // محاسبه سرمایه موجود فقط آورده و برداشت
            const cumulativePrincipalTotals = [];
            let cumulativeSum = 0;
            months.forEach(month => {
                const monthlyNet = monthlyData[month].principal + monthlyData[month].withdrawal;
                cumulativeSum += monthlyNet;
                cumulativePrincipalTotals.push(cumulativeSum / BASE_AMOUNT);
            });

            const ctx = document.getElementById('monthlyPrincipalChart').getContext('2d');
            charts.monthlyPrincipalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'آورده (میلیون تومان)',
                            data: principals,
                            backgroundColor: 'rgba(33, 133, 208, 0.8)', // آبی - آورده
                            borderColor: 'rgba(33, 133, 208, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            type: 'bar',
                            label: 'برداشت (میلیون تومان)',
                            data: withdrawals,
                            backgroundColor: 'rgba(219, 40, 40, 0.8)', // قرمز - برداشت
                            borderColor: 'rgba(219, 40, 40, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'سرمایه موجود (میلیون تومان)',
                            data: cumulativePrincipalTotals,
                            borderColor: 'rgba(170, 38, 255, 1)', // بنفش - سرمایه موجود
                            backgroundColor: 'rgba(170, 38, 255, 0.2)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: projectName ? `پروژه: ${projectName} - نمودار ماهانه اورده، برداشت و سرمایه موجود` : 'نمودار ماهانه اورده، برداشت و سرمایه موجود'
                        },
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: {
                            title: { 
                                display: true, 
                                text: 'ماه' 
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: { 
                                display: true, 
                                text: 'مبلغ ماهانه (میلیون تومان)' 
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: false,
                            title: { 
                                display: true, 
                                text: 'سرمایه موجود آورده (میلیون تومان)' 
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // نمودار ترند مشارکت کننده
        function createInvestorTrendChart(months, capitalData, unitCostData) {
            // پاک کردن نمودار قبلی
            if (charts.investorTrendChart) {
                charts.investorTrendChart.destroy();
                charts.investorTrendChart = null;
            }
            
            const ctx = document.getElementById('investorTrendChart').getContext('2d');
            
            // استفاده از همان فرمت نمودار ماهانه (شمسی)
            const labels = months; // ماه‌ها قبلاً در فرمت شمسی هستند
            
            charts.investorTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'line',
                            label: 'سرمایه موجود (میلیون تومان)',
                            data: capitalData,
                            borderColor: 'rgba(170, 38, 255, 1)', // بنفش - سرمایه موجود
                            backgroundColor: 'rgba(170, 38, 255, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'هزینه واحد (میلیون تومان)',
                            data: unitCostData,
                            borderColor: 'rgba(220, 53, 69, 1)', // قرمز - هزینه‌ها
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: projectName ? `پروژه: ${projectName} - ترند سرمایه موجود و هزینه واحد` : 'ترند سرمایه موجود و هزینه واحد'
                        },
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: {
                            title: { 
                                display: true, 
                                text: 'دوره' 
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: { 
                                display: true, 
                                text: 'سرمایه موجود (میلیون تومان)' 
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: { 
                                display: true, 
                                text: 'هزینه واحد (میلیون تومان)' 
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // بارگذاری داده‌های ترند مشارکت کننده از سرور
        async function loadInvestorTrendData(investorId, investorTransactions) {
            try {
                console.log('🔍 بارگذاری داده‌های ترند برای مشارکت کننده:', investorId);
                
                // دریافت داده‌های نمودار ترند از سرور
                const response = await fetch(`/api/v1/Investor/${investorId}/investor_cumulative_capital_and_unit_cost_chart/`);
                if (!response.ok) {
                    console.warn('⚠️ خطا در دریافت داده‌های نمودار ترند:', response.status);
                    return;
                }
                
                const trendData = await response.json();
                
                if (trendData.error) {
                    console.error('⚠️ خطا در محاسبه داده‌های نمودار ترند:', trendData.error);
                    return;
                }
                
                console.log('✅ داده‌های نمودار ترند از سرور دریافت شد');
                
                // استفاده از داده‌های سرور
                const allMonths = trendData.periods;
                const cumulativePrincipalTotals = trendData.cumulative_capital;
                const unitCostData = trendData.unit_cost;
                
                // ایجاد نمودار با داده‌های محاسبه شده
                createInvestorTrendChart(allMonths, cumulativePrincipalTotals, unitCostData);
                
            } catch (error) {
                console.error('❌ خطا در بارگذاری داده‌های ترند:', error);
            }
        }


        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        // بارگذاری داده‌ها هنگام لود صفحه
        window.addEventListener('load', function() {
            // Initialize theme
            initializeTheme();
            
            // Theme toggle event listener
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // دریافت نام پروژه
            fetchProjectName();
            
            populateInvestorSelect(); // بارگذاری لیست مشارکت کنندگان از دیتابیس
            // loadData() دیگر نیازی نیست چون داده‌ها به صورت فیلتر شده بارگذاری می‌شوند
            
            // مخفی کردن loading چون دیگر داده‌ای بارگذاری نمی‌کنیم
            document.getElementById('loading').style.display = 'none';

            // نمایش پیش‌فرض حالت مالک تا زمانی که نوع سرمایه‌گذار مشخص شود
            showVariant('owner');
        });
    </script>
</body>
</html>
