<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مالی پروژه آرشا</title>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 1rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-container h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 50px 0;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> داشبورد مالی پروژه آرشا</h1>
            <p>نمایش جامع وضعیت مالی و سرمایه‌گذاری</p>
            <div style="margin-top: 20px;">
                <a href="investor_profile.html" style="
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    padding: 12px 25px;
                    border-radius: 25px;
                    text-decoration: none;
                    font-weight: bold;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    transition: all 0.3s ease;
                    display: inline-block;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-user-tie"></i> مشاهده پروفایل سرمایه‌گذاران
                </a>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> در حال بارگذاری داده‌ها...
        </div>

        <div id="error" class="error" style="display: none;">
            خطا در بارگذاری داده‌ها
        </div>

        <div id="content" style="display: none;">
            <!-- آمار کلی -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <h3 id="totalInvestors">-</h3>
                    <p>کل سرمایه‌گذاران</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3 id="totalPrincipal">-</h3>
                    <p>سرمایه موجود (میلیون تومان)</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-pie"></i>
                    <h3 id="totalProfit">-</h3>
                    <p>کل سود (میلیون تومان)</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-alt"></i>
                    <h3 id="totalDays">-</h3>
                    <p>مدت زمان پروژه (روز)</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-play-circle"></i>
                    <h3 id="startDate">-</h3>
                    <p>تاریخ شروع پروژه</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-stop-circle"></i>
                    <h3 id="endDate">-</h3>
                    <p>آخرین فعالیت</p>
                </div>
            </div>

            <!-- نمودارها -->
            <div class="charts-grid">


                <div class="chart-container">
                    <h3><i class="fas fa-chart-pie"></i> توزیع سرمایه‌گذاران</h3>
                    <div class="chart-wrapper">
                        <canvas id="investorDistributionChart"></canvas>
                    </div>
                </div>





                <!-- ROI Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-percentage"></i> نرخ بازدهی کل پروژه (ROI)</h3>
                    <div class="chart-wrapper">
                        <canvas id="projectROIChart"></canvas>
                    </div>
                </div>

                <!-- Principal Transaction Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-line"></i> روند تراکنش‌های آورده و برداشت</h3>
                    <div class="chart-wrapper">
                        <canvas id="principalTransactionChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Comparison Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-bar"></i> مقایسه ماهانه کامل</h3>
                    <div class="chart-wrapper">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>

                <!-- Principal Trend Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-line"></i> روند تجمعی آورده</h3>
                    <div class="chart-wrapper">
                        <canvas id="principalTrendChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Principal Chart -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-area"></i> ماهانه آورده و برداشت</h3>
                    <div class="chart-wrapper">
                        <canvas id="monthlyPrincipalChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- جدول خلاصه -->
            <div class="table-container">
                <h3><i class="fas fa-table"></i> خلاصه سرمایه‌گذاران</h3>
                <div id="summaryTable"></div>
            </div>
        </div>
    </div>

    <script>
        let chartData = null;
        let charts = {};
        let allInvestors = [];
        let allProjects = [];

        // متغیر برای تبدیل مبالغ (10 میلیون)
        const BASE_AMOUNT = 10000000;

        // بارگذاری همه داده‌ها از API های مختلف
        async function loadData() {
            try {
                console.log('شروع بارگذاری داده‌ها از API...');
                
                // بارگذاری موازی همه داده‌ها
                const [transactionsResponse, investorsResponse, projectsResponse] = await Promise.all([
                    fetch('/construction/api/v1/Transaction/'),
                    fetch('/construction/api/v1/Investor/'),
                    fetch('/construction/api/v1/Project/').catch(err => {
                        console.warn('خطا در دسترسی به API پروژه‌ها:', err);
                        return { ok: false, status: 403 }; // fallback response
                    })
                ]);
                
                // بررسی وضعیت response ها
                if (!transactionsResponse.ok) {
                    throw new Error(`خطا در بارگذاری تراکنش‌ها: ${transactionsResponse.status}`);
                }
                if (!investorsResponse.ok) {
                    throw new Error(`خطا در بارگذاری سرمایه‌گذاران: ${investorsResponse.status}`);
                }
                
                // دریافت داده‌ها
                const transactions = await transactionsResponse.json();
                allInvestors = await investorsResponse.json();
                
                // اگر پروژه API دسترسی داشت، آن را بارگذاری کن
                if (projectsResponse.ok) {
                    allProjects = await projectsResponse.json();
                    console.log('پروژه‌ها بارگذاری شدند:', allProjects.length);
                } else {
                    console.warn('API پروژه‌ها دسترسی ندارد، از تراکنش‌ها تاریخ استفاده می‌شود');
                    allProjects = [];
                }
                
                console.log('داده‌ها بارگذاری شدند:', {
                    transactions: transactions.length,
                    investors: allInvestors.length,
                    projects: allProjects.length
                });
                
                // تبدیل تراکنش‌ها به فرمت سازگار
                chartData = transactions.map(transaction => ({
                    project_id: transaction.project?.id || '',
                    project_name: transaction.project?.name || '',
                    investor_name: transaction.investor?.name || '',
                    investor_id: transaction.investor?.id || '',
                    entry_type: transaction.transaction_type || '',
                    date_shamsi: transaction.date_shamsi || '',
                    date_miladi: transaction.date || '',
                    amount: parseFloat(transaction.amount) || 0,
                    period_name: transaction.period?.name || '',
                    description: transaction.description || ''
                })).filter(row => row.project_id && row.project_id.toString().trim() !== '');
                
                console.log('تراکنش‌های معتبر:', chartData.length);
                    
                    if (chartData.length === 0) {
                    showError('هیچ تراکنش معتبری یافت نشد');
                        return;
                    }
                    
                processData();
                
            } catch (error) {
                console.error('خطا در بارگذاری داده‌ها:', error);
                showError('خطا در بارگذاری داده‌ها: ' + error.message);
            }
        }

        function showError(message) {
            console.error('خطا:', message);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function processData() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            updateStats();
            createInvestorDistributionChart();
            
            // نمودارهای جدید از investor_profile
            createProjectROIChart();
            createProjectPrincipalTransactionChart();
            createProjectMonthlyComparisonChart();
            createProjectPrincipalTrendChart();
            createProjectMonthlyPrincipalChart();
            
            createSummaryTable();
        }

        function updateStats() {
            // 1. تعداد سرمایه‌گذاران از جدول Investor
            const totalInvestors = allInvestors.length;
            
            // 2. محاسبه سرمایه موجود (آورده - برداشت)
            const principalDeposits = chartData.filter(row => row.entry_type === 'principal_deposit');
            const principalWithdrawals = chartData.filter(row => row.entry_type === 'principal_withdrawal');
            
            const totalDeposits = principalDeposits.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);
            const totalWithdrawals = principalWithdrawals.reduce((sum, row) => sum + Math.abs(parseFloat(row.amount || 0)), 0);
            const currentCapital = totalDeposits - totalWithdrawals; // سرمایه موجود
            
            // 3. محاسبه سود از تراکنش‌ها  
            const profitData = chartData.filter(row => row.entry_type === 'profit_accrual');
            const totalProfit = profitData.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);
            
            // 4. تاریخ‌های تراکنش برای روزهای فعال
            const transactionDates = chartData.map(row => row.date_shamsi).filter(date => date);
            const uniqueDates = new Set(transactionDates);
            const sortedDates = [...transactionDates].sort();
            
            // 5. تاریخ شروع و پایان از فیلدهای پروژه
            let projectStartDate = '-';
            let projectEndDate = '-';
            let projectDuration = 0;
            
            if (allProjects.length > 0) {
                // اگر چند پروژه داریم، اولی را انتخاب می‌کنیم
                const mainProject = allProjects[0];
                projectStartDate = mainProject.start_date_shamsi || mainProject.start_date || '-';
                projectEndDate = mainProject.end_date_shamsi || mainProject.end_date || '-';
                
                // محاسبه تعداد روزهای پروژه
                if (projectStartDate !== '-' && projectEndDate !== '-') {
                    projectDuration = calculateDaysBetweenDates(projectStartDate, projectEndDate);
                }
            }
            
            // اگر تاریخ‌های پروژه موجود نبود، از تراکنش‌ها استفاده کن
            if (projectStartDate === '-' && sortedDates.length > 0) {
                projectStartDate = sortedDates[0];
            }
            if (projectEndDate === '-' && sortedDates.length > 0) {
                projectEndDate = sortedDates[sortedDates.length - 1];
            }
            
            // اگر هنوز محاسبه نشده، از تراکنش‌ها محاسبه کن
            if (projectDuration === 0 && projectStartDate !== '-' && projectEndDate !== '-') {
                projectDuration = calculateDaysBetweenDates(projectStartDate, projectEndDate);
            }

            // به‌روزرسانی المان‌های HTML
            document.getElementById('totalInvestors').textContent = totalInvestors.toLocaleString('fa-IR');
            document.getElementById('totalPrincipal').textContent = (currentCapital / BASE_AMOUNT).toFixed(1);
            document.getElementById('totalProfit').textContent = (totalProfit / BASE_AMOUNT).toFixed(1);
            document.getElementById('totalDays').textContent = projectDuration.toLocaleString('fa-IR');
            document.getElementById('startDate').textContent = projectStartDate;
            document.getElementById('endDate').textContent = projectEndDate === '-' ? 'ادامه دارد' : projectEndDate;

            console.log('آمار محاسبه شده:', {
                totalInvestors: totalInvestors,
                totalDeposits: (totalDeposits / BASE_AMOUNT).toFixed(1) + ' میلیون',
                totalWithdrawals: (totalWithdrawals / BASE_AMOUNT).toFixed(1) + ' میلیون',
                currentCapital: (currentCapital / BASE_AMOUNT).toFixed(1) + ' میلیون',
                totalProfit: (totalProfit / BASE_AMOUNT).toFixed(1) + ' میلیون',
                projectDuration: projectDuration + ' روز',
                projectStartDate: projectStartDate,
                projectEndDate: projectEndDate,
                uniqueTransactionDays: uniqueDates.size
            });
        }

        // تابع محاسبه تعداد روز بین دو تاریخ شمسی
        function calculateDaysBetweenDates(startDate, endDate) {
            try {
                // اگر تاریخ‌ها به فرمت شمسی هستند (مثل 1403/05/15)
                if (startDate.includes('/') && endDate.includes('/')) {
                    const [startYear, startMonth, startDay] = startDate.split('/').map(Number);
                    const [endYear, endMonth, endDay] = endDate.split('/').map(Number);
                    
                    // تبدیل ساده (تقریبی) - برای دقت بیشتر باید از کتابخانه تبدیل تاریخ استفاده کرد
                    const startTotalDays = startYear * 365 + startMonth * 30 + startDay;
                    const endTotalDays = endYear * 365 + endMonth * 30 + endDay;
                    
                    return Math.max(0, endTotalDays - startTotalDays);
                }
                
                // اگر تاریخ‌ها میلادی هستند
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (!isNaN(start) && !isNaN(end)) {
                    const diffTime = Math.abs(end - start);
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }
                
                return 0;
            } catch (error) {
                console.warn('خطا در محاسبه تعداد روز:', error);
                return 0;
            }
        }



        function createInvestorDistributionChart() {
            const principalData = chartData.filter(row => row.entry_type === 'principal_deposit' && row.investor_name !== '_src_row_index');
            const withdrawalData = chartData.filter(row => row.entry_type === 'principal_withdrawal' && row.investor_name !== '_src_row_index');
            const investorAmounts = {};
            
            // محاسبه آورده خالص هر سرمایه‌گذار
            principalData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorAmounts[investor]) {
                        investorAmounts[investor] = 0;
                    }
                    investorAmounts[investor] += parseFloat(row.amount || 0);
                }
            });
            
            // کم کردن برداشت‌ها
            withdrawalData.forEach(row => {
                const investor = row.investor_name;
                if (investor && investorAmounts[investor] !== undefined) {
                    investorAmounts[investor] += parseFloat(row.amount || 0); // withdrawal معمولاً منفی است
                }
            });

            // حذف سرمایه‌گذارانی که آورده خالص منفی دارند
            const validInvestors = Object.entries(investorAmounts)
                .filter(([investor, amount]) => amount > 0)
                .reduce((obj, [investor, amount]) => {
                    obj[investor] = amount;
                    return obj;
                }, {});

            const labels = Object.keys(validInvestors);
            const data = Object.values(validInvestors).map(amount => amount / BASE_AMOUNT); // تبدیل به میلیون تومان

            const ctx = document.getElementById('investorDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + ' میلیون تومان';
                                }
                            }
                        }
                    }
                }
            });
        }





        function createSummaryTable() {
            const principalData = chartData.filter(row => row.entry_type === 'principal_deposit' && row.investor_name !== '_src_row_index');
            const withdrawalData = chartData.filter(row => row.entry_type === 'principal_withdrawal' && row.investor_name !== '_src_row_index');
            const profitData = chartData.filter(row => row.entry_type === 'profit_accrual' && row.investor_name !== '_src_row_index');
            
            const investorSummary = {};
            
            // محاسبه آورده خالص هر سرمایه‌گذار
            principalData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorSummary[investor]) {
                        investorSummary[investor] = { principal: 0, withdrawal: 0, profit: 0 };
                    }
                    investorSummary[investor].principal += parseFloat(row.amount || 0);
                }
            });
            
            // محاسبه برداشت‌ها
            withdrawalData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorSummary[investor]) {
                        investorSummary[investor] = { principal: 0, withdrawal: 0, profit: 0 };
                    }
                    investorSummary[investor].withdrawal += parseFloat(row.amount || 0);
                }
            });
            
            profitData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorSummary[investor]) {
                        investorSummary[investor] = { principal: 0, withdrawal: 0, profit: 0 };
                    }
                    investorSummary[investor].profit += parseFloat(row.amount || 0);
                }
            });

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>نام سرمایه‌گذار</th>
                            <th>آورده (تومان)</th>
                            <th>برداشت (تومان)</th>
                            <th>آورده خالص (تومان)</th>
                            <th>سود (تومان)</th>
                            <th>مجموع (تومان)</th>
                            <th>نسبت سود به آورده خالص</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(investorSummary).forEach(([investor, data]) => {
                const netPrincipal = data.principal + data.withdrawal; // withdrawal معمولاً منفی است
                const total = netPrincipal + data.profit;
                const profitRatio = netPrincipal > 0 ? ((data.profit / netPrincipal) * 100).toFixed(2) : '0.00';
                
                // فقط سرمایه‌گذارانی که آورده خالص مثبت دارند
                if (netPrincipal > 0) {
                    tableHTML += `
                        <tr>
                            <td>${investor}</td>
                            <td>${data.principal.toLocaleString('fa-IR')}</td>
                            <td>${data.withdrawal.toLocaleString('fa-IR')}</td>
                            <td>${netPrincipal.toLocaleString('fa-IR')}</td>
                            <td>${data.profit.toLocaleString('fa-IR')}</td>
                            <td>${total.toLocaleString('fa-IR')}</td>
                            <td>${profitRatio}%</td>
                        </tr>
                    `;
                }
            });

            tableHTML += '</tbody></table>';
            document.getElementById('summaryTable').innerHTML = tableHTML;
        }



        // نمودارهای جدید برای کل پروژه (مشابه investor_profile)
        
        function createProjectROIChart() {
            // گروه‌بندی تراکنش‌ها بر اساس ماه برای کل پروژه
            const monthlyData = {};
            chartData.forEach(row => {
                if (row.date_shamsi) {
                    const month = row.date_shamsi.substring(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { principal: 0, profit: 0 };
                    }
                    
                    const amount = parseFloat(row.amount || 0);
                    if (row.entry_type === 'principal_deposit') {
                        monthlyData[month].principal += amount;
                    } else if (row.entry_type === 'principal_withdrawal') {
                        monthlyData[month].principal += amount; // withdrawal معمولاً منفی است
                    } else if (row.entry_type === 'profit_accrual') {
                        monthlyData[month].profit += amount;
                    }
                }
            });

            const months = Object.keys(monthlyData).sort();
            
            // محاسبه ROI تجمعی برای هر ماه
            const roiData = [];
            const monthLabels = [];
            let cumulativePrincipal = 0;
            let cumulativeProfit = 0;
            
            months.forEach(month => {
                cumulativePrincipal += monthlyData[month].principal;
                cumulativeProfit += monthlyData[month].profit;
                
                // محاسبه ROI فقط اگر سرمایه مثبت باشد
                let roi = 0;
                if (cumulativePrincipal > 0) {
                    roi = (cumulativeProfit / cumulativePrincipal) * 100;
                }
                
                roiData.push(roi);
                monthLabels.push(month);
            });

            const ctx = document.getElementById('projectROIChart').getContext('2d');
            charts.projectROIChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'نرخ بازدهی تجمعی (%)',
                            data: roiData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'نرخ بازدهی کل پروژه در طول زمان'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'نرخ بازدهی (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ماه'
                            }
                        }
                    }
                }
            });
        }

        function createProjectPrincipalTransactionChart() {
            // فیلتر تراکنش‌های آورده و برداشت
            const transactions = chartData.filter(row => 
                row.entry_type === 'principal_deposit' || row.entry_type === 'principal_withdrawal'
            );

            // مرتب‌سازی بر اساس تاریخ
            const sortedTransactions = transactions.sort((a, b) => a.date_shamsi.localeCompare(b.date_shamsi));

            const labels = [];
            const barData = [];
            const lineData = [];
            let cumulative = 0;

            sortedTransactions.forEach(transaction => {
                const amount = parseFloat(transaction.amount || 0);
                cumulative += amount;
                
                labels.push(transaction.date_shamsi);
                barData.push(amount / BASE_AMOUNT); // تبدیل به میلیون تومان
                lineData.push(cumulative / BASE_AMOUNT);
            });

            const ctx = document.getElementById('principalTransactionChart').getContext('2d');
            charts.principalTransactionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'مبلغ تراکنش (میلیون تومان)',
                            data: barData,
                            backgroundColor: barData.map(value => 
                                value >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'
                            ),
                            borderColor: barData.map(value => 
                                value >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'
                            ),
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            label: 'مجموع تجمعی (میلیون تومان)',
                            data: lineData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'روند تراکنش‌های آورده و برداشت کل پروژه'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'مبلغ تراکنش (میلیون تومان)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'مجموع تجمعی (میلیون تومان)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function createProjectMonthlyComparisonChart() {
            // گروه‌بندی بر اساس ماه
            const monthlyData = {};
            
            chartData.forEach(row => {
                if (row.date_shamsi) {
                    const month = row.date_shamsi.substring(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { principal: 0, withdrawal: 0, profit: 0 };
                    }
                    
                    const amount = parseFloat(row.amount || 0);
                    if (row.entry_type === 'principal_deposit') {
                        monthlyData[month].principal += amount;
                    } else if (row.entry_type === 'principal_withdrawal') {
                        monthlyData[month].withdrawal += Math.abs(amount);
                    } else if (row.entry_type === 'profit_accrual') {
                        monthlyData[month].profit += amount;
                    }
                }
            });

            const months = Object.keys(monthlyData).sort();
            const principalData = months.map(month => monthlyData[month].principal / BASE_AMOUNT);
            const withdrawalData = months.map(month => -monthlyData[month].withdrawal / BASE_AMOUNT);
            const profitData = months.map(month => monthlyData[month].profit / BASE_AMOUNT);
            
            // محاسبه خط ترند تجمعی
            const cumulativeData = [];
            let cumulative = 0;
            months.forEach(month => {
                const netMonthly = monthlyData[month].principal - monthlyData[month].withdrawal + monthlyData[month].profit;
                cumulative += netMonthly;
                cumulativeData.push(cumulative / BASE_AMOUNT);
            });

            const ctx = document.getElementById('monthlyComparisonChart').getContext('2d');
            charts.monthlyComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'آورده (میلیون تومان)',
                            data: principalData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            type: 'bar',
                            label: 'برداشت (میلیون تومان)',
                            data: withdrawalData,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            type: 'bar',
                            label: 'سود (میلیون تومان)',
                            data: profitData,
                            backgroundColor: 'rgba(255, 206, 86, 0.6)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            label: 'ترند تجمعی (میلیون تومان)',
                            data: cumulativeData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'مقایسه ماهانه کل پروژه با ترند تجمعی'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'مبلغ ماهانه (میلیون تومان)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'مجموع تجمعی (میلیون تومان)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function createProjectPrincipalTrendChart() {
            // فیلتر تراکنش‌های آورده و برداشت
            const transactions = chartData.filter(row => 
                row.entry_type === 'principal_deposit' || row.entry_type === 'principal_withdrawal'
            );

            // مرتب‌سازی بر اساس تاریخ
            const sortedTransactions = transactions.sort((a, b) => a.date_shamsi.localeCompare(b.date_shamsi));

            const labels = [];
            const data = [];
            let cumulative = 0;

            sortedTransactions.forEach(transaction => {
                const amount = parseFloat(transaction.amount || 0);
                cumulative += amount;
                
                labels.push(transaction.date_shamsi);
                data.push(cumulative / BASE_AMOUNT);
            });

            const ctx = document.getElementById('principalTrendChart').getContext('2d');
            charts.principalTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'مجموع تجمعی آورده (میلیون تومان)',
                        data: data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'روند تجمعی آورده کل پروژه'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'مبلغ تجمعی (میلیون تومان)'
                            }
                        }
                    }
                }
            });
        }

        function createProjectMonthlyPrincipalChart() {
            // گروه‌بندی بر اساس ماه (فقط آورده و برداشت، بدون سود)
            const monthlyData = {};
            
            chartData.forEach(row => {
                if (row.date_shamsi && (row.entry_type === 'principal_deposit' || row.entry_type === 'principal_withdrawal')) {
                    const month = row.date_shamsi.substring(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { principal: 0, withdrawal: 0 };
                    }
                    
                    const amount = parseFloat(row.amount || 0);
                    if (row.entry_type === 'principal_deposit') {
                        monthlyData[month].principal += amount;
                    } else if (row.entry_type === 'principal_withdrawal') {
                        monthlyData[month].withdrawal += Math.abs(amount);
                    }
                }
            });

            const months = Object.keys(monthlyData).sort();
            const principalData = months.map(month => monthlyData[month].principal / BASE_AMOUNT);
            const withdrawalData = months.map(month => -monthlyData[month].withdrawal / BASE_AMOUNT);
            
            // محاسبه خط ترند تجمعی (بدون سود)
            const cumulativeData = [];
            let cumulative = 0;
            months.forEach(month => {
                const netMonthly = monthlyData[month].principal - monthlyData[month].withdrawal;
                cumulative += netMonthly;
                cumulativeData.push(cumulative / BASE_AMOUNT);
            });

            const ctx = document.getElementById('monthlyPrincipalChart').getContext('2d');
            charts.monthlyPrincipalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'آورده ماهانه (میلیون تومان)',
                            data: principalData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            type: 'bar',
                            label: 'برداشت ماهانه (میلیون تومان)',
                            data: withdrawalData,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            type: 'line',
                            label: 'ترند تجمعی آورده (میلیون تومان)',
                            data: cumulativeData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ماهانه آورده و برداشت کل پروژه (بدون سود)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'مبلغ ماهانه (میلیون تومان)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'مجموع تجمعی (میلیون تومان)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
                });
        }

        // بررسی بارگذاری Chart.js
        function checkChartJS() {
            if (typeof Chart === 'undefined') {
                showError('Chart.js بارگذاری نشده است. لطفاً صفحه را refresh کنید.');
                return false;
            }
            console.log('Chart.js با موفقیت بارگذاری شد');
            return true;
        }

        // بارگذاری داده‌ها هنگام لود صفحه
        window.addEventListener('load', function() {
            if (checkChartJS()) {
                loadData();
            }
        });
    </script>
</body>
</html>
