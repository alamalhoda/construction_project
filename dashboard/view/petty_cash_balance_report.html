<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گزارش وضعیت مالی تنخواه</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Vazir Font CSS -->
    <link rel="stylesheet" href="/static/fonts/vazir.css">
    
    <!-- Project Switcher CSS -->
    <link rel="stylesheet" href="/static/css/project-switcher.css">
    
    <!-- Dashboard Common CSS -->
    <link rel="stylesheet" href="/static/css/dashboard-common.css">
    
    <style>
        /* استایل‌های خاص این صفحه - استایل‌های مشترک در dashboard-common.css هستند */

        .content-section {
            padding: 30px;
            background: var(--bg-card);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        /* خط جداکننده بین کارت‌های خلاصه و کارت‌های وضعیت عامل‌ها */
        .summary-divider {
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, var(--border-color) 20%, var(--border-color) 80%, transparent 100%);
            margin: 40px 0;
            border: none;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.positive {
            background: linear-gradient(135deg, var(--withdrawal-color) 0%, #b71c1c 100%);
            box-shadow: 0 12px 40px var(--withdrawal-color-light);
        }

        .stat-card.negative {
            background: linear-gradient(135deg, var(--profit-color) 0%, #1b8e3a 100%);
            box-shadow: 0 12px 40px var(--profit-color-light);
        }

        .stat-card.zero {
            background: linear-gradient(135deg, var(--balance-color) 0%, #495057 100%);
            box-shadow: 0 12px 40px var(--balance-color-light);
        }

        /* کارت‌های خلاصه */
        .stat-card.summary-received {
            background: linear-gradient(135deg, var(--petty-cash-received-color) 0%, #1a6ba8 100%);
            box-shadow: 0 12px 40px var(--petty-cash-received-color-light);
        }

        .stat-card.summary-returned {
            background: linear-gradient(135deg, var(--petty-cash-returned-color) 0%, #e67e22 100%);
            box-shadow: 0 12px 40px var(--petty-cash-returned-color-light);
        }

        .stat-card.summary-expense {
            color: #b71c1c;
            background: linear-gradient(135deg, #f6f6f6 0%, #f6f6f6 100%);
            box-shadow: 0 12px 40px #b71c1c;
        }
        
        .stat-card.summary-expense .stat-number,
        .stat-card.summary-expense p,
        .stat-card.summary-expense small,
        .stat-card.summary-expense i {
            color: #b71c1c;
        }

        .stat-card.summary-balance {
            background: linear-gradient(135deg, var(--balance-color) 0%, #495057 100%);
            box-shadow: 0 12px 40px var(--balance-color-light);
        }

        .stat-card.summary-balance-positive {
            background: linear-gradient(135deg, var(--withdrawal-color) 0%, #b71c1c 100%);
            box-shadow: 0 12px 40px var(--withdrawal-color-light);
        }

        .stat-card.summary-balance-negative {
            background: linear-gradient(135deg, var(--profit-color) 0%, #1b8e3a 100%);
            box-shadow: 0 12px 40px var(--profit-color-light);
        }

        .stat-card.summary-balance-zero {
            background: linear-gradient(135deg, var(--balance-color) 0%, #495057 100%);
            box-shadow: 0 12px 40px var(--balance-color-light);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            direction: ltr;
        }

        .balance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .balance-table th,
        .balance-table td {
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .balance-table th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            font-weight: 600;
        }

        .balance-table td {
            background: var(--bg-secondary);
        }

        .balance-table tr:hover td {
            background: var(--bg-primary);
        }

        .balance-positive {
            color: var(--withdrawal-color);
            font-weight: bold;
        }

        .balance-negative {
            color: var(--profit-color);
            font-weight: bold;
        }

        .balance-zero {
            color: var(--balance-color);
            font-weight: bold;
        }

        .chart-container {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .chart-container h3 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        /* Header نمودار با دکمه دانلود */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .chart-header h3 {
            margin: 0;
            flex: 1;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .unified-header h1 {
                font-size: 2.2rem;
                flex-direction: column;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="unified-header">
            <div class="project-switcher-container">
                <div id="projectSwitcherContainer"></div>
            </div>
            <div class="unified-header-content">
                <h1>
                    <i class="fas fa-chart-pie"></i>
                    گزارش مانده تنخواه

                </h1>
                <p class="subtitle">وضعیت مالی همه عوامل اجرایی</p>
                <div class="navigation-links">
                    <a href="/user-dashboard/" class="nav-link">
                        <i class="fas fa-home"></i> صفحه اصلی
                    </a>
                    <a href="/dashboard/petty-cash/" class="nav-link">
                        <i class="fas fa-wallet"></i> مدیریت تراکنش‌های تنخواه
                    </a>
                    <a href="/dashboard/petty-cash/period/" class="nav-link">
                        <i class="fas fa-calendar-alt"></i> گزارش دوره‌ای تنخواه
                    </a>
                </div>
            </div>
        </div>

        <div id="noProjectWarning" style="display: none; margin: 20px; padding: 20px; border-radius: 10px; background: #fff3cd; border: 2px solid #ffc107; color: #856404;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>هشدار:</strong> هیچ پروژه فعالی یافت نشد.
        </div>

        <div class="content-section">
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p>در حال بارگذاری داده‌ها...</p>
            </div>

            <div id="content" style="display: none;">
                <div class="stats-grid" id="summaryStatsGrid"></div>
                <hr class="summary-divider">
                <div class="stats-grid" id="statsGrid"></div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-bar"></i> نمودار وضعیت مالی</h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>

                <div style="background: var(--bg-secondary); padding: 25px; border-radius: 15px; box-shadow: var(--shadow-md);">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-table"></i> جدول خلاصه وضعیت مالی</h3>
                    <div class="table-responsive">
                        <table class="balance-table">
                            <thead>
                                <tr>
                                    <th>عامل اجرایی</th>
                                    <th style="background-color: var(--petty-cash-received-color-light); border-left: 3px solid var(--petty-cash-received-color);">
                                        <i class="fas fa-plus-circle"></i> مجموع دریافت‌ها
                                    </th>
                                    <th style="background-color: var(--expense-color-light); border-left: 3px solid var(--expense-color);">
                                        <i class="fas fa-receipt"></i> مجموع هزینه‌ها
                                    </th>
                                    <th style="background-color: var(--petty-cash-returned-color-light); border-left: 3px solid var(--petty-cash-returned-color);">
                                        <i class="fas fa-minus-circle"></i> مجموع عودت‌ها
                                    </th>
                                    <th style="background-color: var(--balance-color-light); border-left: 3px solid var(--balance-color);">
                                        <i class="fas fa-balance-scale"></i> وضعیت بستانکاری/بدهکاری
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="balanceTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تنظیم فونت پیش‌فرض Chart.js به Vazir
        Chart.defaults.font.family = "'Vazir', 'Tahoma', 'Arial', sans-serif";
        Chart.defaults.font.size = 12;
        
        // تنظیمات اضافی برای نمودارها
        Chart.defaults.plugins.legend.labels.font = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 13
        };
        Chart.defaults.plugins.tooltip.titleFont = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 14
        };
        Chart.defaults.plugins.tooltip.bodyFont = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 12
        };
        Chart.defaults.scales.category.ticks.font = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 11
        };
        Chart.defaults.scales.linear.ticks.font = {
            family: "'Vazir', 'Tahoma', 'Arial', sans-serif",
            size: 11
        };

        const API_BASE = '/api/v1/';
        let balanceChart = null;
        let projectName = '';

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // متغیر global برای CSRF token
        let csrfToken = null;
        // Promise برای جلوگیری از race condition در دریافت همزمان
        let csrfTokenPromise = null;

        // تابع دریافت CSRF token (بهبود یافته با Promise-based locking)
        async function getCSRFToken() {
            // اگر قبلاً دریافت شده، آن را برگردان
            if (csrfToken) {
                return csrfToken;
            }
            
            // اگر یک Promise در حال انجام است، منتظر آن بمان
            if (csrfTokenPromise) {
                return await csrfTokenPromise;
            }
            
            // ایجاد Promise جدید برای دریافت token
            csrfTokenPromise = (async () => {
                try {
                    // ابتدا از window.csrfToken بررسی کن (از سرور)
                    if (window.csrfToken) {
                        csrfToken = window.csrfToken;
                        return csrfToken;
                    }
                    
                    // سپس از cookie بررسی کن
                    const cookieToken = getCookie('csrftoken');
                    if (cookieToken) {
                        csrfToken = cookieToken;
                        return csrfToken;
                    }
                    
                    // اگر هیچکدام موجود نبود، از API endpoint دریافت کن
                    const response = await fetch('/api/v1/auth/csrf/', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.csrf_token) {
                            csrfToken = data.csrf_token;
                            return csrfToken;
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('خطا در دریافت CSRF token:', error);
                    return null;
                } finally {
                    // پاک کردن Promise بعد از اتمام (برای امکان retry در صورت خطا)
                    csrfTokenPromise = null;
                }
            })();
            
            // منتظر ماندن برای نتیجه Promise
            return await csrfTokenPromise;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(Math.round(num));
        }

        async function loadBalanceData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('content').style.display = 'none';

                // دریافت CSRF token
                const csrfToken = await getCSRFToken();
                if (!csrfToken) {
                    console.error('CSRF Token یافت نشد');
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                // دریافت نام پروژه جاری
                try {
                    const projectResponse = await fetch(`${API_BASE}Project/current/`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'include'
                    });
                    
                    if (projectResponse.ok) {
                        const projectData = await projectResponse.json();
                        projectName = projectData.name || '';
                        console.log('✅ نام پروژه دریافت شد:', projectName);
                    }
                } catch (error) {
                    console.warn('⚠️ خطا در دریافت نام پروژه:', error);
                    projectName = '';
                }

                const response = await fetch(`${API_BASE}PettyCashTransaction/balances/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('خطا در دریافت داده‌ها');
                }

                const result = await response.json();
                if (result.success) {
                    displayBalanceData(result.data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                } else {
                    throw new Error(result.error || 'خطا در دریافت داده‌ها');
                }
            } catch (error) {
                console.error('Error loading balance data:', error);
                document.getElementById('loading').innerHTML = 
                    `<i class="fas fa-exclamation-triangle fa-3x"></i><p>خطا: ${error.message}</p>`;
            }
        }

        function displayBalanceData(data) {
            const summaryStatsGrid = document.getElementById('summaryStatsGrid');
            const statsGrid = document.getElementById('statsGrid');
            const tableBody = document.getElementById('balanceTableBody');
            
            summaryStatsGrid.innerHTML = '';
            statsGrid.innerHTML = '';
            tableBody.innerHTML = '';

            // دریافت داده‌ها از ساختار جدید
            const expenses = data.expenses || data; // سازگاری با ساختار قدیمی
            const summary = data.summary || null;

            // استفاده از مجموع‌های محاسبه شده در سمت سرور (اگر موجود باشد)
            let totalReceipts = 0;
            let totalReturns = 0;
            let totalExpenses = 0;
            let totalBalance = 0;

            if (summary) {
                // استفاده از مجموع‌های محاسبه شده در سمت سرور
                totalReceipts = summary.total_receipts || 0;
                totalReturns = summary.total_returns || 0;
                totalExpenses = summary.total_expenses || 0;
                totalBalance = summary.total_balance || 0;
            } else {
                // Fallback: محاسبه در کلاینت (برای سازگاری با ساختار قدیمی)
                for (const [expenseType, info] of Object.entries(expenses)) {
                    totalReceipts += info.total_receipts || 0;
                    totalReturns += info.total_returns || 0;
                    totalExpenses += info.total_expenses || 0;
                    totalBalance += info.balance || 0;
                }
            }

            // ایجاد کارت‌های خلاصه
            // 1. کارت مجموع تنخواه
            const receivedCard = document.createElement('div');
            receivedCard.className = 'stat-card summary-received';
            receivedCard.innerHTML = `
                <i class="fas fa-hand-holding-usd fa-2x"></i>
                <div class="stat-number">${formatNumber(totalReceipts)}</div>
                <p style="margin-bottom: 10px;">مجموع تنخواه</p>
                <small style="opacity: 0.9;">کل دریافت‌های تنخواه</small>
            `;
            summaryStatsGrid.appendChild(receivedCard);

            // 2. کارت مجموع عودت تنخواه
            const returnedCard = document.createElement('div');
            returnedCard.className = 'stat-card summary-returned';
            returnedCard.innerHTML = `
                <i class="fas fa-undo-alt fa-2x"></i>
                <div class="stat-number">${formatNumber(totalReturns)}</div>
                <p style="margin-bottom: 10px;">مجموع عودت تنخواه</p>
                <small style="opacity: 0.9;">کل عودت‌های تنخواه</small>
            `;
            summaryStatsGrid.appendChild(returnedCard);

            // 3. کارت مجموع هزینه
            const expenseCard = document.createElement('div');
            expenseCard.className = 'stat-card summary-expense';
            expenseCard.innerHTML = `
                <i class="fas fa-receipt fa-2x"></i>
                <div class="stat-number">${formatNumber(totalExpenses)}</div>
                <p style="margin-bottom: 10px;">مجموع هزینه</p>
                <small style="opacity: 0.9;">کل هزینه‌های انجام شده</small>
            `;
            summaryStatsGrid.appendChild(expenseCard);

            // 4. کارت مجموع مانده تنخواه
            const balanceCard = document.createElement('div');
            const balancePositive = totalBalance > 0;
            const balanceNegative = totalBalance < 0;
            const balanceZero = totalBalance === 0;
            
            let balanceCardClass = 'summary-balance-zero';
            let balanceIcon = 'fa-balance-scale';
            let balanceStatus = 'تسویه شده';
            
            if (balancePositive) {
                balanceCardClass = 'summary-balance-positive';
                balanceIcon = 'fa-exclamation-circle';
                balanceStatus = 'بدهکار';
            } else if (balanceNegative) {
                balanceCardClass = 'summary-balance-negative';
                balanceIcon = 'fa-check-circle';
                balanceStatus = 'بستانکار';
            }
            
            const balanceSign = balancePositive ? '+' : '';
            
            balanceCard.className = `stat-card ${balanceCardClass}`;
            balanceCard.innerHTML = `
                <i class="fas ${balanceIcon} fa-2x"></i>
                <div class="stat-number">${balanceSign}${formatNumber(Math.abs(totalBalance))}</div>
                <p style="margin-bottom: 10px;">مجموع مانده تنخواه</p>
                <small style="opacity: 0.9;">${balanceStatus}</small>
            `;
            summaryStatsGrid.appendChild(balanceCard);

            const chartLabels = [];
            const chartBalances = [];
            const chartColors = [];

            for (const [expenseType, info] of Object.entries(expenses)) {
                const balance = info.balance;
                const isPositive = balance > 0;
                const isNegative = balance < 0;
                const isZero = balance === 0;

                // Create stat card
                const card = document.createElement('div');
                card.className = `stat-card ${isPositive ? 'positive' : isNegative ? 'negative' : 'zero'}`;
                card.innerHTML = `
                    <i class="fas ${isPositive ? 'fa-exclamation-circle' : isNegative ? 'fa-check-circle' : 'fa-balance-scale'} fa-2x"></i>
                    <div class="stat-number">${formatNumber(Math.abs(balance))}</div>
                    <p style="margin-bottom: 10px;">${info.label}</p>
                    <small style="opacity: 0.9;">
                        ${isPositive ? 'بدهکار' : isNegative ? 'بستانکار' : 'تسویه شده'}
                    </small>
                `;
                statsGrid.appendChild(card);

                // Add to table
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${info.label}</strong></td>
                    <td class="number-format">${formatNumber(info.total_receipts)}</td>
                    <td class="number-format">${formatNumber(info.total_expenses)}</td>
                    <td class="number-format">${formatNumber(info.total_returns)}</td>
                    <td class="number-format ${isPositive ? 'balance-positive' : isNegative ? 'balance-negative' : 'balance-zero'}">
                        ${formatNumber(Math.abs(balance))}
                    </td>
                `;
                tableBody.appendChild(row);

                // Add to chart data
                chartLabels.push(info.label);
                chartBalances.push(balance);
                chartColors.push(isPositive ? 'var(--withdrawal-color)' : isNegative ? 'var(--profit-color)' : 'var(--balance-color)');
            }

            // Create chart
            createBalanceChart(chartLabels, chartBalances, chartColors);
        }

        function createBalanceChart(labels, balances, colors) {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            
            if (balanceChart) {
                balanceChart.destroy();
            }

            // تبدیل CSS Variables به مقادیر واقعی رنگ
            function getComputedColor(cssVar) {
                const root = document.documentElement;
                // تبدیل 'var(--color-name)' به '--color-name'
                const varName = cssVar.replace(/var\(|\)/g, '').trim();
                return getComputedStyle(root).getPropertyValue(varName).trim();
            }

            const computedColors = colors.map(color => {
                if (color.startsWith('var(')) {
                    return getComputedColor(color);
                }
                return color;
            });

            balanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'وضعیت مالی (تومان)',
                        data: balances,
                        backgroundColor: computedColors,
                        borderColor: computedColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: projectName ? `پروژه: ${projectName} - وضعیت مالی عوامل اجرایی` : 'وضعیت مالی عوامل اجرایی'
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const formatted = formatNumber(Math.abs(value));
                                    const sign = value >= 0 ? '+' : '';
                                    return `${sign}${formatted} تومان`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'مبلغ (تومان)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            },
                            grid: {
                                color: function(context) {
                                    // خط صفر را پررنگ‌تر نشان بده
                                    if (context.tick.value === 0) {
                                        return '#333333';
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadBalanceData();
        });
    </script>
    
    <script src="/static/js/project-switcher.js"></script>
</body>
</html>

