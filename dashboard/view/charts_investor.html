<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مالی پروژه آرشا</title>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 1rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-container h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 50px 0;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> داشبورد مالی پروژه آرشا</h1>
            <p>نمایش جامع وضعیت مالی و سرمایه‌گذاری</p>
            <div style="margin-top: 20px;">
                <a href="investor_profile.html" style="
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    padding: 12px 25px;
                    border-radius: 25px;
                    text-decoration: none;
                    font-weight: bold;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    transition: all 0.3s ease;
                    display: inline-block;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-user-tie"></i> مشاهده پروفایل سرمایه‌گذاران
                </a>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> در حال بارگذاری داده‌ها...
        </div>

        <div id="error" class="error" style="display: none;">
            خطا در بارگذاری داده‌ها
        </div>

        <div id="content" style="display: none;">
            <!-- آمار کلی -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <h3 id="totalInvestors">-</h3>
                    <p>کل سرمایه‌گذاران</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3 id="totalPrincipal">-</h3>
                    <p>کل آورده (میلیون تومان)</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-pie"></i>
                    <h3 id="totalProfit">-</h3>
                    <p>کل سود (میلیون تومان)</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-alt"></i>
                    <h3 id="totalDays">-</h3>
                    <p>تعداد روزهای پروژه</p>
                </div>
            </div>

            <!-- نمودارها -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3><i class="fas fa-chart-line"></i> نمودار سود روزانه</h3>
                    <div class="chart-wrapper">
                        <canvas id="dailyProfitChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3><i class="fas fa-chart-pie"></i> توزیع سرمایه‌گذاران</h3>
                    <div class="chart-wrapper">
                        <canvas id="investorDistributionChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3><i class="fas fa-chart-bar"></i> مقایسه آورده و سود</h3>
                    <div class="chart-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3><i class="fas fa-chart-area"></i> روند سرمایه‌گذاری در طول زمان</h3>
                    <div class="chart-wrapper">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- جدول خلاصه -->
            <div class="table-container">
                <h3><i class="fas fa-table"></i> خلاصه سرمایه‌گذاران</h3>
                <div id="summaryTable"></div>
            </div>
        </div>
    </div>

    <script>
        let chartData = null;

        // خواندن فایل CSV از پوشه view
        function loadData() {
            console.log('شروع بارگذاری داده‌ها...');
            
            Papa.parse('data.csv', {
                header: true,
                download: true,
                complete: function(results) {
                    console.log('فایل CSV بارگذاری شد:', results);
                    
                    if (results.errors.length > 0) {
                        console.error('خطاهای CSV:', results.errors);
                        console.log('جزئیات خطا:', JSON.stringify(results.errors, null, 2));
                        
                        // اگر فقط خطاهای جزئی هستند، ادامه می‌دهیم
                        const criticalErrors = results.errors.filter(error => 
                            error.type === 'Delimiter' || error.type === 'Quotes' || error.type === 'FieldMismatch'
                        );
                        
                        if (criticalErrors.length > 0) {
                            showError('خطاهای بحرانی در فایل CSV: ' + criticalErrors.length + ' خطا');
                            return;
                        }
                        
                        console.log('خطاهای جزئی نادیده گرفته شدند، ادامه می‌دهیم...');
                    }
                    
                    if (!results.data || results.data.length === 0) {
                        showError('فایل CSV خالی است یا داده‌ای ندارد');
                        return;
                    }
                    
                    console.log('تعداد ردیف‌های CSV:', results.data.length);
                    console.log('نمونه داده:', results.data[0]);
                    
                    chartData = results.data.filter(row => row.project_id && row.project_id.trim() !== '');
                    console.log('تعداد ردیف‌های فیلتر شده:', chartData.length);
                    
                    if (chartData.length === 0) {
                        showError('هیچ داده معتبری در فایل CSV یافت نشد');
                        return;
                    }
                    
                    // تست نمونه داده
                    console.log('نمونه ردیف اول:', chartData[0]);
                    console.log('ستون‌های موجود:', Object.keys(chartData[0]));
                    
                    // بررسی وجود ستون‌های ضروری
                    const requiredColumns = ['project_id', 'investor_name', 'entry_type', 'amount', 'date_shamsi'];
                    const missingColumns = requiredColumns.filter(col => !chartData[0].hasOwnProperty(col));
                    
                    if (missingColumns.length > 0) {
                        showError('ستون‌های ضروری وجود ندارند: ' + missingColumns.join(', '));
                        return;
                    }
                    
                    console.log('همه ستون‌های ضروری موجود هستند');
                    processData();
                },
                error: function(error) {
                    console.error('خطا در Papa.parse:', error);
                    showError('خطا در بارگذاری فایل: ' + error.message);
                }
            });
        }

        function showError(message) {
            console.error('خطا:', message);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function processData() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            updateStats();
            createDailyProfitChart();
            createInvestorDistributionChart();
            createComparisonChart();
            createTrendChart();
            createSummaryTable();
        }

        function updateStats() {
            const investors = new Set(chartData.map(row => row.investor_name).filter(name => name && name !== '_src_row_index'));
            const principalData = chartData.filter(row => row.entry_type === 'principal_deposit' && row.investor_name !== '_src_row_index');
            const withdrawalData = chartData.filter(row => row.entry_type === 'principal_withdrawal' && row.investor_name !== '_src_row_index');
            const profitData = chartData.filter(row => row.entry_type === 'profit_accrual' && row.investor_name !== '_src_row_index');
            const dates = new Set(chartData.map(row => row.date_shamsi).filter(date => date));

            const totalPrincipal = principalData.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);
            const totalWithdrawal = withdrawalData.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);
            const totalProfit = profitData.reduce((sum, row) => sum + parseFloat(row.amount || 0), 0);
            
            // آورده خالص = آورده - برداشت
            const netPrincipal = totalPrincipal + totalWithdrawal; // withdrawal معمولاً منفی است

            document.getElementById('totalInvestors').textContent = investors.size;
            document.getElementById('totalPrincipal').textContent = (netPrincipal / 10000000).toFixed(1);
            document.getElementById('totalProfit').textContent = (totalProfit / 10000000).toFixed(1);
            document.getElementById('totalDays').textContent = dates.size;
        }

        function createDailyProfitChart() {
            const profitData = chartData.filter(row => row.entry_type === 'profit_accrual' && row.investor_name !== '_src_row_index');
            const dailyProfit = {};
            
            profitData.forEach(row => {
                const date = row.date_shamsi;
                if (date) {
                    dailyProfit[date] = (dailyProfit[date] || 0) + parseFloat(row.amount || 0);
                }
            });

            const dates = Object.keys(dailyProfit).sort();
            const profits = dates.map(date => dailyProfit[date] / 10000000); // تبدیل به میلیون تومان

            const ctx = document.getElementById('dailyProfitChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'سود روزانه (میلیون تومان)',
                        data: profits,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'میلیون تومان'
                            }
                        }
                    }
                }
            });
        }

        function createInvestorDistributionChart() {
            const principalData = chartData.filter(row => row.entry_type === 'principal_deposit' && row.investor_name !== '_src_row_index');
            const withdrawalData = chartData.filter(row => row.entry_type === 'principal_withdrawal' && row.investor_name !== '_src_row_index');
            const investorAmounts = {};
            
            // محاسبه آورده خالص هر سرمایه‌گذار
            principalData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorAmounts[investor]) {
                        investorAmounts[investor] = 0;
                    }
                    investorAmounts[investor] += parseFloat(row.amount || 0);
                }
            });
            
            // کم کردن برداشت‌ها
            withdrawalData.forEach(row => {
                const investor = row.investor_name;
                if (investor && investorAmounts[investor] !== undefined) {
                    investorAmounts[investor] += parseFloat(row.amount || 0); // withdrawal معمولاً منفی است
                }
            });

            // حذف سرمایه‌گذارانی که آورده خالص منفی دارند
            const validInvestors = Object.entries(investorAmounts)
                .filter(([investor, amount]) => amount > 0)
                .reduce((obj, [investor, amount]) => {
                    obj[investor] = amount;
                    return obj;
                }, {});

            const labels = Object.keys(validInvestors);
            const data = Object.values(validInvestors).map(amount => amount / 10000000); // تبدیل به میلیون تومان

            const ctx = document.getElementById('investorDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + ' میلیون تومان';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createComparisonChart() {
            const principalData = chartData.filter(row => row.entry_type === 'principal_deposit' && row.investor_name !== '_src_row_index');
            const withdrawalData = chartData.filter(row => row.entry_type === 'principal_withdrawal' && row.investor_name !== '_src_row_index');
            const profitData = chartData.filter(row => row.entry_type === 'profit_accrual' && row.investor_name !== '_src_row_index');
            
            const investorPrincipal = {};
            const investorProfit = {};
            
            // محاسبه آورده خالص هر سرمایه‌گذار
            principalData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorPrincipal[investor]) {
                        investorPrincipal[investor] = 0;
                    }
                    investorPrincipal[investor] += parseFloat(row.amount || 0);
                }
            });
            
            // کم کردن برداشت‌ها
            withdrawalData.forEach(row => {
                const investor = row.investor_name;
                if (investor && investorPrincipal[investor] !== undefined) {
                    investorPrincipal[investor] += parseFloat(row.amount || 0); // withdrawal معمولاً منفی است
                }
            });
            
            profitData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    investorProfit[investor] = (investorProfit[investor] || 0) + parseFloat(row.amount || 0);
                }
            });

            // فقط سرمایه‌گذارانی که آورده خالص مثبت دارند
            const validInvestors = Object.keys(investorPrincipal).filter(inv => investorPrincipal[inv] > 0);
            const principals = validInvestors.map(inv => investorPrincipal[inv] / 10000000);
            const profits = validInvestors.map(inv => (investorProfit[inv] || 0) / 10000000);

            const ctx = document.getElementById('comparisonChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: validInvestors,
                    datasets: [
                        {
                            label: 'آورده خالص (میلیون تومان)',
                            data: principals,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'سود (میلیون تومان)',
                            data: profits,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'میلیون تومان'
                            }
                        }
                    }
                }
            });
        }

        function createTrendChart() {
            const principalData = chartData.filter(row => row.entry_type === 'principal_deposit' && row.investor_name !== '_src_row_index');
            const withdrawalData = chartData.filter(row => row.entry_type === 'principal_withdrawal' && row.investor_name !== '_src_row_index');
            const dates = [...new Set([
                ...principalData.map(row => row.date_shamsi),
                ...withdrawalData.map(row => row.date_shamsi)
            ].filter(date => date))].sort();
            
            const dailyPrincipal = {};
            const dailyWithdrawal = {};
            dates.forEach(date => {
                dailyPrincipal[date] = 0;
                dailyWithdrawal[date] = 0;
            });
            
            principalData.forEach(row => {
                const date = row.date_shamsi;
                if (date) {
                    dailyPrincipal[date] += parseFloat(row.amount || 0);
                }
            });
            
            withdrawalData.forEach(row => {
                const date = row.date_shamsi;
                if (date) {
                    dailyWithdrawal[date] += parseFloat(row.amount || 0);
                }
            });

            const cumulativeData = [];
            let cumulative = 0;
            dates.forEach(date => {
                const netAmount = dailyPrincipal[date] + dailyWithdrawal[date];
                cumulative += netAmount;
                cumulativeData.push(cumulative / 10000000); // تبدیل به میلیون تومان
            });

            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'سرمایه‌گذاری خالص تجمعی (میلیون تومان)',
                        data: cumulativeData,
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'میلیون تومان'
                            }
                        }
                    }
                }
            });
        }

        function createSummaryTable() {
            const principalData = chartData.filter(row => row.entry_type === 'principal_deposit' && row.investor_name !== '_src_row_index');
            const withdrawalData = chartData.filter(row => row.entry_type === 'principal_withdrawal' && row.investor_name !== '_src_row_index');
            const profitData = chartData.filter(row => row.entry_type === 'profit_accrual' && row.investor_name !== '_src_row_index');
            
            const investorSummary = {};
            
            // محاسبه آورده خالص هر سرمایه‌گذار
            principalData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorSummary[investor]) {
                        investorSummary[investor] = { principal: 0, withdrawal: 0, profit: 0 };
                    }
                    investorSummary[investor].principal += parseFloat(row.amount || 0);
                }
            });
            
            // محاسبه برداشت‌ها
            withdrawalData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorSummary[investor]) {
                        investorSummary[investor] = { principal: 0, withdrawal: 0, profit: 0 };
                    }
                    investorSummary[investor].withdrawal += parseFloat(row.amount || 0);
                }
            });
            
            profitData.forEach(row => {
                const investor = row.investor_name;
                if (investor) {
                    if (!investorSummary[investor]) {
                        investorSummary[investor] = { principal: 0, withdrawal: 0, profit: 0 };
                    }
                    investorSummary[investor].profit += parseFloat(row.amount || 0);
                }
            });

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>نام سرمایه‌گذار</th>
                            <th>آورده (تومان)</th>
                            <th>برداشت (تومان)</th>
                            <th>آورده خالص (تومان)</th>
                            <th>سود (تومان)</th>
                            <th>مجموع (تومان)</th>
                            <th>نسبت سود به آورده خالص</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(investorSummary).forEach(([investor, data]) => {
                const netPrincipal = data.principal + data.withdrawal; // withdrawal معمولاً منفی است
                const total = netPrincipal + data.profit;
                const profitRatio = netPrincipal > 0 ? ((data.profit / netPrincipal) * 100).toFixed(2) : '0.00';
                
                // فقط سرمایه‌گذارانی که آورده خالص مثبت دارند
                if (netPrincipal > 0) {
                    tableHTML += `
                        <tr>
                            <td>${investor}</td>
                            <td>${data.principal.toLocaleString('fa-IR')}</td>
                            <td>${data.withdrawal.toLocaleString('fa-IR')}</td>
                            <td>${netPrincipal.toLocaleString('fa-IR')}</td>
                            <td>${data.profit.toLocaleString('fa-IR')}</td>
                            <td>${total.toLocaleString('fa-IR')}</td>
                            <td>${profitRatio}%</td>
                        </tr>
                    `;
                }
            });

            tableHTML += '</tbody></table>';
            document.getElementById('summaryTable').innerHTML = tableHTML;
        }

        // تست دسترسی به فایل CSV
        function testCSVAccess() {
            fetch('data.csv')
                .then(response => {
                    console.log('وضعیت پاسخ فایل CSV:', response.status, response.statusText);
                    if (response.ok) {
                        console.log('فایل CSV قابل دسترسی است');
                        loadDataWithFetch(); // استفاده از روش جایگزین
                    } else {
                        showError('فایل CSV قابل دسترسی نیست. وضعیت: ' + response.status);
                    }
                })
                .catch(error => {
                    console.error('خطا در تست دسترسی به CSV:', error);
                    showError('خطا در دسترسی به فایل CSV: ' + error.message);
                });
        }

        // روش جایگزین: خواندن CSV با fetch
        function loadDataWithFetch() {
            console.log('استفاده از روش fetch برای خواندن CSV...');
            
            fetch('data.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    console.log('CSV با fetch خوانده شد، طول:', csvText.length);
                    
                    // استفاده از Papa.parse روی متن
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            console.log('فایل CSV پردازش شد:', results);
                            
                            if (results.errors.length > 0) {
                                console.error('خطاهای CSV:', results.errors);
                                console.log('جزئیات خطا:', JSON.stringify(results.errors, null, 2));
                            }
                            
                            chartData = results.data.filter(row => 
                                row.project_id && 
                                row.project_id.trim() !== '' && 
                                row.investor_name && 
                                row.investor_name !== '_src_row_index'
                            );
                            console.log('تعداد ردیف‌های فیلتر شده:', chartData.length);
                            
                            if (chartData.length === 0) {
                                showError('هیچ داده معتبری در فایل CSV یافت نشد');
                                return;
                            }
                            
                            processData();
                        },
                        error: function(error) {
                            console.error('خطا در Papa.parse:', error);
                            showError('خطا در پردازش فایل CSV: ' + error.message);
                        }
                    });
                })
                .catch(error => {
                    console.error('خطا در fetch:', error);
                    showError('خطا در خواندن فایل CSV: ' + error.message);
                });
        }

        // بررسی بارگذاری Chart.js
        function checkChartJS() {
            if (typeof Chart === 'undefined') {
                showError('Chart.js بارگذاری نشده است. لطفاً صفحه را refresh کنید.');
                return false;
            }
            console.log('Chart.js با موفقیت بارگذاری شد');
            return true;
        }

        // بارگذاری داده‌ها هنگام لود صفحه
        window.addEventListener('load', function() {
            if (checkChartJS()) {
                testCSVAccess();
            }
        });
    </script>
</body>
</html>
