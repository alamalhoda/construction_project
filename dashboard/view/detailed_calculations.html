<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محاسبات دقیق - سیستم مدیریت پروژه ساختمانی</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Vazir Font CSS -->
    <link rel="stylesheet" href="/static/fonts/vazir.css">
    
    <!-- Custom CSS -->
    <style>
        :root {
            /* رنگ‌های استاندارد پروژه */
            --deposit-color: #2185d0;           /* آبی - آورده */
            --withdrawal-color: #db2828;        /* قرمز - برداشت */
            --profit-color: #21ba45;            /* سبز - سود مشارکت */
            --capital-color: #aa26ff;           /* بنفش - سرمایه موجود */
            --expense-color: #dc3545;           /* قرمز تیره - هزینه‌ها */
            --refund-color: #ffc107;            /* زرد - فروش/مرجوعی */
            --balance-color: #6c757d;           /* خاکستری - مانده صندوق */
            --total-color: #6c757d;             /* خاکستری - مجموع */
            --gold-color: #ffd700;              /* طلایی - شاخص نفع */
            
            /* نسخه‌های شفاف برای پس‌زمینه */
            --deposit-color-light: rgba(33, 133, 208, 0.1);
            --withdrawal-color-light: rgba(219, 40, 40, 0.1);
            --profit-color-light: rgba(33, 186, 69, 0.1);
            --capital-color-light: rgba(170, 38, 255, 0.1);
            --expense-color-light: rgba(220, 53, 69, 0.1);
            --refund-color-light: rgba(255, 193, 7, 0.1);
            --balance-color-light: rgba(108, 117, 125, 0.1);
            --total-color-light: rgba(108, 117, 125, 0.1);
            --gold-color-light: rgba(255, 215, 0, 0.1);
        }

        body {
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        /* Unified Header Styles */
        .unified-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .unified-header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            text-align: center;
        }

        .unified-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .unified-header .subtitle {
            font-size: 1.1rem;
            margin-bottom: 25px;
            opacity: 0.9;
        }

        .navigation-links {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }

        .nav-link i {
            font-size: 0.9rem;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Bootstrap compatibility */
        .container-fluid {
            padding-right: 20px;
            padding-left: 20px;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .page-header p {
            margin: 10px 0 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .section-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 30px 0 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-right: 5px solid var(--capital-color);
        }

        .section-header h2 {
            margin: 0;
            color: var(--capital-color);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Container خاص برای سرمایه‌گذاران - 1 کارت در هر سطر */
        .investors-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .calculation-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .calculation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .calculation-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: var(--card-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 1.5rem;
            color: var(--card-color);
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--card-color);
            margin: 15px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .card-description {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.6;
            margin: 0;
            background: var(--card-color-light);
            padding: 15px;
            border-radius: 8px;
            border-right: 3px solid var(--card-color);
        }

        .card-formula {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #495057;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }

        /* Color variants for different card types - طبق استاندارد پروژه */
        .card-deposit {
            --card-color: var(--deposit-color);
            --card-color-light: var(--deposit-color-light);
        }

        .card-withdrawal {
            --card-color: var(--withdrawal-color);
            --card-color-light: var(--withdrawal-color-light);
        }

        .card-profit {
            --card-color: var(--profit-color);
            --card-color-light: var(--profit-color-light);
        }

        .card-capital {
            --card-color: var(--capital-color);
            --card-color-light: var(--capital-color-light);
        }

        .card-expense {
            --card-color: var(--expense-color);
            --card-color-light: var(--expense-color-light);
        }

        .card-refund {
            --card-color: var(--refund-color);
            --card-color-light: var(--refund-color-light);
        }

        .card-balance {
            --card-color: var(--balance-color);
            --card-color-light: var(--balance-color-light);
        }

        .card-total {
            --card-color: var(--total-color);
            --card-color-light: var(--total-color-light);
        }

        .card-gold {
            --card-color: var(--gold-color);
            --card-color-light: var(--gold-color-light);
        }

        .investor-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .investor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .investor-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 6px;
            height: 100%;
            background: var(--capital-color);
        }

        .investor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--capital-color-light);
        }

        .investor-name {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--capital-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .investor-name::before {
            content: '👤';
            font-size: 1.4rem;
        }

        .investor-type {
            background: linear-gradient(135deg, var(--capital-color) 0%, var(--profit-color) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px var(--capital-color-light);
        }

        .investor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--capital-color-light);
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-right: 4px solid #c62828;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: var(--capital-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        /* Bootstrap utility classes */
        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: 1.5rem;
        }

        .mb-3 {
            margin-bottom: 1rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mt-4 {
            margin-top: 1.5rem;
        }

        .mt-3 {
            margin-top: 1rem;
        }

        .p-3 {
            padding: 1rem;
        }

        .p-4 {
            padding: 1.5rem;
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .main-container {
                padding: 10px;
            }
            
            .page-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="vazir-font">
    <div class="main-container">
        <!-- Unified Header -->
        <div class="unified-header">
            <div class="unified-header-content">
                <h1 class="vazir-bold">
                    <i class="fas fa-calculator"></i>
                    محاسبات دقیق
                </h1>
                <p class="subtitle vazir-regular">نمایش تمام محاسبات مالی و آماری پروژه با دقت کامل</p>
                <div class="navigation-links">
                    <a href="/user-dashboard/" class="nav-link">
                        <i class="fas fa-home"></i>
                        صفحه اصلی
                    </a>
                    <a href="/dashboard/project/" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        خلاصه مالی
                    </a>
                    <a href="/dashboard/transaction-manager/" class="nav-link">
                        <i class="fas fa-money-bill-wave"></i>
                        مدیریت تراکنش‌ها
                    </a>
                    <a href="/dashboard/expense-dashboard/" class="nav-link">
                        <i class="fas fa-chart-pie"></i>
                        لیست هزینه ها
                    </a>
                    <a href="/dashboard/interest-rate-manager/" class="nav-link">
                        <i class="fas fa-percentage"></i>
                        مدیریت سود
                    </a>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading text-center">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p class="mb-0">در حال بارگذاری محاسبات...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle mb-2"></i>
            <strong>خطا در بارگذاری داده‌ها:</strong>
            <span id="error-message"></span>
        </div>

        <!-- Content Container -->
        <div id="content" style="display: none;">
            <!-- Project Statistics Section -->
            <div class="section-header">
                <h2 class="mb-0 vazir-bold"><i class="fas fa-building"></i> آمار کلی پروژه</h2>
            </div>
            <div class="cards-container" id="project-stats">
                <!-- Project stats cards will be populated here -->
            </div>

            <!-- Financial Calculations Section -->
            <div class="section-header">
                <h2 class="mb-0 vazir-bold"><i class="fas fa-chart-line"></i> محاسبات مالی</h2>
            </div>
            <div class="cards-container" id="financial-calculations">
                <!-- Financial calculation cards will be populated here -->
            </div>

            <!-- Cost Metrics Section -->
            <div class="section-header">
                <h2 class="mb-0 vazir-bold"><i class="fas fa-dollar-sign"></i> متریک‌های هزینه</h2>
            </div>
            <div class="cards-container" id="cost-metrics">
                <!-- Cost metrics cards will be populated here -->
            </div>

            <!-- Profit Calculations Section -->
            <div class="section-header">
                <h2 class="mb-0 vazir-bold"><i class="fas fa-percentage"></i> محاسبات سود</h2>
            </div>
            <div class="cards-container" id="profit-calculations">
                <!-- Profit calculation cards will be populated here -->
            </div>

            <!-- Transaction Statistics Section -->
            <div class="section-header">
                <h2 class="mb-0 vazir-bold"><i class="fas fa-exchange-alt"></i> آمار تراکنش‌ها</h2>
            </div>
            <div class="cards-container" id="transaction-stats">
                <!-- Transaction stats cards will be populated here -->
            </div>

            <!-- Investors Section -->
            <div class="section-header">
                <h2 class="mb-0 vazir-bold"><i class="fas fa-users"></i> محاسبات سرمایه‌گذاران</h2>
            </div>
            <div class="investors-container" id="investors-container">
                <!-- Investor cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="refresh-btn btn btn-primary" onclick="loadCalculations()" title="بروزرسانی محاسبات">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let comprehensiveAnalysis = null;
        let investorsSummary = null;

        // Format number with thousand separators - SMART DECIMAL HANDLING
        function formatNumber(number, decimals = 15) {
            if (number === null || number === undefined || isNaN(number)) return '0';
            const num = parseFloat(number);
            
            // Check if number is a whole number (no decimal part)
            if (num % 1 === 0) {
                // For whole numbers, don't show decimal places
                return num.toLocaleString('en-US');
            } else {
                // For decimal numbers, show up to 15 decimal places but remove trailing zeros
                const formatted = num.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: decimals
                });
                // Remove trailing zeros and decimal point if not needed
                return formatted.replace(/\\.?0+$/, '');
            }
        }

        // Format percentage - SMART DECIMAL HANDLING
        function formatPercentage(number, decimals = 15) {
            if (number === null || number === undefined || isNaN(number)) return '0%';
            const num = parseFloat(number);
            
            // Check if number is a whole number (no decimal part)
            if (num % 1 === 0) {
                // For whole numbers, don't show decimal places
                return num + '%';
            } else {
                // For decimal numbers, show up to 15 decimal places but remove trailing zeros
                const formatted = num.toFixed(decimals);
                // Remove trailing zeros and decimal point if not needed
                return formatted.replace(/\\.?0+$/, '') + '%';
            }
        }

        // Create calculation card
        function createCard(title, value, description, formula, type = 'total', icon = 'fas fa-calculator') {
            return `
                <div class="calculation-card card-${type}">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="${icon}"></i>
                            ${title}
                        </h3>
                    </div>
                    <div class="card-value">${value}</div>
                    <div class="card-description">${description}</div>
                    ${formula ? `<div class="card-formula">${formula}</div>` : ''}
                </div>
            `;
        }

        // Create investor card
        function createInvestorCard(investor) {
            const ownership = investor.ownership || {};
            return `
                <div class="investor-card">
                    <div class="investor-header">
                        <h3 class="investor-name">${investor.name}</h3>
                        <span class="investor-type">${investor.participation_type === 'owner' ? 'مالک' : 'سرمایه‌گذار'}</span>
                    </div>
                    <div class="investor-stats">
                        <div class="stat-item" style="border-right: 4px solid var(--deposit-color);">
                            <div class="stat-label" style="color: var(--deposit-color); font-weight: 600;">💰 مجموع آورده</div>
                            <div class="stat-value" style="color: var(--deposit-color);">${formatNumber(investor.total_deposits)} تومان</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--withdrawal-color);">
                            <div class="stat-label" style="color: var(--withdrawal-color); font-weight: 600;">💸 مجموع برداشت</div>
                            <div class="stat-value" style="color: var(--withdrawal-color);">${formatNumber(investor.total_withdrawals)} تومان</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--capital-color);">
                            <div class="stat-label" style="color: var(--capital-color); font-weight: 600;">🏦 سرمایه خالص</div>
                            <div class="stat-value" style="color: var(--capital-color);">${formatNumber(investor.net_principal)} تومان</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--profit-color);">
                            <div class="stat-label" style="color: var(--profit-color); font-weight: 600;">📈 مجموع سود</div>
                            <div class="stat-value" style="color: var(--profit-color);">${formatNumber(investor.total_profit)} تومان</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--balance-color);">
                            <div class="stat-label" style="color: var(--balance-color); font-weight: 600;">💼 موجودی کل</div>
                            <div class="stat-value" style="color: var(--balance-color);">${formatNumber(investor.grand_total)} تومان</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--capital-color);">
                            <div class="stat-label" style="color: var(--capital-color); font-weight: 600;">📊 نسبت سرمایه</div>
                            <div class="stat-value" style="color: var(--capital-color);">${formatPercentage(investor.capital_ratio)}</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--profit-color);">
                            <div class="stat-label" style="color: var(--profit-color); font-weight: 600;">📈 نسبت سود</div>
                            <div class="stat-value" style="color: var(--profit-color);">${formatPercentage(investor.profit_ratio)}</div>
                        </div>
                        <div class="stat-item" style="background: var(--gold-color-light); border: 3px solid var(--gold-color); box-shadow: 0 4px 15px var(--gold-color-light);">
                            <div class="stat-label" style="color: var(--gold-color); font-weight: 700; font-size: 1.1rem;">🏆 شاخص نفع</div>
                            <div class="stat-value" style="color: var(--gold-color); font-weight: 800; font-size: 1.5rem;">${formatNumber(investor.profit_index)}</div>
                        </div>
                        ${ownership.ownership_area ? `
                        <div class="stat-item" style="border-right: 4px solid var(--capital-color);">
                            <div class="stat-label" style="color: var(--capital-color); font-weight: 600;">🏠 مالکیت (متر مربع)</div>
                            <div class="stat-value" style="color: var(--capital-color);">${formatNumber(ownership.ownership_area)} متر²</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--profit-color);">
                            <div class="stat-label" style="color: var(--profit-color); font-weight: 600;">💲 قیمت هر متر</div>
                            <div class="stat-value" style="color: var(--profit-color);">${formatNumber(ownership.average_price_per_meter)} تومان</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--capital-color);">
                            <div class="stat-label" style="color: var(--capital-color); font-weight: 600;">📊 درصد مالکیت</div>
                            <div class="stat-value" style="color: var(--capital-color);">${formatPercentage(ownership.ownership_percentage)}</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--expense-color);">
                            <div class="stat-label" style="color: var(--expense-color); font-weight: 600;">💳 پرداخت نهایی</div>
                            <div class="stat-value" style="color: var(--expense-color);">${formatNumber(ownership.final_payment)} تومان</div>
                        </div>
                        ` : ''}
                        
                        ${ownership.units && ownership.units.length > 0 ? `
                        <div class="stat-item" style="border-right: 4px solid var(--capital-color);">
                            <div class="stat-label" style="color: var(--capital-color); font-weight: 600;">🏠 تعداد واحدها</div>
                            <div class="stat-value" style="color: var(--capital-color);">${ownership.units_count} واحد</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--profit-color);">
                            <div class="stat-label" style="color: var(--profit-color); font-weight: 600;">📐 مساحت کل واحدها</div>
                            <div class="stat-value" style="color: var(--profit-color);">${formatNumber(ownership.total_units_area, 2)} متر²</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--capital-color);">
                            <div class="stat-label" style="color: var(--capital-color); font-weight: 600;">💰 قیمت کل واحدها</div>
                            <div class="stat-value" style="color: var(--capital-color);">${formatNumber(ownership.total_units_price)} تومان</div>
                        </div>
                        ` : ''}
                        
                        ${ownership.units && ownership.units.length > 0 ? ownership.units.map(unit => `
                        <div class="stat-item" style="border-right: 4px solid var(--capital-color);">
                            <div class="stat-label" style="color: var(--capital-color); font-weight: 600;">🏠 نام واحد: ${unit.name}</div>
                            <div class="stat-value" style="color: var(--capital-color);">${formatNumber(unit.area, 2)} متر²</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--profit-color);">
                            <div class="stat-label" style="color: var(--profit-color); font-weight: 600;">💲 قیمت هر متر: ${unit.name}</div>
                            <div class="stat-value" style="color: var(--profit-color);">${formatNumber(unit.price_per_meter)} تومان</div>
                        </div>
                        <div class="stat-item" style="border-right: 4px solid var(--capital-color);">
                            <div class="stat-label" style="color: var(--capital-color); font-weight: 600;">💰 قیمت کل: ${unit.name}</div>
                            <div class="stat-value" style="color: var(--capital-color);">${formatNumber(unit.total_price)} تومان</div>
                        </div>
                        `).join('') : ''}
                        
                        ${investor.contract_date ? `
                        <div class="stat-item" style="border-right: 4px solid var(--total-color);">
                            <div class="stat-label" style="color: var(--total-color); font-weight: 600;">📅 تاریخ قرارداد</div>
                            <div class="stat-value" style="color: var(--total-color);">${investor.contract_date}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Load calculations from server
        async function loadCalculations() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('content').style.display = 'none';

                const response = await fetch('/api/v1/comprehensive/comprehensive_analysis/');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                comprehensiveAnalysis = data;
                
                // Load investors data
                const investorsResponse = await fetch('/api/v1/Investor/all_investors_summary/');
                if (investorsResponse.ok) {
                    investorsSummary = await investorsResponse.json();
                }

                renderCalculations();
                
            } catch (error) {
                console.error('Error loading calculations:', error);
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Render all calculations
        function renderCalculations() {
            if (!comprehensiveAnalysis) return;

            renderProjectStats();
            renderFinancialCalculations();
            renderCostMetrics();
            renderProfitCalculations();
            renderTransactionStats();
            renderInvestors();

            document.getElementById('content').style.display = 'block';
        }

        // Render project statistics
        function renderProjectStats() {
            const stats = comprehensiveAnalysis.project_statistics;
            const units = stats.units_statistics;
            const project = stats.project;

            const cards = [
                createCard(
                    'تعداد کل واحدها (total_units)',
                    units.total_units,
                    'تعداد کل واحدهای تعریف شده در پروژه',
                    'COUNT(units)',
                    'capital',
                    'fas fa-home'
                ),
                createCard(
                    'مساحت کل (total_area)',
                    formatNumber(units.total_area, 2) + ' متر²',
                    'مجموع مساحت تمام واحدهای پروژه',
                    'SUM(area)',
                    'capital',
                    'fas fa-ruler-combined'
                ),
                createCard(
                    'ارزش کل واحدها (total_price)',
                    formatNumber(units.total_price) + ' تومان',
                    'مجموع ارزش تمام واحدهای پروژه',
                    'SUM(total_price)',
                    'profit',
                    'fas fa-dollar-sign'
                ),
                createCard(
                    'تعداد سرمایه‌گذاران (total_investors)',
                    stats.investor_statistics.total_investors,
                    'تعداد کل سرمایه‌گذاران فعال در پروژه',
                    'COUNT(DISTINCT investor_id)',
                    'capital',
                    'fas fa-users'
                ),
                createCard(
                    'تعداد مالکان (owners_count)',
                    stats.investor_statistics.owners_count,
                    'تعداد سرمایه‌گذارانی که مالک هستند',
                    'COUNT(owners)',
                    'capital',
                    'fas fa-user-tie'
                ),
                createCard(
                    'مدت پروژه (project_duration_days)',
                    stats.project_timing.project_duration_days + ' روز',
                    'تعداد روزهای کل پروژه',
                    'end_date - start_date',
                    'total',
                    'fas fa-calendar-alt'
                )
            ];

            document.getElementById('project-stats').innerHTML = cards.join('');
        }

        // Render financial calculations
        function renderFinancialCalculations() {
            const stats = comprehensiveAnalysis.transaction_statistics;

            const cards = [
                createCard(
                    'مجموع آورده‌ها (total_deposits)',
                    formatNumber(stats.total_deposits) + ' تومان',
                    'مجموع کل مبالغ واریزی سرمایه‌گذاران',
                    'SUM(amount) WHERE transaction_type = "principal_deposit"',
                    'deposit',
                    'fas fa-arrow-down'
                ),
                createCard(
                    'مجموع برداشت‌ها (total_withdrawals)',
                    formatNumber(Math.abs(stats.total_withdrawals)) + ' تومان',
                    'مجموع کل مبالغ برداشتی سرمایه‌گذاران',
                    'SUM(amount) WHERE transaction_type = "principal_withdrawal"',
                    'withdrawal',
                    'fas fa-arrow-up'
                ),
                createCard(
                    'سرمایه خالص (net_capital)',
                    formatNumber(stats.net_capital) + ' تومان',
                    'سرمایه موجود پس از کسر برداشت‌ها از آورده‌ها',
                    'total_deposits + total_withdrawals',
                    'capital',
                    'fas fa-balance-scale'
                ),
                createCard(
                    'مجموع سودها (total_profits)',
                    formatNumber(stats.total_profits) + ' تومان',
                    'مجموع کل سودهای تعلق گرفته',
                    'SUM(amount) WHERE transaction_type = "profit_accrual"',
                    'profit',
                    'fas fa-chart-line'
                ),
                createCard(
                    'موجودی کل (grand_total)',
                    formatNumber(stats.net_capital + stats.total_profits) + ' تومان',
                    'مجموع سرمایه خالص و سودها',
                    'net_capital + total_profits',
                    'balance',
                    'fas fa-wallet'
                ),
                createCard(
                    'تعداد تراکنش‌ها (total_transactions)',
                    stats.total_transactions,
                    'تعداد کل تراکنش‌های انجام شده',
                    'COUNT(transactions)',
                    'total',
                    'fas fa-list'
                )
            ];

            document.getElementById('financial-calculations').innerHTML = cards.join('');
        }

        // Render cost metrics
        function renderCostMetrics() {
            const metrics = comprehensiveAnalysis.cost_metrics;

            const cards = [
                createCard(
                    'هزینه نهایی (final_cost)',
                    formatNumber(metrics.final_cost) + ' تومان',
                    'هزینه کل منهای فروش‌ها',
                    'total_expenses - total_sales',
                    'expense',
                    'fas fa-receipt'
                ),
                createCard(
                    'سود نهایی (final_profit_amount)',
                    formatNumber(metrics.final_profit_amount) + ' تومان',
                    'ارزش کل منهای هزینه نهایی',
                    'total_value - final_cost',
                    'profit',
                    'fas fa-trophy'
                ),
                createCard(
                    'درصد سود کل (total_profit_percentage)',
                    formatPercentage(metrics.total_profit_percentage),
                    'درصد سود کل پروژه',
                    '(final_profit_amount / final_cost) × 100',
                    'profit',
                    'fas fa-percentage'
                ),
                createCard(
                    'هزینه هر متر (خالص) (net_cost_per_meter)',
                    formatNumber(metrics.net_cost_per_meter) + ' تومان/متر²',
                    'هزینه نهایی تقسیم بر مساحت کل',
                    'final_cost / total_area',
                    'expense',
                    'fas fa-ruler'
                ),
                createCard(
                    'هزینه هر متر (ناخالص) (gross_cost_per_meter)',
                    formatNumber(metrics.gross_cost_per_meter) + ' تومان/متر²',
                    'هزینه نهایی تقسیم بر زیربنای کل',
                    'final_cost / total_infrastructure',
                    'expense',
                    'fas fa-building'
                ),
                createCard(
                    'ارزش هر متر (value_per_meter)',
                    formatNumber(metrics.value_per_meter) + ' تومان/متر²',
                    'ارزش کل تقسیم بر مساحت کل',
                    'total_value / total_area',
                    'profit',
                    'fas fa-chart-bar'
                ),
                createCard(
                    'مانده صندوق (building_fund_balance)',
                    formatNumber(metrics.building_fund_balance) + ' تومان',
                    'سرمایه موجود منهای هزینه خالص',
                    'total_capital - net_cost',
                    'capital',
                    'fas fa-piggy-bank'
                ),
                createCard(
                    'مساحت کل (total_area)',
                    formatNumber(metrics.total_area, 2) + ' متر²',
                    'مجموع مساحت تمام واحدها',
                    'SUM(area)',
                    'capital',
                    'fas fa-home'
                )
            ];

            document.getElementById('cost-metrics').innerHTML = cards.join('');
        }

        // Render profit calculations
        function renderProfitCalculations() {
            const profits = comprehensiveAnalysis.profit_percentages;

            const cards = [
                createCard(
                    'درصد سود کل (total_profit_percentage)',
                    formatPercentage(profits.total_profit_percentage),
                    'درصد سود کل پروژه',
                    '(final_profit_amount / final_cost) × 100',
                    'profit',
                    'fas fa-percentage'
                ),
                createCard(
                    'درصد سود سالانه (annual_profit_percentage)',
                    formatPercentage(profits.annual_profit_percentage),
                    'درصد سود سالانه محاسبه شده',
                    '(total_profit_percentage / average_period) × 12',
                    'profit',
                    'fas fa-calendar'
                ),
                createCard(
                    'درصد سود ماهانه (monthly_profit_percentage)',
                    formatPercentage(profits.monthly_profit_percentage),
                    'درصد سود ماهانه',
                    'annual_profit_percentage / 12',
                    'profit',
                    'fas fa-calendar-alt'
                ),
                createCard(
                    'درصد سود روزانه (daily_profit_percentage)',
                    formatPercentage(profits.daily_profit_percentage),
                    'درصد سود روزانه با ضریب اصلاحی',
                    '(annual_profit_percentage / 365) × correction_factor',
                    'profit',
                    'fas fa-sun'
                ),
                createCard(
                    'دوره متوسط ساخت (average_construction_period)',
                    formatNumber(profits.average_construction_period, 2) + ' روز',
                    'دوره متوسط ساخت پروژه',
                    'SUM(expense × weight) / SUM(expense)',
                    'total',
                    'fas fa-clock'
                ),
                createCard(
                    'ضریب اصلاحی (correction_factor)',
                    formatNumber(profits.correction_factor, 6),
                    'ضریب اصلاحی پروژه',
                    'project.correction_factor',
                    'total',
                    'fas fa-adjust'
                )
            ];

            document.getElementById('profit-calculations').innerHTML = cards.join('');
        }

        // Render transaction statistics
        function renderTransactionStats() {
            const stats = comprehensiveAnalysis.transaction_statistics;

            const cards = [
                createCard(
                    'تعداد کل تراکنش‌ها (total_transactions)',
                    stats.total_transactions,
                    'تعداد کل تراکنش‌های ثبت شده',
                    'COUNT(transactions)',
                    'total',
                    'fas fa-list'
                ),
                createCard(
                    'میانگین تراکنش (average_transaction)',
                    formatNumber((stats.total_deposits + Math.abs(stats.total_withdrawals) + stats.total_profits) / stats.total_transactions) + ' تومان',
                    'میانگین مبلغ هر تراکنش',
                    '(total_amounts / total_transactions)',
                    'total',
                    'fas fa-calculator'
                )
            ];

            document.getElementById('transaction-stats').innerHTML = cards.join('');
        }

        // Render investors
        function renderInvestors() {
            if (!investorsSummary || investorsSummary.length === 0) {
                document.getElementById('investors-container').innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">هیچ سرمایه‌گذاری یافت نشد</p>';
                return;
            }

            const investorCards = investorsSummary.map(investor => createInvestorCard(investor));
            document.getElementById('investors-container').innerHTML = investorCards.join('');
        }

        // Check if Vazir font is loaded
        function checkVazirFont() {
            const testElement = document.createElement('span');
            testElement.style.fontFamily = 'Vazir, Tahoma, Arial, sans-serif';
            testElement.style.fontSize = '16px';
            testElement.style.position = 'absolute';
            testElement.style.left = '-9999px';
            testElement.innerHTML = 'تست فونت وزیر';
            document.body.appendChild(testElement);
            
            const computedStyle = window.getComputedStyle(testElement);
            const fontFamily = computedStyle.fontFamily;
            
            document.body.removeChild(testElement);
            
            if (fontFamily.includes('Vazir')) {
                console.log('✅ فونت Vazir با موفقیت لود شده است');
                return true;
            } else {
                console.log('❌ فونت Vazir لود نشده است، از فونت fallback استفاده می‌شود');
                return false;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check font loading
            setTimeout(() => {
                checkVazirFont();
            }, 1000);
            
            loadCalculations();
        });
    </script>
</body>
</html>
