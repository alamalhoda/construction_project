<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تراکنش سرمایه‌گذار</title>

    <!-- Tabulator CSS with Semantic UI theme -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.2/css/tabulator_semanticui.min.css" rel="stylesheet">
    
    <!-- Semantic UI CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Include PersianDatepicker CSS -->
    <link href="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/css/persian-datepicker.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            padding: 20px;
            direction: rtl;
        }
        
        .main-container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header-section h1 {
            color: #2185d0;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header-section .description {
            color: #767676;
            font-size: 1.1rem;
        }
        
        .controls-section {
            margin-bottom: 20px;
        }
        
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
        }
        
        .controls-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .controls-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .group-dropdown {
            min-width: 200px;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(34, 36, 38, 0.12), 0 2px 10px rgba(34, 36, 38, 0.15);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .stats-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(34, 36, 38, 0.12), 0 2px 10px rgba(34, 36, 38, 0.15);
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid #2185d0;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2185d0;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #767676;
            font-weight: 500;
        }
        
        .loading-container {
            text-align: center;
            padding: 60px 20px;
            color: #767676;
        }
        
        .loading-container .icon {
            font-size: 3rem;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            color: #2185d0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            margin-bottom: 20px;
        }
        
        /* Tabulator Semantic UI customizations */
        .tabulator {
            border: none !important;
        }
        
        .tabulator-header {
            background: #2185d0 !important;
        }
        
        .tabulator-header .tabulator-col {
            background: #2185d0 !important;
            color: white !important;
        }
        
        .tabulator-header .tabulator-col-title {
            color: white !important;
            font-weight: 600 !important;
        }
        
        .tabulator-calcs-holder {
            background: #21ba45 !important;
        }
        
        .tabulator-calc {
            background: #21ba45 !important;
            color: white !important;
            font-weight: bold !important;
        }
        
        .tabulator-row:hover {
            background: #f0f8ff !important;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls-left,
            .controls-right {
                justify-content: center;
                width: 100%;
            }
            
            .group-dropdown {
                min-width: auto;
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* رنگ‌های پس‌زمینه برای انواع تراکنش */
        #csvTable .tabulator-row.row-principal_deposit {
            background-color: rgba(33, 186, 69, 0.25) !important;  /* سبز کمرنگ */
        }
        
        #csvTable .tabulator-row.row-principal_withdrawal {
            background-color: rgba(219, 40, 40, 0.25) !important;  /* قرمز کمرنگ */
        }
        
        #csvTable .tabulator-row.row-profit_accrual {
            background-color: rgba(33, 133, 208, 0.25) !important;  /* آبی کمرنگ */
        }
        
        /* حالت hover */
        #csvTable .tabulator-row.row-principal_deposit:hover {
            background-color: rgba(33, 186, 69, 0.35) !important;
        }
        
        #csvTable .tabulator-row.row-principal_withdrawal:hover {
            background-color: rgba(219, 40, 40, 0.35) !important;
        }
        
        #csvTable .tabulator-row.row-profit_accrual:hover {
            background-color: rgba(33, 133, 208, 0.35) !important;
        }

        /* اطمینان از اولویت بالاتر */
        .tabulator-row[class*="row-"] {
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header Section -->
        <div class="header-section">
            <h1 class="ui huge header">
                <i class="table icon"></i>
تراکنش سرمایه‌گذاران            </h1>
            <p class="description"><a href="charts_investor.html">Dashboard <i class="dashboard icon"></i></a></p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="ui negative message" style="display: none;">
            <i class="close icon"></i>
            <div class="header">خطا در بارگذاری داده‌ها</div>
            <p id="errorText"></p>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="controls-row">
                <div class="controls-left">
                    <button class="ui green button" onclick="exportToCSV()">
                        <i class="download icon"></i>
                        دانلود CSV
                    </button>
                    
                    <button class="ui blue button" onclick="exportToJSON()">
                        <i class="file code icon"></i>
                        دانلود JSON
                    </button>
                    
                    <button class="ui orange button" onclick="clearGrouping()">
                        <i class="unlink icon"></i>
                        حذف گروه‌بندی
                    </button>
                </div>
                
                <div class="controls-right">
                    <button class="ui primary button" onclick="showAddRecordModal()">
                        <i class="plus icon"></i>
                        افزودن رکورد جدید
                    </button>
                    
                    <div class="ui selection dropdown group-dropdown" id="groupByDropdown">
                        <input type="hidden" name="groupBy">
                        <i class="dropdown icon"></i>
                        <div class="default text">گروه‌بندی بر اساس...</div>
                        <div class="menu" id="groupByMenu">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Record Modal -->
        <div class="ui modal" id="addRecordModal">
            <div class="header">
                <i class="plus icon"></i>
                افزودن رکورد جدید
            </div>
            <div class="content">
                <!-- Project Info Section -->
                <div class="ui info message">
                    <div class="header">اطلاعات پروژه</div>
                    <div class="ui three statistics">
                        <div class="statistic">
                            <div class="value" id="projectStartDate">1402-05-16</div>
                            <div class="label">تاریخ شروع</div>
                        </div>
                        <div class="statistic">
                            <div class="value" id="projectEndDate">1404-12-29</div>
                            <div class="label">تاریخ پایان</div>
                        </div>
                        <div class="statistic">
                            <div class="value" id="dailyProfitRate">0.1%</div>
                            <div class="label">درصد سود روزانه</div>
                        </div>
                    </div>
                </div>
                
                <form class="ui form" id="addRecordForm">
                    <div class="two fields">
                        <div class="field">
                            <label>سرمایه‌گذار</label>
                            <div class="ui selection dropdown" id="investorDropdown">
                                <input type="hidden" name="investor_name" id="investorInput">
                                <i class="dropdown icon"></i>
                                <div class="default text">انتخاب سرمایه‌گذار</div>
                                <div class="menu" id="investorMenu">
                                </div>
                            </div>
                        </div>
                        
                        <div class="field">
                            <label>دوره</label>
                            <div class="ui selection dropdown" id="periodDropdown">
                                <input type="hidden" name="period_label" id="periodInput">
                                <i class="dropdown icon"></i>
                                <div class="default text">انتخاب دوره</div>
                                <div class="menu" id="periodMenu">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="two fields">
                        <div class="field">
                            <label>نوع تراکنش</label>
                            <div class="ui selection dropdown" id="entryTypeDropdown">
                                <input type="hidden" name="entry_type" id="entryTypeInput">
                                <i class="dropdown icon"></i>
                                <div class="default text">انتخاب نوع تراکنش</div>
                                <div class="menu">
                                    <div class="item" data-value="principal_deposit">
                                        <i class="ui green circle icon"></i>
                                        واریز اصل
                                    </div>
                                    <div class="item" data-value="principal_withdrawal">
                                        <i class="ui red circle icon"></i>
                                        برداشت اصل
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="field">
                            <label>مبلغ (ریال)</label>
                            <input type="number" name="amount" id="amountInput" placeholder="مبلغ را وارد کنید" step="0.01" min="0" onchange="calculateProfit()">
                        </div>
                    </div>
                    
                    <div class="two fields">
                        <div class="field">
                            <label>تاریخ شمسی</label>
                            <input type="text" name="date_shamsi" id="dateShamsiInput" placeholder="مثال: 1402-05-16" onchange="calculateProfit()">
                        </div>
                        
                        <div class="field">
                            <label>شناسه پروژه</label>
                            <input type="text" name="project_id" id="projectIdInput" value="آرشا3" readonly>
                        </div>
                    </div>
                    
                    <!-- Profit Calculation Section -->
                    <div class="ui segment" id="profitCalculationSection" style="display: none;">
                        <h4 class="ui dividing header">
                            <i class="calculator icon"></i>
                            محاسبه سود
                        </h4>
                        <div class="ui three statistics">
                            <div class="statistic">
                                <div class="value" id="daysToEnd">-</div>
                                <div class="label">روز تا پایان پروژه</div>
                            </div>
                            <div class="statistic">
                                <div class="value" id="calculatedProfit">-</div>
                                <div class="label">مبلغ سود (ریال)</div>
                            </div>
                            <div class="statistic">
                                <div class="value" id="totalAmount">-</div>
                                <div class="label">مجموع (اصل + سود)</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="actions">
                <div class="ui button" onclick="closeAddRecordModal()">انصراف</div>
                <div class="ui primary button" onclick="addNewRecord()">
                    <i class="save icon"></i>
                    ذخیره
                </div>
                                <button class="ui button" id="calculateProfit">محاسبه</button>

            </div>
        </div>

        <!-- Table Container -->
        <div class="table-container">
            <div id="csvTable"></div>
            
            <div id="loadingContainer" class="loading-container">
                <i class="fas fa-spinner icon"></i>
                <div class="ui header">در حال بارگذاری داده‌ها...</div>
                <p>لطفاً صبر کنید</p>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="stats-container" id="statsContainer" style="display: none;">
            <h3 class="ui dividing header">
                <i class="chart bar icon"></i>
                آمار داده‌ها
            </h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRows">0</div>
                    <div class="stat-label">کل رکوردها</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="totalColumns">0</div>
                    <div class="stat-label">تعداد ستون‌ها</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="totalDeposits">0</div>
                    <div class="stat-label">مجموع واریزها</div>
                </div>

                <div class="stat-card">
                    <div class="stat-number" id="totalWithdrawals">0</div>
                    <div class="stat-label">مجموع برداشت‌ها</div>
                </div>

                <div class="stat-card">
                    <div class="stat-number" id="totalProfits">0</div>
                    <div class="stat-label">مجموع سود</div>
                </div>
            </div>
        </div>

        <!-- Persian Datepicker Section -->
        <div class="ui form">
            <div class="two fields">
                <div class="field">
                    <label>تاریخ شروع</label>
                    <input type="text" id="startDate" placeholder="تاریخ شروع">
                </div>
                <div class="field">
                    <label>تاریخ پایان</label>
                    <input type="text" id="endDate" placeholder="تاریخ پایان">
                </div>
            </div>
            <div class="field">
                <label>درصد سود روزانه</label>
                <input type="number" id="dailyProfit" placeholder="درصد سود روزانه" step="0.01">
            </div>
            <div class="ui buttons">
                <button class="ui primary button" id="saveData">ذخیره</button>
            </div>
        </div>
    </div>

    <!-- Semantic UI JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.js"></script>
    
    <!-- Tabulator JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.2/js/tabulator.min.js"></script>
    
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Include Persian Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/js/persian-datepicker.min.js"></script>
    
    <!-- Include Persian Date library -->
    <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
    
    <script>
        let table;
        let csvData = [];
        let originalData = [];
        let investorsList = [];
        let periodsList = [];
        
        // Project configuration variables
        const PROJECT_CONFIG = {
            projectId: 'آرشا3',
            startDate: '1402-05-16', // تاریخ شروع پروژه (مرداد 1402)
            endDate: '1405-05-31',   // تاریخ پایان پروژه (مرداد 1405)
            dailyProfitRate: 0.001    // درصد سود روزانه (0.1%)
        };
        
        // Column mapping - تغییر عنوان ستون‌های اینجا انجام دهید
        const COLUMN_MAPPINGS = {
            'project_id': 'شناسه پروژه',
            'row_index': 'شماره ردیف',
            'period_label': 'دوره',
            'day_remaining': 'روزهای باقیمانده',
            'day_from_start': 'روز از شروع',
            'date_shamsi': 'تاریخ شمسی',
            'date_gregorian': 'تاریخ میلادی',
            'investor_name': 'نام سرمایه‌گذار',
            'entry_type': 'نوع تراکنش',
            'amount': 'مبلغ (ریال)'
        };
        
        const ENTRY_TYPE_FORMATS = {
            'principal_deposit': '<span class="ui green label">واریز اصل</span>',
            'principal_withdrawal': '<span class="ui red label">برداشت اصل</span>',
            'profit_accrual': '<span class="ui blue label">سود</span>'
        };
        
        // Initialize dropdown
        $(document).ready(function() {
            $('.ui.dropdown').dropdown({
                onChange: function(value) {
                    if (value && table) {
                        table.setGroupBy(value);
                    }
                }
            });
            
            // Close error message
            $('.message .close').on('click', function() {
                $(this).closest('.message').transition('fade');
            });
            
            // Load CSV file automatically
            loadCSVFile();
        });
        
        function loadCSVFile() {
            showLoading(true);
            hideError();
            
            // Load investors and periods data first
            Promise.all([
                fetch('investors.csv'),
                fetch('period_label_sorted.csv'),
                fetch('data.csv')
            ])
            .then(responses => {
                return Promise.all(responses.map(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                }));
            })
            .then(([investorsText, periodsText, dataText]) => {
                // Process investors data
                Papa.parse(investorsText, {
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            investorsList = results.data.map(row => row.name).filter(name => name && name.trim());
                            updateInvestorsDropdown();
                        }
                    },
                    header: true,
                    skipEmptyLines: true
                });
                
                // Process periods data
                Papa.parse(periodsText, {
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            periodsList = results.data.map(row => row.period_label).filter(period => period && period.trim());
                            updatePeriodsDropdown();
                        }
                    },
                    header: true,
                    skipEmptyLines: true
                });
                
                // Process main data
                Papa.parse(dataText, {
                    complete: function(results) {
                        try {
                            processCSVData(results);
                        } catch (error) {
                            showError('خطا در پردازش فایل: ' + error.message);
                            showLoading(false);
                        }
                    },
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    encoding: 'UTF-8',
                    error: function(error) {
                        showError('خطا در خواندن فایل: ' + error.message);
                        showLoading(false);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading CSV files:', error);
                showError('خطا در بارگذاری فایل‌ها. لطفاً مطمئن شوید که تمام فایل‌ها در مسیر فعلی موجود هستند.');
                showLoading(false);
                // Load sample data as fallback
                loadSampleData();
            });
        }
        
        function processCSVData(results) {
            if (results.errors.length > 0) {
                console.warn('CSV parsing warnings:', results.errors);
            }
            
            if (!results.data || results.data.length === 0) {
                showError('فایل خالی است یا قابل خواندن نیست');
                showLoading(false);
                return;
            }
            
            originalData = results.data;
            csvData = [...originalData];
            
            // Clean headers and apply mappings
            const originalHeaders = Object.keys(csvData[0]).map(header => header.trim());
            
            // Detect numeric columns for calculations
            function isNumericColumn(header) {
                const sampleValues = csvData.slice(0, Math.min(10, csvData.length))
                    .map(row => row[header])
                    .filter(val => val !== null && val !== undefined && val !== '');
                
                if (sampleValues.length === 0) return false;
                
                return sampleValues.every(val => {
                    if (typeof val === 'number') return true;
                    if (typeof val === 'string') {
                        const cleanVal = val.replace(/[,\s]/g, '');
                        return !isNaN(cleanVal) && !isNaN(parseFloat(cleanVal));
                    }
                    return false;
                });
            }
            
            // Generate columns configuration
            const columns = originalHeaders.map(originalHeader => {
                const displayTitle = COLUMN_MAPPINGS[originalHeader.toLowerCase()] || originalHeader;
                const isNumeric = isNumericColumn(originalHeader);
                
                return {
                    title: displayTitle,
                    field: originalHeader,
                    headerFilter: "input",
                    sorter: isNumeric ? "number" : "string",
                    tooltip: true,
                    headerFilterPlaceholder: `جستجو در ${displayTitle}...`,
                    bottomCalc: isNumeric ? "sum" : undefined,
                    bottomCalcFormatter: isNumeric ? function(cell) {
                        const value = cell.getValue();
                        if (value === null || value === undefined || isNaN(value)) {
                            return '<strong">0</strong>';
                        }
                        
                        let formattedValue;
                        if (displayTitle.includes('حقوق') || displayTitle.includes('قیمت') || displayTitle.includes('مجموع')) {
                            formattedValue = parseFloat(value).toLocaleString('fa-IR') + ' تومان';
                        } else {
                            formattedValue = parseFloat(value).toLocaleString('fa-IR', {
                                maximumFractionDigits: 2,
                                minimumFractionDigits: 0
                            });
                        }
                        
                        return '<strong>' + formattedValue + '</strong>';
                    } : undefined,
                    formatter: function(cell) {
                        const value = cell.getValue();
                        if (value === null || value === undefined || value === '') {
                            return '<span style="color: #999; font-style: italic;">خالی</span>';
                        }
                        
                        // Format numbers with Persian locale
                        if (isNumeric && !isNaN(value)) {
                            if (displayTitle.includes('حقوق') || displayTitle.includes('قیمت') || displayTitle.includes('مجموع')) {
                                return parseFloat(value).toLocaleString('fa-IR') + ' تومان';
                            } else {
                                return parseFloat(value).toLocaleString('fa-IR', {
                                    maximumFractionDigits: 2,
                                    minimumFractionDigits: 0
                                });
                            }
                        }
                        
                        return value;
                    }
                };
            });
            
            // Add entry_type column formatting
            columns.push({
                title: 'نوع تراکنش',
                field: 'entry_type',
                formatter: function(cell) {
                    return ENTRY_TYPE_FORMATS[cell.getValue()] || cell.getValue();
                }
            });
            
            // Create or update table
            if (table) {
                table.destroy();
            }
            
            table = new Tabulator("#csvTable", {
                data: csvData,
                columns: columns,
                layout: "fitData",
                responsiveLayout: "collapse",
                rowFormatter: function(row) {
                    const entryType = row.getData().entry_type;
                    if (entryType) {
                        const element = row.getElement();
                        element.classList.remove("row-principal-deposit", "row-principal-withdrawal", "row-profit-accrual");
                        element.classList.add("row-" + entryType);
                        // console.log("Added class:", "row-" + entryType); // برای اطمینان از اجرای کد
                    }
                },
                initialSort: [
                    {column: "date_shamsi", dir: "desc"} // مرتب‌سازی بر اساس تاریخ
                ],
                groupBy: "period_label", // گروه‌بندی اولیه بر اساس دوره
                pagination: true,
                paginationSize: 50,
                paginationSizeSelector: [10, 25, 50, 100, true],
                movableColumns: true,
                resizableRows: true,
                tooltipsHeader: true,
                printAsHtml: true,
                printVisibleRows: false,
                columnCalcs: "bottom",
                downloadConfig: {
                    columnHeaders: true,
                    columnGroups: false,
                    rowGroups: false,
                    columnCalcs: true,
                    dataTree: false,
                },
                locale: true,
                langs: {
                    "default": {
                        "pagination": {
                            "page_size": "اندازه صفحه",
                            "first": "اول",
                            "first_title": "صفحه اول",
                            "last": "آخر",
                            "last_title": "صفحه آخر",
                            "prev": "قبلی",
                            "prev_title": "صفحه قبلی",
                            "next": "بعدی",
                            "next_title": "صفحه بعدی",
                            "all": "همه"
                        },
                        "data": {
                            "loading": "در حال بارگذاری...",
                            "error": "خطا"
                        }
                    }
                }
            });
            
            // Update group by dropdown
            updateGroupByDropdown(originalHeaders);
            
            // Update stats
            updateStats();
            
            // Show stats section
            document.getElementById('statsContainer').style.display = 'block';
            
            showLoading(false);
            
            // Table event listeners
            table.on("dataFiltered", updateStats);
        }
        
        function updateGroupByDropdown(headers) {
            const menu = document.getElementById('groupByMenu');
            menu.innerHTML = '';
            
            // Add "no grouping" option
            const noneItem = document.createElement('div');
            noneItem.className = 'item';
            noneItem.setAttribute('data-value', '');
            noneItem.innerHTML = '<i class="unlink icon"></i>بدون گروه‌بندی';
            menu.appendChild(noneItem);
            
            // Add header options
            headers.forEach(header => {
                const displayTitle = COLUMN_MAPPINGS[header.toLowerCase()] || header;
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-value', header);
                item.innerHTML = `<i class="tags icon"></i>${displayTitle}`;
                menu.appendChild(item);
            });
            
            // Reinitialize dropdown
            $('#groupByDropdown').dropdown('refresh');
        }
        
        function updateStats() {
            if (!table) return;
            
            const filteredData = table.getData();
            
            // محاسبه مجموع‌ها
            const deposits = filteredData
                .filter(row => row.entry_type === 'principal_deposit')
                .reduce((sum, row) => sum + row.amount, 0);
                
            const withdrawals = filteredData
                .filter(row => row.entry_type === 'principal_withdrawal')
                .reduce((sum, row) => sum + row.amount, 0);
                
            const profits = filteredData
                .filter(row => row.entry_type === 'profit_accrual')
                .reduce((sum, row) => sum + row.amount, 0);

            // بروزرسانی نمایش
            document.getElementById('totalRows').textContent = 
                filteredData.length.toLocaleString('fa-IR');
                
            document.getElementById('totalColumns').textContent = 
                table.getColumnDefinitions().length.toLocaleString('fa-IR');
                
            document.getElementById('totalDeposits').textContent = 
                Math.abs(deposits).toLocaleString('fa-IR');
                
            document.getElementById('totalWithdrawals').textContent = 
                Math.abs(withdrawals).toLocaleString('fa-IR');
                
            document.getElementById('totalProfits').textContent = 
                Math.abs(profits).toLocaleString('fa-IR');
        }
        
        function exportToCSV() {
            if (!table) {
                showError('هیچ داده‌ای برای دانلود موجود نیست');
                return;
            }
            table.download("csv", "data.csv");
        }
        
        function exportToJSON() {
            if (!table) {
                showError('هیچ داده‌ای برای دانلود موجود نیست');
                return;
            }
            table.download("json", "data.json");
        }
        
        function clearGrouping() {
            if (!table) return;
            table.setGroupBy(false);
            $('#groupByDropdown').dropdown('clear');
        }
        
        function showLoading(show) {
            document.getElementById('loadingContainer').style.display = show ? 'block' : 'none';
            document.getElementById('csvTable').style.display = show ? 'none' : 'block';
        }
        
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            $('#errorMessage').transition('fade in');
        }
        
        function hideError() {
            $('#errorMessage').transition('fade out');
        }
        
        // Modal management functions
        function showAddRecordModal() {
            // Update project info display
            document.getElementById('projectStartDate').textContent = PROJECT_CONFIG.startDate;
            document.getElementById('projectEndDate').textContent = PROJECT_CONFIG.endDate;
            document.getElementById('dailyProfitRate').textContent = (PROJECT_CONFIG.dailyProfitRate * 100) + '%';
            
            // Reset form and show modal
            resetAddRecordForm();
            $('#addRecordModal').modal('show');
        }
        
        function closeAddRecordModal() {
            $('#addRecordModal').modal('hide');
            resetAddRecordForm();
        }
        
        function resetAddRecordForm() {
            document.getElementById('addRecordForm').reset();
            $('#investorDropdown').dropdown('clear');
            $('#periodDropdown').dropdown('clear');
            $('#entryTypeDropdown').dropdown('clear');
            document.getElementById('projectIdInput').value = PROJECT_CONFIG.projectId;
            hideProfitCalculation();
        }
        
        function showProfitCalculation() {
            document.getElementById('profitCalculationSection').style.display = 'block';
        }
        
        function hideProfitCalculation() {
            document.getElementById('profitCalculationSection').style.display = 'none';
        }
        
        function calculateProfit() {
            const amount = parseFloat(document.getElementById('amountInput').value);
            const dateShamsi = document.getElementById('dateShamsiInput').value;
            
            if (!amount || amount <= 0 || !dateShamsi) {
                hideProfitCalculation();
                return;
            }
            
            // Validate date format
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(dateShamsi)) {
                hideProfitCalculation();
                return;
            }
            
            // Calculate days to project end
            const daysToEnd = calculateDaysToProjectEnd(dateShamsi);
            
            if (daysToEnd < 0) {
                hideProfitCalculation();
                return;
            }
            
            // Calculate profit
            const profit = amount * PROJECT_CONFIG.dailyProfitRate * daysToEnd;
            const totalAmount = amount + profit;
            
            // Update display
            document.getElementById('daysToEnd').textContent = daysToEnd.toLocaleString('fa-IR');
            document.getElementById('calculatedProfit').textContent = profit.toLocaleString('fa-IR', {
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            });
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString('fa-IR', {
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            });
            
            showProfitCalculation();
        }
        
        function calculateDaysToProjectEnd(dateShamsi) {
            // Convert Shamsi date to days since project start
            const projectStartDays = shamsiDateToDays(PROJECT_CONFIG.startDate);
            const projectEndDays = shamsiDateToDays(PROJECT_CONFIG.endDate);
            const inputDateDays = shamsiDateToDays(dateShamsi);
            
            // Calculate days remaining to project end
            return projectEndDays - inputDateDays;
        }
        
        function shamsiDateToDays(dateString) {
            // Convert Shamsi date (YYYY-MM-DD) to days since year 1400
            const [year, month, day] = dateString.split('-').map(Number);
            
            // Simple conversion - you can implement more sophisticated Persian calendar logic
            // For now, assuming 365 days per year and 30 days per month
            const daysSince1400 = (year - 1400) * 365 + (month - 1) * 30 + day;
            return daysSince1400;
        }
        
        function updateInvestorsDropdown() {
            const menu = document.getElementById('investorMenu');
            menu.innerHTML = '';
            
            investorsList.forEach(investor => {
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-value', investor);
                item.textContent = investor;
                menu.appendChild(item);
            });
            
            $('#investorDropdown').dropdown('refresh');
        }
        
        function updatePeriodsDropdown() {
            const menu = document.getElementById('periodMenu');
            menu.innerHTML = '';
            
            periodsList.forEach(period => {
                const item = document.createElement('div');
                item.className = 'item';
                item.setAttribute('data-value', period);
                item.textContent = period;
                menu.appendChild(item);
            });
            
            $('#periodDropdown').dropdown('refresh');
        }
        
        function addNewRecord() {
            // Get form values
            const investorName = document.getElementById('investorInput').value;
            const periodLabel = document.getElementById('periodInput').value;
            const entryType = document.getElementById('entryTypeInput').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const dateShamsi = document.getElementById('dateShamsiInput').value;
            const projectId = document.getElementById('projectIdInput').value;
            
            // Validation
            if (!investorName || !periodLabel || !entryType || !amount || !dateShamsi || !projectId) {
                showError('لطفاً تمام فیلدها را پر کنید');
                return;
            }
            
            if (amount <= 0) {
                showError('مبلغ باید بزرگتر از صفر باشد');
                return;
            }
            
            // Validate date format (YYYY-MM-DD)
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(dateShamsi)) {
                showError('فرمت تاریخ باید YYYY-MM-DD باشد (مثال: 1402-05-16)');
                return;
            }
            
            // Calculate profit
            const daysToEnd = calculateDaysToProjectEnd(dateShamsi);
            if (daysToEnd < 0) {
                showError('تاریخ وارد شده بعد از پایان پروژه است');
                return;
            }
            
            const profit = amount * PROJECT_CONFIG.dailyProfitRate * daysToEnd;
            
            // Create principal record
            const principalRecord = {
                project_id: projectId,
                row_index: (csvData.length + 1).toString(),
                period_label: periodLabel,
                day_remaining: daysToEnd,
                day_from_start: calculateDayFromStart(dateShamsi),
                date_shamsi: dateShamsi,
                date_gregorian: convertShamsiToGregorian(dateShamsi),
                investor_name: investorName,
                entry_type: entryType,
                amount: amount
            };
            
            // Create profit record
            const profitRecord = {
                project_id: projectId,
                row_index: (csvData.length + 2).toString(),
                period_label: periodLabel,
                day_remaining: daysToEnd,
                day_from_start: calculateDayFromStart(dateShamsi),
                date_shamsi: dateShamsi,
                date_gregorian: convertShamsiToGregorian(dateShamsi),
                investor_name: investorName,
                entry_type: 'profit_accrual',
                amount: profit
            };
            
            // Add both records to data
            csvData.push(principalRecord);
            csvData.push(profitRecord);
            originalData.push(principalRecord);
            originalData.push(profitRecord);
            
            // Update table
            if (table) {
                table.setData(csvData);
            }
            
            // Update stats
            updateStats();
            
            // Close modal and show success message
            closeAddRecordModal();
            showSuccessMessage(`رکورد ${entryType === 'principal_deposit' ? 'واریز' : 'برداشت'} و سود با موفقیت اضافه شد. مبلغ سود: ${profit.toLocaleString('fa-IR')} ریال`);
            
            // Export updated data to CSV
            exportUpdatedData();
        }
        
        function calculateDayFromStart(dateShamsi) {
            // Calculate days from project start using Shamsi dates
            const projectStartDays = shamsiDateToDays(PROJECT_CONFIG.startDate);
            const targetDateDays = shamsiDateToDays(dateShamsi);
            const diffDays = targetDateDays - projectStartDays;
            return Math.max(1, diffDays);
        }
        
        function convertShamsiToGregorian(dateShamsi) {
            // Convert Shamsi date to Gregorian date
            // This is a simplified conversion - you can implement more sophisticated Persian calendar logic
            const [year, month, day] = dateShamsi.split('-').map(Number);
            
            // Approximate conversion: Shamsi year 1402 corresponds to Gregorian year 2023
            // This is a rough approximation and should be improved for production use
            const gregorianYear = year + 621;
            
            // Format with leading zeros
            const formattedMonth = month.toString().padStart(2, '0');
            const formattedDay = day.toString().padStart(2, '0');
            
            return `${gregorianYear}-${formattedMonth}-${formattedDay}`;
        }
        
        function showSuccessMessage(message) {
            // Create success message
            const successDiv = document.createElement('div');
            successDiv.className = 'ui positive message';
            successDiv.innerHTML = `
                <i class="close icon"></i>
                <div class="header">موفقیت</div>
                <p>${message}</p>
            `;
            
            // Insert after header
            const headerSection = document.querySelector('.header-section');
            headerSection.parentNode.insertBefore(successDiv, headerSection.nextSibling);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
            
            // Close button functionality
            successDiv.querySelector('.close.icon').addEventListener('click', () => {
                successDiv.remove();
            });
        }
        
        function exportUpdatedData() {
            // Create CSV content with proper formatting
            const headers = ['project_id', 'row_index', 'period_label', 'day_remaining', 'day_from_start', 'date_shamsi', 'date_gregorian', 'investor_name', 'entry_type', 'amount'];
            const csvContent = [
                headers.join(','),
                ...csvData.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        // Handle different data types properly
                        if (value === null || value === undefined) {
                            return '';
                        }
                        
                        if (typeof value === 'number') {
                            // For amounts, preserve decimal places
                            if (header === 'amount') {
                                return value.toFixed(10); // Match original format
                            }
                            return value.toString();
                        }
                        
                        // Escape commas and quotes in CSV strings
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'data_updated.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Sample data for testing (fallback)
        function loadSampleData() {
            console.log('Loading sample data as fallback...');
            
            const sampleData = [
                { name: 'علی احمدی', age: 28, city: 'تهران', job: 'برنامه‌نویس', salary: 25000000, score: 85.5 },
                { name: 'فاطمه محمدی', age: 32, city: 'اصفهان', job: 'مهندس', salary: 30000000, score: 92.0 },
                { name: 'حسن رضایی', age: 25, city: 'مشهد', job: 'طراح', salary: 20000000, score: 78.5 },
                { name: 'زهرا کریمی', age: 29, city: 'تهران', job: 'برنامه‌نویس', salary: 27000000, score: 88.0 },
                { name: 'محمد فریدی', age: 35, city: 'شیراز', job: 'مدیر', salary: 40000000, score: 95.5 },
                { name: 'نرگس حسینی', age: 26, city: 'تبریز', job: 'طراح', salary: 22000000, score: 82.0 },
                { name: 'رضا مرادی', age: 31, city: 'تهران', job: 'مهندس', salary: 35000000, score: 90.5 }
            ];
            
            // Convert to match expected format
            originalData = sampleData;
            csvData = [...originalData];
            
            // Process with existing function
            const fakeResults = {
                data: sampleData,
                errors: []
            };
            
            processCSVData(fakeResults);
        }
        
        // Initialize Persian Datepicker
        $("#dateShamsiInput").persianDatepicker({
            format: 'YYYY-MM-DD',
            initialValue: false
        });

        // Calculate Profit
        document.getElementById('calculateProfit').addEventListener('click', function() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const dailyProfit = parseFloat(document.getElementById('dailyProfit').value);

            if (startDate && endDate && !isNaN(dailyProfit)) {
                const start = new persianDate(startDate).toDate();
                const end = new persianDate(endDate).toDate();
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                const profit = days * dailyProfit;

                alert(`سود محاسبه شده: ${profit} درصد`);
            } else {
                alert('لطفاً تمام فیلدها را پر کنید.');
            }
        });

        // Save Data
        document.getElementById('saveData').addEventListener('click', function() {
            // Fetch the current data from the table
            const tableData = table.getData();

            // Convert the data to CSV format
            const csvContent = Papa.unparse(tableData, {
                header: true
            });

            // Use the File System API to overwrite the existing CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'data.csv'; // Overwrite the same file
            link.click();

            alert('اطلاعات به فایل اصلی اضافه شد!');
        });
    </script>
</body>
</html>