<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گزارش مالی سرمایه‌گذار</title>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Vazir Font CSS -->
    <link rel="stylesheet" href="/static/fonts/vazir.css">
    
    <style>
        :root {
            /* رنگ‌های استاندارد مالی پروژه */
            --deposit-color: #2185d0;
            --withdrawal-color: #db2828;
            --profit-color: #21ba45;
            --capital-color: #667eea;
            --expense-color: #dc3545;
            --balance-color: #6c757d;
            
            /* رنگ‌های پایه */
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --bg-card: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazir', 'Tahoma', Arial, sans-serif;
            background: #f8f9fa;
            padding: 20px;
            direction: rtl;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Header Section */
        .report-header {
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 3px solid var(--primary-color);
            margin-bottom: 30px;
        }

        .report-header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .report-header .date {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Investor Info Section */
        .investor-info-box {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .investor-info-box .investor-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .investor-info-box .investor-details {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .investor-info-box .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Stats Grid */
        .stats-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-card p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* رنگ‌بندی کارت‌های مالی */
        .stat-card.deposit {
            border-color: var(--deposit-color);
            background: linear-gradient(135deg, rgba(33, 133, 208, 0.1), rgba(33, 133, 208, 0.05));
        }

        .stat-card.deposit h4 {
            color: var(--deposit-color);
        }

        .stat-card.withdrawal {
            border-color: var(--withdrawal-color);
            background: linear-gradient(135deg, rgba(219, 40, 40, 0.1), rgba(219, 40, 40, 0.05));
        }

        .stat-card.withdrawal h4 {
            color: var(--withdrawal-color);
        }

        .stat-card.capital {
            border-color: var(--capital-color);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(102, 126, 234, 0.05));
        }

        .stat-card.capital h4 {
            color: var(--capital-color);
        }

        .stat-card.profit {
            border-color: var(--profit-color);
            background: linear-gradient(135deg, rgba(33, 186, 69, 0.1), rgba(33, 186, 69, 0.05));
        }

        .stat-card.profit h4 {
            color: var(--profit-color);
        }

        /* Transactions Table */
        .transactions-section {
            margin-top: 40px;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .transactions-table th,
        .transactions-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .transactions-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: bold;
        }

        .transactions-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .transactions-table tbody tr:hover {
            background: #e9ecef;
        }

        /* Transaction Type Colors */
        .transaction-type {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            display: inline-block;
        }

        .transaction-type.principal_deposit {
            background: rgba(33, 133, 208, 0.2);
            color: var(--deposit-color);
        }

        .transaction-type.principal_withdrawal {
            background: rgba(219, 40, 40, 0.2);
            color: var(--withdrawal-color);
        }

        .transaction-type.profit_accrual {
            background: rgba(33, 186, 69, 0.2);
            color: var(--profit-color);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-family: 'Vazir', 'Tahoma', Arial, sans-serif;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--profit-color);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 186, 69, 0.3);
        }

        /* Print Styles */
        /* Print Styles - بهینه شده برای PDF چند صفحه‌ای */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                max-width: 100%;
            }

            /* مخفی کردن دکمه‌ها و راهنما */
            .action-buttons {
                display: none !important;
            }

            .action-buttons + div {
                display: none !important;
            }

            /* جلوگیری از شکستن کارت‌ها و بخش‌ها */
            .stat-card,
            .stats-section,
            .investor-info-box,
            .report-header {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            /* حفظ استایل بخش نرخ سود در چاپ */
            .stats-section[style*="border: 2px solid"] {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* جلوگیری از شکستن عنوان بخش از محتوای آن */
            .section-title {
                break-after: avoid;
                page-break-after: avoid;
            }

            /* کاهش فاصله‌ها برای چاپ */
            .stats-section {
                margin-bottom: 20px;
            }

            .stats-grid {
                gap: 10px;
            }

            .stat-card {
                padding: 10px;
                margin-bottom: 5px;
            }

            .stat-card h4 {
                font-size: 1.2rem;
            }

            .stat-card p {
                font-size: 0.8rem;
            }

            /* بهینه‌سازی جدول برای چاپ */
            .transactions-table {
                width: 100%;
                font-size: 0.85rem;
            }

            .transactions-table th,
            .transactions-table td {
                padding: 8px 6px;
            }

            /* جلوگیری از شکستن سطرهای جدول */
            .transactions-table tr {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            /* حفظ رنگ‌ها در چاپ */
            .stat-card.deposit,
            .stat-card.withdrawal,
            .stat-card.capital,
            .stat-card.profit,
            .transaction-type,
            .investor-info-box {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* استایل هدر جدول */
            .transactions-table thead {
                display: table-header-group;
            }

            .transactions-table tbody {
                display: table-row-group;
            }

            /* حذف سایه‌ها در چاپ */
            * {
                box-shadow: none !important;
            }

            /* فوتر در انتهای هر صفحه */
            .report-footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                text-align: center;
                font-size: 0.7rem;
                border-top: 1px solid #ddd;
                padding-top: 5px;
            }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--primary-color);
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Footer */
        .report-footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .report-footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .report-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container" id="reportContent">
        <!-- Report Header -->
        <div class="report-header">
            <h1><i class="fas fa-file-invoice-dollar"></i> گزارش مالی سرمایه‌گذار</h1>
            <div class="date" id="reportDate">تاریخ گزارش: -</div>
        </div>

        <!-- Action Buttons (Hidden in print) -->
        <div class="action-buttons" id="actionButtons">
            <button class="btn btn-primary" onclick="generatePDF()" title="کلیک کنید تا پنجره چاپ باز شود. سپس 'ذخیره به عنوان PDF' را انتخاب کنید">
                <i class="fas fa-file-pdf"></i>
                ذخیره به عنوان PDF
            </button>
            <a href="/dashboard/investor-profile/" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i>
                بازگشت به پروفایل
            </a>
        </div>
        <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">
            <i class="fas fa-info-circle"></i>
            برای ذخیره گزارش به صورت PDF، روی دکمه بالا کلیک کنید و در پنجره چاپ، گزینه "Save as PDF" یا "ذخیره به عنوان PDF" را انتخاب نمایید
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <i class="fas fa-spinner"></i>
            <p>در حال بارگذاری اطلاعات...</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Investor Info Box -->
            <div class="investor-info-box">
                <div class="investor-name" id="investorName">نام سرمایه‌گذار</div>
                <div class="investor-details">
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span id="investorPhone">-</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <span id="contractDate">تاریخ قرارداد: -</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-building"></i>
                        <span id="unitName">واحد: -</span>
                    </div>
                </div>
            </div>

            <!-- Interest Rate Info -->
            <div class="stats-section" style="background: linear-gradient(135deg, rgba(33, 186, 69, 0.05), rgba(33, 186, 69, 0.02)); border: 2px solid var(--profit-color); border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <h3 style="margin: 0; color: var(--profit-color); font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-percentage"></i>
                            نرخ سود مشارکت روزانه
                        </h3>
                        <p style="margin: 10px 0 0 0; font-size: 2rem; font-weight: bold; color: var(--profit-color);" id="activeInterestRate">-</p>
                    </div>
                    <div style="flex: 1; min-width: 300px;">
                        <div style="background: rgba(255, 193, 7, 0.1); border-right: 4px solid #ffc107; padding: 15px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.8; color: var(--text-primary);">
                                <i class="fas fa-exclamation-triangle" style="color: #ffc107; margin-left: 5px;"></i>
                                <strong>توجه:</strong> مبالغ سود مشارکت در این گزارش با نرخ سود روزانه فوق محاسبه شده‌اند. 
                                در صورت تغییر نرخ سود مشارکت، مبالغ سود تراکنش‌ها نیز تغییر خواهند کرد. 
                                تاریخ اعمال: <span id="interestRateEffectiveDate" style="font-weight: bold;">-</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Stats Section -->
            <div class="stats-section">
                <h3 class="section-title">
                    <i class="fas fa-wallet"></i>
                    اطلاعات مالی سرمایه‌گذار
                </h3>
                <div class="stats-grid">
                    <div class="stat-card deposit">
                        <h4 id="totalPrincipal">-</h4>
                        <p>کل آورده (تومان)</p>
                    </div>
                    <div class="stat-card withdrawal">
                        <h4 id="totalWithdrawal">-</h4>
                        <p>کل برداشت (تومان)</p>
                    </div>
                    <div class="stat-card capital">
                        <h4 id="netPrincipal">-</h4>
                        <p>سرمایه موجود (تومان)</p>
                    </div>
                    <div class="stat-card profit">
                        <h4 id="totalProfit">-</h4>
                        <p>کل سود (تومان)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="totalBalance">-</h4>
                        <p>سرمایه+سود مشارکت (تومان)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="capitalRatio">-</h4>
                        <p>نسبت سرمایه به سرمایه کل</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="profitRatioToTotal">-</h4>
                        <p>نسبت سود به سود کل</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="totalRatioToGrandTotal">-</h4>
                        <p>نسبت (سرمایه+سود) به کل</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="profitIndex">-</h4>
                        <p>شاخص نفع</p>
                    </div>
                </div>
            </div>

            <!-- Unit Info Section -->
            <div class="stats-section">
                <h3 class="section-title">
                    <i class="fas fa-building"></i>
                    اطلاعات واحد انتخاب شده
                </h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4 id="unitAreaDisplay">-</h4>
                        <p>مساحت واحد (متر مربع)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="totalUnitsPrice">-</h4>
                        <p>قیمت واحد (تومان)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="ownershipArea">-</h4>
                        <p>مالکیت (متر مربع)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="finalPayment">-</h4>
                        <p>پرداخت نهایی جهت تسویه (تومان)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="transferPricePerMeter">-</h4>
                        <p>قیمت واگذار شده (تومان/متر مربع)</p>
                    </div>
                </div>
            </div>

            <!-- Transactions Section -->
            <div class="transactions-section">
                <h3 class="section-title">
                    <i class="fas fa-list"></i>
                    لیست تراکنش‌های مالی
                </h3>
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>ردیف</th>
                            <th>تاریخ</th>
                            <th>نوع تراکنش</th>
                            <th>مبلغ (تومان)</th>
                            <th>توضیحات</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Report Footer
        <div class="report-footer">
            <p>© 2024 سیستم مدیریت ساخت و ساز | توسعه یافته توسط <a href="https://royasoftteam.ir" target="_blank"><i class="fas fa-code"></i> RoyaSoftTeam</a></p>
        </div> -->
    </div>

    <script>
        // Format number with commas
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return '0';
            }
            return Math.round(num).toLocaleString('en-US');
        }

        // Get current date in Persian format
        function getCurrentPersianDate() {
            const date = new Date();
            return date.toLocaleDateString('fa-IR');
        }

        // Get investor ID from URL
        function getInvestorIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('investor_id');
        }

        // Translate transaction type
        function getTransactionTypeLabel(type) {
            const types = {
                'principal_deposit': 'آورده',
                'principal_withdrawal': 'برداشت',
                'profit_accrual': 'سود مشارکت'
            };
            return types[type] || type;
        }

        // Load investor data
        async function loadInvestorData() {
            const investorId = getInvestorIdFromURL();
            
            if (!investorId) {
                document.getElementById('loadingState').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>شناسه سرمایه‌گذار مشخص نشده است</p>
                        <a href="/dashboard/investor-profile/" class="btn btn-primary">بازگشت به پروفایل</a>
                    </div>
                `;
                return;
            }

            try {
                // Fetch investor data
                const investorResponse = await fetch(`/construction/api/v1/Investor/${investorId}/`);
                if (!investorResponse.ok) throw new Error('خطا در دریافت اطلاعات سرمایه‌گذار');
                const investor = await investorResponse.json();

                // Fetch transactions
                const transactionsResponse = await fetch(`/construction/api/v1/Transaction/?investor=${investorId}`);
                if (!transactionsResponse.ok) throw new Error('خطا در دریافت تراکنش‌ها');
                const transactions = await transactionsResponse.json();

                // Fetch global statistics for ratios
                const statsResponse = await fetch('/construction/api/v1/Transaction/statistics/');
                let globalStats = null;
                if (statsResponse.ok) {
                    globalStats = await statsResponse.json();
                }

                // Fetch active interest rate
                const interestRateResponse = await fetch('/construction/api/v1/InterestRate/');
                let activeInterestRate = null;
                if (interestRateResponse.ok) {
                    const interestRates = await interestRateResponse.json();
                    // Find active interest rate
                    activeInterestRate = interestRates.find(rate => rate.is_active === true);
                }

                // Calculate financial metrics
                const principalDeposits = transactions.filter(t => t.transaction_type === 'principal_deposit');
                const principalWithdrawals = transactions.filter(t => t.transaction_type === 'principal_withdrawal');
                const profitAccruals = transactions.filter(t => t.transaction_type === 'profit_accrual');

                const totalPrincipal = principalDeposits.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const totalWithdrawal = Math.abs(principalWithdrawals.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0));
                const totalProfit = profitAccruals.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const netPrincipal = totalPrincipal - totalWithdrawal;
                const totalBalance = netPrincipal + totalProfit;

                // Calculate ratios
                let capitalRatio = '0.00%';
                let profitRatioToTotal = '0.00%';
                let totalRatioToGrandTotal = '0.00%';
                let profitIndex = '0.00';

                if (globalStats) {
                    const totalCapital = parseFloat(globalStats.total_deposits || 0) - Math.abs(parseFloat(globalStats.total_withdrawals || 0));
                    const totalGlobalProfit = parseFloat(globalStats.total_profits || 0);
                    const grandTotal = totalCapital + totalGlobalProfit;

                    if (totalCapital > 0) {
                        capitalRatio = ((netPrincipal / totalCapital) * 100).toFixed(2) + '%';
                    }
                    if (totalGlobalProfit > 0) {
                        profitRatioToTotal = ((totalProfit / totalGlobalProfit) * 100).toFixed(2) + '%';
                    }
                    if (grandTotal > 0) {
                        totalRatioToGrandTotal = ((totalBalance / grandTotal) * 100).toFixed(2) + '%';
                    }
                    
                    // Calculate profit index
                    const capitalRatioNum = totalCapital > 0 ? (netPrincipal / totalCapital) : 0;
                    const profitRatioNum = totalGlobalProfit > 0 ? (totalProfit / totalGlobalProfit) : 0;
                    if (capitalRatioNum > 0) {
                        profitIndex = (profitRatioNum / capitalRatioNum).toFixed(2);
                    }
                }

                // Get unit information
                let unitInfo = {
                    name: 'نامشخص',
                    area: 0,
                    price: 0,
                    ownership_area: 0
                };

                if (investor.units && investor.units.length > 0) {
                    const unit = investor.units[0];
                    unitInfo = {
                        name: unit.name || 'نامشخص',
                        area: parseFloat(unit.area) || 0,
                        price: parseFloat(unit.total_price) || 0,
                        ownership_area: parseFloat(unit.area) || 0
                    };
                }

                // Calculate unit-related metrics
                const finalPayment = unitInfo.price - netPrincipal;
                const transferPricePerMeter = unitInfo.area > 0 ? netPrincipal / unitInfo.area : 0;

                // Update UI
                document.getElementById('reportDate').textContent = `تاریخ گزارش: ${getCurrentPersianDate()}`;
                document.getElementById('investorName').textContent = `${investor.first_name} ${investor.last_name}`;
                document.getElementById('investorPhone').textContent = investor.phone || 'ثبت نشده';
                document.getElementById('contractDate').textContent = `تاریخ قرارداد: ${investor.contract_date_shamsi || 'ثبت نشده'}`;
                document.getElementById('unitName').textContent = `واحد: ${unitInfo.name}`;

                // Interest Rate
                if (activeInterestRate) {
                    document.getElementById('activeInterestRate').textContent = `${activeInterestRate.rate}%`;
                    document.getElementById('interestRateEffectiveDate').textContent = activeInterestRate.effective_date_display || activeInterestRate.effective_date || '-';
                } else {
                    document.getElementById('activeInterestRate').textContent = 'تعیین نشده';
                    document.getElementById('interestRateEffectiveDate').textContent = '-';
                }

                // Financial stats
                document.getElementById('totalPrincipal').textContent = formatNumber(totalPrincipal);
                document.getElementById('totalWithdrawal').textContent = formatNumber(totalWithdrawal);
                document.getElementById('netPrincipal').textContent = formatNumber(netPrincipal);
                document.getElementById('totalProfit').textContent = formatNumber(totalProfit);
                document.getElementById('totalBalance').textContent = formatNumber(totalBalance);
                document.getElementById('capitalRatio').textContent = capitalRatio;
                document.getElementById('profitRatioToTotal').textContent = profitRatioToTotal;
                document.getElementById('totalRatioToGrandTotal').textContent = totalRatioToGrandTotal;
                document.getElementById('profitIndex').textContent = profitIndex;

                // Unit stats
                document.getElementById('unitAreaDisplay').textContent = formatNumber(unitInfo.area);
                document.getElementById('totalUnitsPrice').textContent = formatNumber(unitInfo.price);
                document.getElementById('ownershipArea').textContent = formatNumber(unitInfo.ownership_area);
                document.getElementById('finalPayment').textContent = formatNumber(finalPayment);
                document.getElementById('transferPricePerMeter').textContent = formatNumber(transferPricePerMeter);

                // Load transactions table with sorting
                const tableBody = document.getElementById('transactionsTableBody');
                if (transactions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5">هیچ تراکنشی ثبت نشده است</td></tr>';
                } else {
                    // Define transaction type priority
                    const transactionTypePriority = {
                        'principal_deposit': 1,
                        'principal_withdrawal': 2,
                        'profit_accrual': 3
                    };

                    // Sort transactions by Shamsi date, day_from_start, then by transaction type
                    const sortedTransactions = [...transactions].sort((a, b) => {
                        // Compare by day_from_start (روز از شروع)
                        const dayFromStartA = parseInt(a.day_from_start) || 0;
                        const dayFromStartB = parseInt(b.day_from_start) || 0;
                        
                        if (dayFromStartA !== dayFromStartB) {
                            return dayFromStartA - dayFromStartB;
                        }
                        
                        // If day_from_start is equal, compare Shamsi dates
                        const dateShamsiA = a.date_shamsi || '';
                        const dateShamsiB = b.date_shamsi || '';
                        
                        if (dateShamsiA !== dateShamsiB) {
                            // Convert Shamsi date to comparable format (YYYY/MM/DD -> YYYYMMDD)
                            const dateNumA = dateShamsiA.replace(/\//g, '');
                            const dateNumB = dateShamsiB.replace(/\//g, '');
                            return dateNumA.localeCompare(dateNumB);
                        }
                        
                        // If dates are equal, sort by transaction type
                        const priorityA = transactionTypePriority[a.transaction_type] || 999;
                        const priorityB = transactionTypePriority[b.transaction_type] || 999;
                        return priorityA - priorityB;
                    });

                    tableBody.innerHTML = sortedTransactions.map((t, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${t.date_shamsi || t.date}</td>
                            <td><span class="transaction-type ${t.transaction_type}">${getTransactionTypeLabel(t.transaction_type)}</span></td>
                            <td>${formatNumber(Math.abs(t.amount))}</td>
                            <td>${t.description || '-'}</td>
                        </tr>
                    `).join('');
                }

                // Show main content
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>خطا در بارگذاری اطلاعات: ${error.message}</p>
                        <a href="/dashboard/investor-profile/" class="btn btn-primary">بازگشت به پروفایل</a>
                    </div>
                `;
            }
        }

        // Generate PDF using browser print dialog
        function generatePDF() {
            // تنظیم عنوان سند برای نام فایل PDF
            const investorName = document.getElementById('investorName').textContent;
            const originalTitle = document.title;
            document.title = `گزارش_مالی_${investorName}_${getCurrentPersianDate()}`;
            
            // فراخوانی دیالوگ چاپ مرورگر
            window.print();
            
            // بازگرداندن عنوان اصلی
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', loadInvestorData);
    </script>
</body>
</html>

