<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±</title>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Vazir Font CSS -->
    <link rel="stylesheet" href="/static/fonts/vazir.css">
    
    <style>
        :root {
            /* Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù…Ø§Ù„ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ */
            --deposit-color: #2185d0;
            --withdrawal-color: #db2828;
            --profit-color: #21ba45;
            --capital-color: #667eea;
            --expense-color: #dc3545;
            --balance-color: #6c757d;
            
            /* Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ */
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --bg-card: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazir', 'Tahoma', Arial, sans-serif;
            background: #f8f9fa;
            padding: 20px;
            direction: rtl;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Header Section */
        .report-header {
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 3px solid var(--primary-color);
            margin-bottom: 30px;
        }

        .report-header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .report-header .date {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Investor Info Section */
        .investor-info-box {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .investor-info-box .investor-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .investor-info-box .investor-details {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .investor-info-box .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Stats Grid */
        .stats-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-card p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ */
        .stat-card.deposit {
            border-color: var(--deposit-color);
            background: linear-gradient(135deg, rgba(33, 133, 208, 0.1), rgba(33, 133, 208, 0.05));
        }

        .stat-card.deposit h4 {
            color: var(--deposit-color);
        }

        .stat-card.withdrawal {
            border-color: var(--withdrawal-color);
            background: linear-gradient(135deg, rgba(219, 40, 40, 0.1), rgba(219, 40, 40, 0.05));
        }

        .stat-card.withdrawal h4 {
            color: var(--withdrawal-color);
        }

        .stat-card.capital {
            border-color: var(--capital-color);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(102, 126, 234, 0.05));
        }

        .stat-card.capital h4 {
            color: var(--capital-color);
        }

        .stat-card.profit {
            border-color: var(--profit-color);
            background: linear-gradient(135deg, rgba(33, 186, 69, 0.1), rgba(33, 186, 69, 0.05));
        }

        .stat-card.profit h4 {
            color: var(--profit-color);
        }

        /* Transactions Table */
        .transactions-section {
            margin-top: 40px;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .transactions-table th,
        .transactions-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .transactions-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: bold;
        }

        .transactions-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .transactions-table tbody tr:hover {
            background: #e9ecef;
        }

        /* Transaction Type Colors */
        .transaction-type {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            display: inline-block;
        }

        .transaction-type.principal_deposit {
            background: rgba(33, 133, 208, 0.2);
            color: var(--deposit-color);
        }

        .transaction-type.principal_withdrawal {
            background: rgba(219, 40, 40, 0.2);
            color: var(--withdrawal-color);
        }

        .transaction-type.profit_accrual {
            background: rgba(33, 186, 69, 0.2);
            color: var(--profit-color);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-family: 'Vazir', 'Tahoma', Arial, sans-serif;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--profit-color);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 186, 69, 0.3);
        }

        /* Print Styles */
        /* Print Styles - Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ PDF Ú†Ù†Ø¯ ØµÙØ­Ù‡â€ŒØ§ÛŒ */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                max-width: 100%;
            }

            /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ */
            .action-buttons {
                display: none !important;
            }

            .action-buttons + div {
                display: none !important;
            }

            /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ú©Ø³ØªÙ† Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ø¨Ø®Ø´â€ŒÙ‡Ø§ */
            .stat-card,
            .stats-section,
            .investor-info-box,
            .report-header {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            /* Ø­ÙØ¸ Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø®Ø´ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¯Ø± Ú†Ø§Ù¾ */
            .stats-section[style*="border: 2px solid"] {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ú©Ø³ØªÙ† Ø¹Ù†ÙˆØ§Ù† Ø¨Ø®Ø´ Ø§Ø² Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù† */
            .section-title {
                break-after: avoid;
                page-break-after: avoid;
            }

            /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ */
            .stats-section {
                margin-bottom: 20px;
            }

            .stats-grid {
                gap: 10px;
            }

            .stat-card {
                padding: 10px;
                margin-bottom: 5px;
            }

            .stat-card h4 {
                font-size: 1.2rem;
            }

            .stat-card p {
                font-size: 0.8rem;
            }

            /* Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ */
            .transactions-table {
                width: 100%;
                font-size: 0.85rem;
            }

            .transactions-table th,
            .transactions-table td {
                padding: 8px 6px;
            }

            /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ú©Ø³ØªÙ† Ø³Ø·Ø±Ù‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ */
            .transactions-table tr {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            /* Ø­ÙØ¸ Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¯Ø± Ú†Ø§Ù¾ */
            .stat-card.deposit,
            .stat-card.withdrawal,
            .stat-card.capital,
            .stat-card.profit,
            .transaction-type,
            .investor-info-box {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Ø§Ø³ØªØ§ÛŒÙ„ Ù‡Ø¯Ø± Ø¬Ø¯ÙˆÙ„ */
            .transactions-table thead {
                display: table-header-group;
            }

            .transactions-table tbody {
                display: table-row-group;
            }

            /* Ø­Ø°Ù Ø³Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ø¯Ø± Ú†Ø§Ù¾ */
            * {
                box-shadow: none !important;
            }

            /* ÙÙˆØªØ± Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ù‡Ø± ØµÙØ­Ù‡ */
            .report-footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                text-align: center;
                font-size: 0.7rem;
                border-top: 1px solid #ddd;
                padding-top: 5px;
            }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--primary-color);
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Footer */
        .report-footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .report-footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .report-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container" id="reportContent">
        <!-- Report Header -->
        <div class="report-header">
            <h1><i class="fas fa-file-invoice-dollar"></i> Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±</h1>
            <div class="date" id="reportDate">ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´: -</div>
        </div>

        <!-- Action Buttons (Hidden in print) -->
        <div class="action-buttons" id="actionButtons">
            <button class="btn btn-primary" onclick="generatePDF()" title="Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù¾Ù†Ø¬Ø±Ù‡ Ú†Ø§Ù¾ Ø¨Ø§Ø² Ø´ÙˆØ¯. Ø³Ù¾Ø³ 'Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† PDF' Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯">
                <i class="fas fa-file-pdf"></i>
                Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† PDF
            </button>
            <a href="/dashboard/investor-profile/" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i>
                Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
            </a>
        </div>
        <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">
            <i class="fas fa-info-circle"></i>
            Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ ØµÙˆØ±Øª PDFØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± Ù¾Ù†Ø¬Ø±Ù‡ Ú†Ø§Ù¾ØŒ Ú¯Ø²ÛŒÙ†Ù‡ "Save as PDF" ÛŒØ§ "Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† PDF" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <i class="fas fa-spinner"></i>
            <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Investor Info Box -->
            <div class="investor-info-box">
                <div class="investor-name" id="investorName">Ù†Ø§Ù… Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±</div>
                <div class="investor-details">
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span id="investorPhone">-</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <span id="contractDate">ØªØ§Ø±ÛŒØ® Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: -</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-building"></i>
                        <span id="unitName">ÙˆØ§Ø­Ø¯: -</span>
                    </div>
                </div>
            </div>

            <!-- Interest Rate Info -->
            <div class="stats-section" style="background: linear-gradient(135deg, rgba(33, 186, 69, 0.05), rgba(33, 186, 69, 0.02)); border: 2px solid var(--profit-color); border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <h3 style="margin: 0; color: var(--profit-color); font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-percentage"></i>
                            Ù†Ø±Ø® Ø³ÙˆØ¯ Ù…Ø´Ø§Ø±Ú©Øª Ø±ÙˆØ²Ø§Ù†Ù‡
                        </h3>
                        <p style="margin: 10px 0 0 0; font-size: 2rem; font-weight: bold; color: var(--profit-color);" id="activeInterestRate">-</p>
                    </div>
                    <div style="flex: 1; min-width: 300px;">
                        <div style="background: rgba(255, 193, 7, 0.1); border-right: 4px solid #ffc107; padding: 15px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.8; color: var(--text-primary);">
                                <i class="fas fa-exclamation-triangle" style="color: #ffc107; margin-left: 5px;"></i>
                                <strong>ØªÙˆØ¬Ù‡:</strong> Ù…Ø¨Ø§Ù„Øº Ø³ÙˆØ¯ Ù…Ø´Ø§Ø±Ú©Øª Ø¯Ø± Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡ ÙÙˆÙ‚ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯. 
                                Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ± Ù†Ø±Ø® Ø³ÙˆØ¯ Ù…Ø´Ø§Ø±Ú©ØªØŒ Ù…Ø¨Ø§Ù„Øº Ø³ÙˆØ¯ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ù†ÛŒØ² ØªØºÛŒÛŒØ± Ø®ÙˆØ§Ù‡Ù†Ø¯ Ú©Ø±Ø¯. 
                                ØªØ§Ø±ÛŒØ® Ø§Ø¹Ù…Ø§Ù„: <span id="interestRateEffectiveDate" style="font-weight: bold;">-</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Stats Section -->
            <div class="stats-section">
                <h3 class="section-title">
                    <i class="fas fa-wallet"></i>
                    Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§Ù„ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±
                </h3>
                <div class="stats-grid">
                    <div class="stat-card deposit">
                        <h4 id="totalPrincipal">-</h4>
                        <p>Ú©Ù„ Ø¢ÙˆØ±Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)</p>
                    </div>
                    <div class="stat-card withdrawal">
                        <h4 id="totalWithdrawal">-</h4>
                        <p>Ú©Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª (ØªÙˆÙ…Ø§Ù†)</p>
                    </div>
                    <div class="stat-card capital">
                        <h4 id="netPrincipal">-</h4>
                        <p>Ø³Ø±Ù…Ø§ÛŒÙ‡ Ù…ÙˆØ¬ÙˆØ¯ (ØªÙˆÙ…Ø§Ù†)</p>
                    </div>
                    <div class="stat-card profit">
                        <h4 id="totalProfit">-</h4>
                        <p>Ú©Ù„ Ø³ÙˆØ¯ (ØªÙˆÙ…Ø§Ù†)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="totalBalance">-</h4>
                        <p>Ø³Ø±Ù…Ø§ÛŒÙ‡+Ø³ÙˆØ¯ Ù…Ø´Ø§Ø±Ú©Øª (ØªÙˆÙ…Ø§Ù†)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="capitalRatio">-</h4>
                        <p>Ù†Ø³Ø¨Øª Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø¨Ù‡ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ú©Ù„</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="profitRatioToTotal">-</h4>
                        <p>Ù†Ø³Ø¨Øª Ø³ÙˆØ¯ Ø¨Ù‡ Ø³ÙˆØ¯ Ú©Ù„</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="totalRatioToGrandTotal">-</h4>
                        <p>Ù†Ø³Ø¨Øª (Ø³Ø±Ù…Ø§ÛŒÙ‡+Ø³ÙˆØ¯) Ø¨Ù‡ Ú©Ù„</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="profitIndex">-</h4>
                        <p>Ø´Ø§Ø®Øµ Ù†ÙØ¹</p>
                    </div>
                </div>
            </div>

            <!-- Unit Info Section -->
            <div class="stats-section">
                <h3 class="section-title">
                    <i class="fas fa-building"></i>
                    Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø­Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
                </h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4 id="unitAreaDisplay">-</h4>
                        <p>Ù…Ø³Ø§Ø­Øª ÙˆØ§Ø­Ø¯ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="totalUnitsPrice">-</h4>
                        <p>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="ownershipArea">-</h4>
                        <p>Ù…Ø§Ù„Ú©ÛŒØª (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="finalPayment">-</h4>
                        <p>Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¬Ù‡Øª ØªØ³ÙˆÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="transferPricePerMeter">-</h4>
                        <p>Ù‚ÛŒÙ…Øª ÙˆØ§Ú¯Ø°Ø§Ø± Ø´Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†/Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</p>
                    </div>
                </div>
            </div>

            <!-- Transactions Section -->
            <div class="transactions-section">
                <h3 class="section-title">
                    <i class="fas fa-list"></i>
                    Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ
                </h3>
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Ø±Ø¯ÛŒÙ</th>
                            <th>ØªØ§Ø±ÛŒØ®</th>
                            <th>Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´</th>
                            <th>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Report Footer
        <div class="report-footer">
            <p>Â© 2024 Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø®Øª Ùˆ Ø³Ø§Ø² | ØªÙˆØ³Ø¹Ù‡ ÛŒØ§ÙØªÙ‡ ØªÙˆØ³Ø· <a href="https://royasoftteam.ir" target="_blank"><i class="fas fa-code"></i> RoyaSoftTeam</a></p>
        </div> -->
    </div>

    <script>
        // Format number with commas
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return '0';
            }
            return Math.round(num).toLocaleString('en-US');
        }

        // Get current date in Persian format
        function getCurrentPersianDate() {
            const date = new Date();
            return date.toLocaleDateString('fa-IR');
        }

        // Get investor ID from URL
        function getInvestorIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('investor_id');
        }

        // Translate transaction type
        function getTransactionTypeLabel(type) {
            const types = {
                'principal_deposit': 'Ø¢ÙˆØ±Ø¯Ù‡',
                'principal_withdrawal': 'Ø¨Ø±Ø¯Ø§Ø´Øª',
                'profit_accrual': 'Ø³ÙˆØ¯ Ù…Ø´Ø§Ø±Ú©Øª'
            };
            return types[type] || type;
        }

        // Load investor data
        async function loadInvestorData() {
            const investorId = getInvestorIdFromURL();
            
            if (!investorId) {
                document.getElementById('loadingState').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Ø´Ù†Ø§Ø³Ù‡ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø± Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        <a href="/dashboard/investor-profile/" class="btn btn-primary">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a>
                    </div>
                `;
                return;
            }

            try {
                // Fetch investor data
                const investorResponse = await fetch(`/construction/api/v1/Investor/${investorId}/`);
                if (!investorResponse.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±');
                const investor = await investorResponse.json();
                console.log('ğŸ” Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±:', investor);
                console.log('ğŸ¢ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±:', investor.units);

                // Fetch transactions
                const transactionsResponse = await fetch(`/construction/api/v1/Transaction/?investor=${investorId}`);
                if (!transactionsResponse.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§');
                const transactions = await transactionsResponse.json();

                // Fetch global statistics for ratios
                const statsResponse = await fetch('/construction/api/v1/Transaction/statistics/');
                let globalStats = null;
                if (statsResponse.ok) {
                    globalStats = await statsResponse.json();
                }

                // Fetch active interest rate
                const interestRateResponse = await fetch('/construction/api/v1/InterestRate/');
                let activeInterestRate = null;
                if (interestRateResponse.ok) {
                    const interestRates = await interestRateResponse.json();
                    // Find active interest rate
                    activeInterestRate = interestRates.find(rate => rate.is_active === true);
                    console.log('ğŸ’° Ù†Ø±Ø® Ø³ÙˆØ¯ ÙØ¹Ø§Ù„:', activeInterestRate);
                }

                // Calculate financial metrics
                const principalDeposits = transactions.filter(t => t.transaction_type === 'principal_deposit');
                const principalWithdrawals = transactions.filter(t => t.transaction_type === 'principal_withdrawal');
                const profitAccruals = transactions.filter(t => t.transaction_type === 'profit_accrual');

                const totalPrincipal = principalDeposits.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const totalWithdrawal = Math.abs(principalWithdrawals.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0));
                const totalProfit = profitAccruals.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const netPrincipal = totalPrincipal - totalWithdrawal;
                const totalBalance = netPrincipal + totalProfit;

                // Calculate ratios
                let capitalRatio = '0.00%';
                let profitRatioToTotal = '0.00%';
                let totalRatioToGrandTotal = '0.00%';
                let profitIndex = '0.00';

                if (globalStats) {
                    const totalCapital = parseFloat(globalStats.total_deposits || 0) - Math.abs(parseFloat(globalStats.total_withdrawals || 0));
                    const totalGlobalProfit = parseFloat(globalStats.total_profits || 0);
                    const grandTotal = totalCapital + totalGlobalProfit;

                    if (totalCapital > 0) {
                        capitalRatio = ((netPrincipal / totalCapital) * 100).toFixed(2) + '%';
                    }
                    if (totalGlobalProfit > 0) {
                        profitRatioToTotal = ((totalProfit / totalGlobalProfit) * 100).toFixed(2) + '%';
                    }
                    if (grandTotal > 0) {
                        totalRatioToGrandTotal = ((totalBalance / grandTotal) * 100).toFixed(2) + '%';
                    }
                    
                    // Calculate profit index
                    const capitalRatioNum = totalCapital > 0 ? (netPrincipal / totalCapital) : 0;
                    const profitRatioNum = totalGlobalProfit > 0 ? (totalProfit / totalGlobalProfit) : 0;
                    if (capitalRatioNum > 0) {
                        profitIndex = (profitRatioNum / capitalRatioNum).toFixed(2);
                    }
                }

                // Get unit information
                let unitInfo = {
                    name: 'Ù†Ø§Ù…Ø´Ø®Øµ',
                    area: 0,
                    price: 0,
                    ownership_area: 0
                };

                if (investor.units && investor.units.length > 0) {
                    const unit = investor.units[0];
                    unitInfo = {
                        name: unit.name || 'Ù†Ø§Ù…Ø´Ø®Øµ',
                        area: parseFloat(unit.area) || 0,
                        price: parseFloat(unit.total_price) || 0,
                        ownership_area: parseFloat(unit.area) || 0
                    };
                }

                // Calculate unit-related metrics
                const finalPayment = unitInfo.price - netPrincipal;
                const transferPricePerMeter = unitInfo.area > 0 ? netPrincipal / unitInfo.area : 0;

                // Update UI
                document.getElementById('reportDate').textContent = `ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´: ${getCurrentPersianDate()}`;
                document.getElementById('investorName').textContent = `${investor.first_name} ${investor.last_name}`;
                document.getElementById('investorPhone').textContent = investor.phone || 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';
                document.getElementById('contractDate').textContent = `ØªØ§Ø±ÛŒØ® Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: ${investor.contract_date_shamsi || 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡'}`;
                document.getElementById('unitName').textContent = `ÙˆØ§Ø­Ø¯: ${unitInfo.name}`;

                // Interest Rate
                if (activeInterestRate) {
                    document.getElementById('activeInterestRate').textContent = `${activeInterestRate.rate}%`;
                    document.getElementById('interestRateEffectiveDate').textContent = activeInterestRate.effective_date_display || activeInterestRate.effective_date || '-';
                } else {
                    document.getElementById('activeInterestRate').textContent = 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡';
                    document.getElementById('interestRateEffectiveDate').textContent = '-';
                }

                // Financial stats
                document.getElementById('totalPrincipal').textContent = formatNumber(totalPrincipal);
                document.getElementById('totalWithdrawal').textContent = formatNumber(totalWithdrawal);
                document.getElementById('netPrincipal').textContent = formatNumber(netPrincipal);
                document.getElementById('totalProfit').textContent = formatNumber(totalProfit);
                document.getElementById('totalBalance').textContent = formatNumber(totalBalance);
                document.getElementById('capitalRatio').textContent = capitalRatio;
                document.getElementById('profitRatioToTotal').textContent = profitRatioToTotal;
                document.getElementById('totalRatioToGrandTotal').textContent = totalRatioToGrandTotal;
                document.getElementById('profitIndex').textContent = profitIndex;

                // Unit stats
                document.getElementById('unitAreaDisplay').textContent = formatNumber(unitInfo.area);
                document.getElementById('totalUnitsPrice').textContent = formatNumber(unitInfo.price);
                document.getElementById('ownershipArea').textContent = formatNumber(unitInfo.ownership_area);
                document.getElementById('finalPayment').textContent = formatNumber(finalPayment);
                document.getElementById('transferPricePerMeter').textContent = formatNumber(transferPricePerMeter);

                // Load transactions table with sorting
                const tableBody = document.getElementById('transactionsTableBody');
                if (transactions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5">Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
                } else {
                    // Define transaction type priority
                    const transactionTypePriority = {
                        'principal_deposit': 1,
                        'principal_withdrawal': 2,
                        'profit_accrual': 3
                    };

                    // Sort transactions by Shamsi date, day_from_start, then by transaction type
                    const sortedTransactions = [...transactions].sort((a, b) => {
                        // Compare by day_from_start (Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹)
                        const dayFromStartA = parseInt(a.day_from_start) || 0;
                        const dayFromStartB = parseInt(b.day_from_start) || 0;
                        
                        if (dayFromStartA !== dayFromStartB) {
                            return dayFromStartA - dayFromStartB;
                        }
                        
                        // If day_from_start is equal, compare Shamsi dates
                        const dateShamsiA = a.date_shamsi || '';
                        const dateShamsiB = b.date_shamsi || '';
                        
                        if (dateShamsiA !== dateShamsiB) {
                            // Convert Shamsi date to comparable format (YYYY/MM/DD -> YYYYMMDD)
                            const dateNumA = dateShamsiA.replace(/\//g, '');
                            const dateNumB = dateShamsiB.replace(/\//g, '');
                            return dateNumA.localeCompare(dateNumB);
                        }
                        
                        // If dates are equal, sort by transaction type
                        const priorityA = transactionTypePriority[a.transaction_type] || 999;
                        const priorityB = transactionTypePriority[b.transaction_type] || 999;
                        return priorityA - priorityB;
                    });

                    console.log('ğŸ“Š ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨ Ø´Ø¯Ù‡:', sortedTransactions.map(t => ({
                        date_shamsi: t.date_shamsi,
                        day_from_start: t.day_from_start,
                        type: t.transaction_type,
                        amount: t.amount
                    })));

                    tableBody.innerHTML = sortedTransactions.map((t, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${t.date_shamsi || t.date}</td>
                            <td><span class="transaction-type ${t.transaction_type}">${getTransactionTypeLabel(t.transaction_type)}</span></td>
                            <td>${formatNumber(Math.abs(t.amount))}</td>
                            <td>${t.description || '-'}</td>
                        </tr>
                    `).join('');
                }

                // Show main content
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ${error.message}</p>
                        <a href="/dashboard/investor-profile/" class="btn btn-primary">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a>
                    </div>
                `;
            }
        }

        // Generate PDF using browser print dialog
        function generatePDF() {
            // ØªÙ†Ø¸ÛŒÙ… Ø¹Ù†ÙˆØ§Ù† Ø³Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù… ÙØ§ÛŒÙ„ PDF
            const investorName = document.getElementById('investorName').textContent;
            const originalTitle = document.title;
            document.title = `Ú¯Ø²Ø§Ø±Ø´_Ù…Ø§Ù„ÛŒ_${investorName}_${getCurrentPersianDate()}`;
            
            // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯ÛŒØ§Ù„ÙˆÚ¯ Ú†Ø§Ù¾ Ù…Ø±ÙˆØ±Ú¯Ø±
            window.print();
            
            // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¹Ù†ÙˆØ§Ù† Ø§ØµÙ„ÛŒ
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', loadInvestorData);
    </script>
</body>
</html>

