<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت نرخ سود</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Persian Date Picker -->
    <link href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-overlay: rgba(255, 255, 255, 0.95);
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-white: #ffffff;
            --border-color: #e9ecef;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 8px 25px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.12);
            
            /* رنگ‌های استاندارد پروژه */
            --deposit-color: #2185d0;           /* آبی - آورده */
            --withdrawal-color: #db2828;        /* قرمز - برداشت */
            --profit-color: #21ba45;            /* سبز - سود مشارکت */
            --capital-color: #667eea;           /* بنفش - سرمایه موجود */
            --expense-color: #dc3545;           /* قرمز تیره - هزینه‌ها */
            --total-color: #6c757d;             /* خاکستری - مجموع */
        }

        body {
            font-family: 'Vazir','Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            text-align: right;
            padding: 20px;
            color: var(--text-primary);
        }

        /* Unified Header Design */
        .unified-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            border-radius: 20px 20px 0 0;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .unified-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .unified-header-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .unified-header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .unified-header h1 i {
            font-size: 2.5rem;
            opacity: 0.9;
        }

        .unified-header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 25px;
            font-weight: 300;
        }

        .unified-header .navigation-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .unified-header .nav-link {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unified-header .nav-link:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .unified-header .nav-link i {
            font-size: 1.1rem;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: var(--bg-overlay);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            text-align: center;
        }

        .dashboard-header h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .dashboard-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .navigation-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .nav-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: white;
            text-decoration: none;
        }

        .nav-btn i {
            font-size: 1rem;
        }

        .main-content {
            background: var(--bg-overlay);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        .section-title {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn-add {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: white;
        }

        .rate-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .rate-table th,
        .rate-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .rate-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-white);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .rate-table tbody tr {
            transition: all 0.3s ease;
        }

        .rate-table tbody tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .rate-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background-color: var(--success-color);
            color: white;
        }

        .status-inactive {
            background-color: var(--text-secondary);
            color: white;
        }

        .rate-percentage {
            font-weight: bold;
            color: var(--success-color);
            font-size: 1.1rem;
        }

        .date-display {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }

        .alert {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .current-rate-card {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .current-rate-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .current-rate-date {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
            border-bottom: none;
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            filter: invert(1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: block;
        }

        .form-control {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: var(--bg-secondary);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--text-secondary);
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .unified-header {
                padding: 25px 20px;
                border-radius: 15px 15px 0 0;
            }

            .unified-header h1 {
                font-size: 2.2rem;
                flex-direction: column;
                gap: 10px;
            }

            .unified-header h1 i {
                font-size: 2rem;
            }

            .unified-header .subtitle {
                font-size: 1.1rem;
            }

            .unified-header .navigation-links {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .unified-header .nav-link {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .rate-table {
                font-size: 0.9rem;
            }
            
            .rate-table th,
            .rate-table td {
                padding: 10px 8px;
            }
            
            .section-title {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }

        /* Project Financial Summary Cards */
        .stat-card {
            background: var(--bg-secondary) !important;
            border-radius: 15px;
            border-top-left-radius: 0px;
            border-top-right-radius: 0px;
            padding: 25px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 0;
        }

        .stat-card.expense-card::before {
            background: linear-gradient(90deg, var(--expense-color), #f48fb1) !important;
        }

        .stat-card.sales-card::before {
            background: linear-gradient(90deg, #4caf50, #81c784) !important;
        }

        .stat-card.final-cost-card::before {
            background: linear-gradient(90deg, var(--total-color), #90a4ae) !important;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: white !important;
            flex-shrink: 0;
        }

        .stat-card.expense-card .stat-icon {
            background: linear-gradient(135deg, var(--expense-color), #f48fb1) !important;
        }

        .stat-card.sales-card .stat-icon {
            background: linear-gradient(135deg, #4caf50, #81c784) !important;
        }

        .stat-card.final-cost-card .stat-icon {
            background: linear-gradient(135deg, var(--total-color), #90a4ae) !important;
        }

        .stat-content {
            text-align: right;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* Larger font size for price-related cards */
        .stat-card.value-card .stat-value,
        .stat-card.cost-per-meter-net-card .stat-value,
        .stat-card.cost-per-meter-gross-card .stat-value,
        .stat-card.value-per-meter-card .stat-value,
        .stat-card.final-profit-amount-card .stat-value,
        .stat-card.total-profit-percentage-card .stat-value,
        .stat-card.average-construction-period-card .stat-value,
        .stat-card.annual-profit-percentage-card .stat-value,
        .stat-card.monthly-profit-percentage-card .stat-value,
        .stat-card.daily-profit-percentage-card .stat-value {
            font-size: 2.2rem !important;
        }

        /* Larger cards for price-related statistics */
        .stat-card.value-card,
        .stat-card.cost-per-meter-net-card,
        .stat-card.cost-per-meter-gross-card,
        .stat-card.value-per-meter-card,
        .stat-card.final-profit-amount-card,
        .stat-card.total-profit-percentage-card,
        .stat-card.average-construction-period-card,
        .stat-card.annual-profit-percentage-card,
        .stat-card.monthly-profit-percentage-card,
        .stat-card.daily-profit-percentage-card {
            min-height: 180px !important;
            padding: 30px !important;
        }

        .stat-card.value-card .stat-icon,
        .stat-card.cost-per-meter-net-card .stat-icon,
        .stat-card.cost-per-meter-gross-card .stat-icon,
        .stat-card.value-per-meter-card .stat-icon,
        .stat-card.final-profit-amount-card .stat-icon,
        .stat-card.total-profit-percentage-card .stat-icon,
        .stat-card.average-construction-period-card .stat-icon,
        .stat-card.annual-profit-percentage-card .stat-icon,
        .stat-card.monthly-profit-percentage-card .stat-icon,
        .stat-card.daily-profit-percentage-card .stat-icon {
            width: 70px !important;
            height: 70px !important;
            font-size: 1.8rem !important;
        }

        .stat-card.expense-card .stat-value {
            color: var(--expense-color) !important;
        }

        .stat-card.sales-card .stat-value {
            color: #4caf50 !important;
        }

        .stat-card.final-cost-card .stat-value {
            color: var(--total-color) !important;
        }

        .stat-card.units-card .stat-icon {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
        }

        .stat-card.units-card::before {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)) !important;
        }

        .stat-card.units-card .stat-value {
            color: var(--primary-color) !important;
        }

        .stat-card.area-card .stat-icon {
            background: linear-gradient(135deg, var(--info-color), #4fc3f7) !important;
        }

        .stat-card.area-card::before {
            background: linear-gradient(90deg, var(--info-color), #4fc3f7) !important;
        }

        .stat-card.area-card .stat-value {
            color: var(--info-color) !important;
        }

        .stat-card.value-card .stat-icon {
            background: linear-gradient(135deg, var(--success-color), #81c784) !important;
        }

        .stat-card.value-card::before {
            background: linear-gradient(90deg, var(--success-color), #81c784) !important;
        }

        .stat-card.value-card .stat-value {
            color: var(--success-color) !important;
        }

        .stat-card.infrastructure-card .stat-icon {
            background: linear-gradient(135deg, var(--warning-color), #ffb74d) !important;
        }

        .stat-card.infrastructure-card::before {
            background: linear-gradient(90deg, var(--warning-color), #ffb74d) !important;
        }

        .stat-card.infrastructure-card .stat-value {
            color: var(--warning-color) !important;
        }

        .stat-card.cost-per-meter-net-card .stat-icon {
            background: linear-gradient(135deg, #9c27b0, #ba68c8) !important;
        }

        .stat-card.cost-per-meter-net-card::before {
            background: linear-gradient(90deg, #9c27b0, #ba68c8) !important;
        }

        .stat-card.cost-per-meter-net-card .stat-value {
            color: #9c27b0 !important;
        }

        .stat-card.cost-per-meter-gross-card .stat-icon {
            background: linear-gradient(135deg, #ff5722, #ff8a65) !important;
        }

        .stat-card.cost-per-meter-gross-card::before {
            background: linear-gradient(90deg, #ff5722, #ff8a65) !important;
        }

        .stat-card.cost-per-meter-gross-card .stat-value {
            color: #ff5722 !important;
        }

        .stat-card.value-per-meter-card .stat-icon {
            background: linear-gradient(135deg, #00bcd4, #26c6da) !important;
        }

        .stat-card.value-per-meter-card::before {
            background: linear-gradient(90deg, #00bcd4, #26c6da) !important;
        }

        .stat-card.value-per-meter-card .stat-value {
            color: #00bcd4 !important;
        }


        .stat-card.final-profit-amount-card .stat-icon {
            background: linear-gradient(135deg, #4caf50, #81c784) !important;
        }

        .stat-card.final-profit-amount-card::before {
            background: linear-gradient(90deg, #4caf50, #81c784) !important;
        }

        .stat-card.final-profit-amount-card .stat-value {
            color: #4caf50 !important;
        }

        .stat-card.total-profit-percentage-card .stat-icon {
            background: linear-gradient(135deg, #ff9800, #ffb74d) !important;
        }

        .stat-card.total-profit-percentage-card::before {
            background: linear-gradient(90deg, #ff9800, #ffb74d) !important;
        }

        .stat-card.total-profit-percentage-card .stat-value {
            color: #ff9800 !important;
        }

        .stat-card.average-construction-period-card .stat-icon {
            background: linear-gradient(135deg, #673ab7, #9575cd) !important;
        }

        .stat-card.average-construction-period-card::before {
            background: linear-gradient(90deg, #673ab7, #9575cd) !important;
        }

        .stat-card.average-construction-period-card .stat-value {
            color: #673ab7 !important;
        }

        .stat-card.annual-profit-percentage-card .stat-icon {
            background: linear-gradient(135deg, #795548, #a1887f) !important;
        }

        .stat-card.annual-profit-percentage-card::before {
            background: linear-gradient(90deg, #795548, #a1887f) !important;
        }

        .stat-card.annual-profit-percentage-card .stat-value {
            color: #795548 !important;
        }

        .stat-card.monthly-profit-percentage-card .stat-icon {
            background: linear-gradient(135deg, #ff9800, #ffb74d) !important;
        }

        .stat-card.monthly-profit-percentage-card::before {
            background: linear-gradient(90deg, #ff9800, #ffb74d) !important;
        }

        .stat-card.monthly-profit-percentage-card .stat-value {
            color: #ff9800 !important;
        }

        .stat-card.daily-profit-percentage-card .stat-icon {
            background: linear-gradient(135deg, #4caf50, #81c784) !important;
        }

        .stat-card.daily-profit-percentage-card::before {
            background: linear-gradient(90deg, #4caf50, #81c784) !important;
        }

        .stat-card.daily-profit-percentage-card .stat-value {
            color: #4caf50 !important;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            position: relative;
        }

        /* Position info icon at top-left of card */
        .stat-card {
            position: relative;
        }

        /* Info Icon and Tooltip Styles */
        .info-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 18px;
            height: 18px;
            background: var(--info-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .info-icon:hover {
            background: #0d6efd;
            transform: scale(1.1);
        }

        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 300px;
            min-width: 200px;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            line-height: 1.5;
        }

        .tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        /* .tooltip::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid rgba(0, 0, 0, 0.95);
        } */

        /* Ensure tooltip is always visible */
        .stat-card {
            overflow: visible !important;
        }

        /* Ensure cards display in one row */
        #financialSummaryCards .row {
            display: flex !important;
            flex-wrap: nowrap !important;
        }

        #financialSummaryCards .col-lg-4,
        #financialSummaryCards .col-md-4,
        #financialSummaryCards .col-sm-12 {
            flex: 1 !important;
            max-width: 33.333333% !important;
        }

        #projectStatsCards .row {
            display: flex !important;
            flex-wrap: nowrap !important;
        }

        #projectStatsCards .col-lg-2,
        #projectStatsCards .col-md-4,
        #projectStatsCards .col-sm-6 {
            flex: 1 !important;
        }

        /* Special sizing for price-related cards */
        #projectStatsCards .value-card {
            flex: 2 !important;
        }

        #projectStatsCards .cost-per-meter-net-card,
        #projectStatsCards .cost-per-meter-gross-card,
        #projectStatsCards .value-per-meter-card,
        #projectStatsCards .final-profit-amount-card,
        #projectStatsCards .total-profit-percentage-card,
        #projectStatsCards .average-construction-period-card,
        #projectStatsCards .annual-profit-percentage-card,
        #projectStatsCards .monthly-profit-percentage-card {
            flex: 1.5 !important;
        }

        #projectStatsCards .daily-profit-percentage-card {
            flex: 2 !important;
            max-width: 50% !important;
        }

        @media (max-width: 768px) {
            #financialSummaryCards .row {
                flex-wrap: wrap !important;
            }
            
            #financialSummaryCards .col-sm-12 {
                max-width: 100% !important;
                flex: none !important;
            }

            #projectStatsCards .row {
                flex-wrap: wrap !important;
            }
            
            #projectStatsCards .col-sm-6 {
                max-width: 50% !important;
                flex: none !important;
            }

            /* Reset flex for mobile */
            #projectStatsCards .value-card,
            #projectStatsCards .cost-per-meter-net-card,
            #projectStatsCards .cost-per-meter-gross-card,
            #projectStatsCards .value-per-meter-card,
            #projectStatsCards .final-profit-amount-card,
            #projectStatsCards .total-profit-percentage-card,
            #projectStatsCards .average-construction-period-card,
            #projectStatsCards .annual-profit-percentage-card,
            #projectStatsCards .monthly-profit-percentage-card {
                flex: none !important;
            }

            #projectStatsCards .daily-profit-percentage-card {
                flex: none !important;
                max-width: 100% !important;
            }

            /* Smaller font size for price cards on mobile */
            .stat-card.value-card .stat-value,
            .stat-card.cost-per-meter-net-card .stat-value,
            .stat-card.cost-per-meter-gross-card .stat-value,
            .stat-card.value-per-meter-card .stat-value,
            .stat-card.final-profit-amount-card .stat-value,
            .stat-card.total-profit-percentage-card .stat-value,
            .stat-card.average-construction-period-card .stat-value,
            .stat-card.annual-profit-percentage-card .stat-value,
            .stat-card.monthly-profit-percentage-card .stat-value,
            .stat-card.daily-profit-percentage-card .stat-value {
                font-size: 1.6rem !important;
            }

            /* Adjust card size for mobile */
            .stat-card.value-card,
            .stat-card.cost-per-meter-net-card,
            .stat-card.cost-per-meter-gross-card,
            .stat-card.value-per-meter-card,
            .stat-card.final-profit-amount-card,
            .stat-card.total-profit-percentage-card,
            .stat-card.average-construction-period-card,
            .stat-card.annual-profit-percentage-card,
            .stat-card.monthly-profit-percentage-card,
            .stat-card.daily-profit-percentage-card {
                min-height: 160px !important;
                padding: 25px !important;
            }

            .stat-card.value-card .stat-icon,
            .stat-card.cost-per-meter-net-card .stat-icon,
            .stat-card.cost-per-meter-gross-card .stat-icon,
            .stat-card.value-per-meter-card .stat-icon,
            .stat-card.final-profit-amount-card .stat-icon,
            .stat-card.total-profit-percentage-card .stat-icon,
            .stat-card.average-construction-period-card .stat-icon,
            .stat-card.annual-profit-percentage-card .stat-icon,
            .stat-card.monthly-profit-percentage-card .stat-icon,
            .stat-card.daily-profit-percentage-card .stat-icon {
                width: 60px !important;
                height: 60px !important;
                font-size: 1.5rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="dashboard-container">
        <!-- Unified Header Section -->
        <div class="unified-header">
            <div class="unified-header-content">
                <h1>
                    <i class="fas fa-percentage"></i>
                    مدیریت  سود
                </h1>
                <p class="subtitle">مشاهده و مدیریت سودهای مشارکت پروژه</p>
                <div class="navigation-links">
                    <a href="/user-dashboard/" class="nav-link">
                        <i class="fas fa-home"></i>
                        صفحه اصلی
                    </a>
                    <a href="/dashboard/project/" class="nav-link">
                        <i class="fas fa-chart-line"></i>
خلاصه مالی  
                     </a>
                    <a href="/dashboard/transaction-manager/" class="nav-link">
                        <i class="fas fa-money-bill-wave"></i>
                        مدیریت تراکنش‌ها
                    </a>
                    <a href="/dashboard/investor-profile/" class="nav-link">
                        <i class="fas fa-user-tie"></i>
                        پروفایل مالی مشارکت کنندگان
                    </a>
                    <a href="/dashboard/expense-dashboard/" class="nav-link">
                        <i class="fas fa-chart-pie"></i>
                        داشبورد هزینه‌ها
                    </a>
                </div>
            </div>
        </div>

        <!-- Current Rate Display -->
        <div id="currentRateCard" class="current-rate-card" style="display: none;">
            <div class="current-rate-value" id="currentRateValue">-</div>
            <div class="current-rate-date" id="currentRateDate">-</div>
        </div>

        <!-- Project Financial Summary Cards -->
        <div class="row mb-4" id="financialSummaryCards" style="display: none;">
            <div class="col-lg-4 col-md-4 col-sm-12 mb-3">
                <div class="stat-card expense-card">
                    <div class="info-icon" data-tooltip="مجموع تمام هزینه‌های ثبت شده در پروژه شامل هزینه‌های ساخت، خرید مصالح، دستمزد کارگران و سایر هزینه‌های مرتبط">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalExpenses">-</div>
                        <div class="stat-label">مجموع کل هزینه‌ها(تومان)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-12 mb-3">
                <div class="stat-card sales-card">
                    
                    <div class="stat-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalSales">-</div>
                        <div class="stat-label">مجموع فروش/مرجوعی(تومان)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-12 mb-3">
                <div class="stat-card final-cost-card">
                    <div class="info-icon" data-tooltip="هزینه خالص پروژه که از تفریق مجموع فروش از مجموع هزینه‌ها محاسبه می‌شود. این عدد نشان‌دهنده هزینه واقعی پروژه است">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="finalCost">-</div>
                        <div class="stat-label">هزینه تمام شده نهایی(تومان)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Statistics Cards -->
        <div class="row mb-4" id="projectStatsCards" style="display: none;">
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="stat-card units-card">
                    <div class="stat-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalUnits">-</div>
                        <div class="stat-label">تعداد واحدها</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="stat-card area-card">
                    <div class="info-icon" data-tooltip="مجموع متراژ  همه واحدها ">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-ruler-combined"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalArea">-</div>
                        <div class="stat-label">مجموع متراژ مفید (متر مربع)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 col-sm-12 mb-3 value-card">
                <div class="stat-card value-card">
                    <div class="info-icon" data-tooltip="مجموع قیمت واحدها که نشان‌دهنده ارزش کل ساختمان بر اساس قیمت‌گذاری واحدها است">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalValue">-</div>
                        <div class="stat-label">ارزش ساختمان (تومان)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="stat-card infrastructure-card">
                    <div class="info-icon" data-tooltip="زیربنای کل پروژه که شامل تمام فضاها از جمله واحدها، راهروها، آسانسور، پله‌ها و سایر فضاهای مشترک است">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalInfrastructure">-</div>
                        <div class="stat-label">زیربنای کل (متر مربع)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-3 cost-per-meter-net-card">
                <div class="stat-card cost-per-meter-net-card">
                    <div class="info-icon" data-tooltip="هزینه تمام شده نهایی تقسیم بر مجموع متراژ مفید. این عدد نشان‌دهنده هزینه ساخت هر متر مربع از فضای مفید است">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="costPerMeterNet">-</div>
                        <div class="stat-label">هزینه هر متر خالص (تومان/متر مربع)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-3 cost-per-meter-gross-card">
                <div class="stat-card cost-per-meter-gross-card">
                    <div class="info-icon" data-tooltip="هزینه تمام شده نهایی تقسیم بر زیربنای کل. این عدد نشان‌دهنده هزینه ساخت هر متر مربع از کل زیربنا شامل فضاهای مشترک است">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="costPerMeterGross">-</div>
                        <div class="stat-label">هزینه هر متر ناخالص (تومان/متر مربع)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-3 value-per-meter-card">
                <div class="stat-card value-per-meter-card">
                    <div class="info-icon" data-tooltip="ارزش ساختمان تقسیم بر مجموع متراژ مفید. این عدد نشان‌دهنده ارزش هر متر مربع از فضای مفید بر اساس قیمت‌گذاری واحدها است">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="valuePerMeter">-</div>
                        <div class="stat-label">ارزش ساختمان(متری) (تومان/متر مربع)</div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 col-sm-12 mb-3 total-profit-percentage-card">
                <div class="stat-card total-profit-percentage-card">
                    <div class="info-icon" data-tooltip="مبلغ سود نهایی تقسیم بر هزینه تمام شده نهایی ضرب در 100. این عدد نشان‌دهنده درصد سود کل پروژه است">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalProfitPercentage">-</div>
                        <div class="stat-label">درصد سود کل (%)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 col-sm-12 mb-3 final-profit-amount-card">
                <div class="stat-card final-profit-amount-card">
                    <div class="info-icon" data-tooltip="ارزش ساختمان منهای هزینه تمام شده نهایی. این عدد نشان‌دهنده سود خالص پروژه است">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="finalProfitAmount">-</div>
                        <div class="stat-label">مبلغ سود نهایی (تومان)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-3 average-construction-period-card">
                <div class="stat-card average-construction-period-card">
                    <div class="info-icon" data-tooltip="محاسبه دوره متوسط ساخت بر اساس وزن دوره‌ها و هزینه‌های هر دوره. فرمول: مجموع (هزینه هر دوره × وزن آن دوره) ÷ مجموع کل هزینه‌ها">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="averageConstructionPeriod">-</div>
                        <div class="stat-label">دوره متوسط ساخت (ماه)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-3 annual-profit-percentage-card">
                <div class="stat-card annual-profit-percentage-card">
                    <div class="info-icon" data-tooltip="درصد سود سالانه بر اساس دوره متوسط ساخت. فرمول: (درصد سود کل ÷ دوره متوسط ساخت) × 12">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="annualProfitPercentage">-</div>
                        <div class="stat-label">درصد سود سالانه (%)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 mb-3 monthly-profit-percentage-card">
                <div class="stat-card monthly-profit-percentage-card">
                    <div class="info-icon" data-tooltip="درصد سود ماهانه بر اساس درصد سود سالانه. فرمول: درصد سود سالانه ÷ 12">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-calendar-week"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="monthlyProfitPercentage">-</div>
                        <div class="stat-label">درصد سود ماهانه (%)</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 mb-3 daily-profit-percentage-card">
                <div class="stat-card daily-profit-percentage-card">
                    <div class="info-icon" data-tooltip="درصد سود روزانه با ضریب اصلاحی. فرمول: (درصد سود سالانه ÷ 365) × ضریب اصلاحی">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="dailyProfitPercentage">-</div>
                        <div class="stat-label">درصد سود روزانه (%)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Section Header -->
            <div class="section-title">
                <span>
                    <i class="fas fa-list"></i>
                    لیست سودها(<a style="color:black;font-size:14px;" href="../../construction/InterestRate/">ویرایش سود</a>)
                </span>
                <br> <span style="color:black;font-size:1.2rem;"></span>

                <button type="button" class="btn-add" data-bs-toggle="modal" data-bs-target="#addRateModal">
                    <i class="fas fa-plus"></i>
                    افزودن نرخ سود جدید
                </button>
            </div>
            
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
            </div>

            <div id="alertContainer"></div>

            <div id="ratesTableContainer">
                <table class="rate-table" id="ratesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>نرخ سود</th>
                            <th>تاریخ اعمال</th>
                            <th>وضعیت</th>
                            <th>توضیحات</th>
                            <th>تاریخ ایجاد</th>
                        </tr>
                    </thead>
                    <tbody id="ratesTableBody">
                    </tbody>
                </table>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-percentage"></i>
                <h3>هیچ نرخ سودی یافت نشد</h3>
                <p>برای شروع، نرخ سود جدیدی اضافه کنید.</p>
            </div>
        </div>
    </div>

    <!-- Add Rate Modal -->
    <div class="modal fade" id="addRateModal" tabindex="-1" aria-labelledby="addRateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRateModalLabel">
                        <i class="fas fa-plus-circle"></i>
                        افزودن نرخ سود جدید
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addRateForm">
                        <div class="form-group">
                            <label for="rate" class="form-label">نرخ سود روزانه</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="rate" 
                                   name="rate" 
                                   step="0.000000000000001"
                                   placeholder="مثال: 0.000481925679775"
                                   required>
                            <small class="form-text text-muted">نرخ سود روزانه به صورت اعشاری</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="effective_date" class="form-label">تاریخ اعمال (شمسی)</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="effective_date" 
                                   name="effective_date" 
                                   placeholder="1403-01-01"
                                   required>
                        </div>
                        
                        <div class="form-group">
                            <label for="is_active" class="form-label">وضعیت</label>
                            <select class="form-control" id="is_active" name="is_active">
                                <option value="true">فعال</option>
                                <option value="false">غیرفعال</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="description" class="form-label">توضیحات</label>
                            <textarea class="form-control" 
                                      id="description" 
                                      name="description" 
                                      rows="3" 
                                      placeholder="دلیل تغییر نرخ سود..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="button" class="btn btn-primary" onclick="submitRateForm()">
                        <i class="fas fa-save"></i>
                        ذخیره نرخ سود
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>

    <script>
        // Global variables
        let rates = [];

        // API Base URL
        const API_BASE = '/api/v1/';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeDatePickers();
            loadRates();
            loadCurrentRate();
            loadFinancialSummary();
            loadProjectStatistics();
            initializeTooltips();
        });

        // Initialize Persian date pickers
        function initializeDatePickers() {
            $('#effective_date').persianDatepicker({
                format: 'YYYY-MM-DD',
                initialValue: false,
                calendar: {
                    persian: {
                        locale: 'fa',
                        leapYearMode: 'astronomical'
                    }
                },
                onSelect: function(unix) {
                    try {
                        // استفاده از persianDate برای تاریخ انتخابی
                        var selectedDate = new persianDate(unix);
                        
                        console.log('تاریخ انتخابی شمسی:', selectedDate.format('YYYY-MM-DD'));
                        console.log('Unix timestamp:', unix);
                        
                        // تبدیل به تاریخ میلادی با اصلاح timezone
                        var gregorianDate = selectedDate.toDate();
                        
                        // اصلاح timezone offset برای جلوگیری از یک روز جلو بودن
                        var timezoneOffset = gregorianDate.getTimezoneOffset();
                        var correctedDate = new Date(gregorianDate.getTime() + (timezoneOffset * 60000));
                        
                        console.log('تاریخ میلادی قبل از اصلاح:', gregorianDate);
                        console.log('Timezone offset:', timezoneOffset);
                        console.log('تاریخ میلادی بعد از اصلاح:', correctedDate);
                        
                        // تنظیم فیلد میلادی مرتبط
                        var gregorianField = $(this).closest('.field').find('input[name*="gregorian"]');
                        if (gregorianField.length) {
                            var year = correctedDate.getFullYear();
                            var month = String(correctedDate.getMonth() + 1).padStart(2, '0');
                            var day = String(correctedDate.getDate()).padStart(2, '0');
                            
                            gregorianField.val(year + '-' + month + '-' + day);
                            console.log('تاریخ میلادی نهایی:', year + '-' + month + '-' + day);
                        }
                    } catch(e) {
                        console.log('خطا در تبدیل تاریخ:', e);
                    }
                }
            });
        }

        // Submit rate form
        async function submitRateForm() {
            const form = document.getElementById('addRateForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Convert is_active to boolean
            data.is_active = data.is_active === 'true';
            
            // Validate and clean Persian date format
            if (data.effective_date) {
                console.log('Original date from form:', data.effective_date);
                
                // Convert Persian digits to English digits
                const persianToEnglish = {
                    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
                    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
                };
                
                let cleanDate = data.effective_date;
                for (let persian in persianToEnglish) {
                    cleanDate = cleanDate.replace(new RegExp(persian, 'g'), persianToEnglish[persian]);
                }
                
                // Remove any remaining non-digit characters except dashes
                cleanDate = cleanDate.replace(/[^\d-]/g, '');
                console.log('Cleaned date:', cleanDate);
                
                // Check if date format is correct (YYYY-MM-DD)
                if (!/^\d{4}-\d{2}-\d{2}$/.test(cleanDate)) {
                    console.error('Invalid date format:', cleanDate);
                    showAlert('فرمت تاریخ صحیح نیست (مثال: 1403-01-01)', 'danger');
                    return;
                }
                
                // Update the data with cleaned date
                data.effective_date = cleanDate;
                console.log('Final date for API:', data.effective_date);
            }
            
            try {
                const response = await fetch(`${API_BASE}InterestRate/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrfToken
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('نرخ سود با موفقیت اضافه شد', 'success');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addRateModal'));
                    modal.hide();
                    // Reset form
                    form.reset();
                    // Reload data
                    loadRates();
                    loadCurrentRate();
                } else {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    showAlert('خطا در افزودن نرخ سود: ' + (errorData.detail || JSON.stringify(errorData)), 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('خطا در ارتباط با سرور', 'danger');
            }
        }

        // Load all rates
        async function loadRates() {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}InterestRate/`);
                
                if (response.ok) {
                    rates = await response.json();
                    displayRates();
                } else {
                    showAlert('خطا در بارگذاری نرخ‌های سود', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('خطا در ارتباط با سرور', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Load current active rate
        async function loadCurrentRate() {
            try {
                const response = await fetch(`${API_BASE}InterestRate/current/`);
                if (response.ok) {
                    const currentRate = await response.json();
                    displayCurrentRate(currentRate);
                } else {
                    document.getElementById('currentRateCard').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading current rate:', error);
                document.getElementById('currentRateCard').style.display = 'none';
            }
        }

        // Display current rate
        function displayCurrentRate(rate) {
            const rateValue = (rate.rate * 100).toFixed(6) + '%';
            const rateDate = rate.effective_date_display || rate.effective_date;
            
            document.getElementById('currentRateValue').textContent = rateValue;
            document.getElementById('currentRateDate').textContent = `از تاریخ ${rateDate}`;
            document.getElementById('currentRateCard').style.display = 'block';
        }

        // Load financial summary data
        async function loadFinancialSummary() {
            try {
                // Load expenses data
                const expensesResponse = await fetch(`${API_BASE}Expense/total_expenses/`);
                let totalExpenses = 0;
                if (expensesResponse.ok) {
                    const expensesData = await expensesResponse.json();
                    console.log('Expenses API Response:', expensesData);
                    totalExpenses = expensesData.total_expenses?.total_amount || 0;
                }

                // Load sales data
                const salesResponse = await fetch(`${API_BASE}Sale/total_sales/`);
                let totalSales = 0;
                if (salesResponse.ok) {
                    const salesData = await salesResponse.json();
                    console.log('Sales API Response:', salesData);
                    totalSales = salesData.total_amount || 0;
                }

                // Calculate final cost (expenses - sales)
                const finalCost = totalExpenses - totalSales;

                console.log('Final Values:', {
                    totalExpenses,
                    totalSales,
                    finalCost
                });

                // Display the data
                displayFinancialSummary(totalExpenses, totalSales, finalCost);

            } catch (error) {
                console.error('Error loading financial summary:', error);
            }
        }

        // Display financial summary
        function displayFinancialSummary(totalExpenses, totalSales, finalCost) {
            // Format numbers with English locale and 3-digit separators
            const formatNumber = (num) => {
                return new Intl.NumberFormat('en-US').format(Math.round(num));
            };

            document.getElementById('totalExpenses').textContent = formatNumber(totalExpenses);
            document.getElementById('totalSales').textContent = formatNumber(totalSales);
            document.getElementById('finalCost').textContent = formatNumber(finalCost);

            // Show the financial summary cards
            document.getElementById('financialSummaryCards').style.display = 'flex';

            // Recalculate cost per meter if project stats are already loaded
            const projectStatsElement = document.getElementById('projectStatsCards');
            if (projectStatsElement && projectStatsElement.style.display !== 'none') {
                // Trigger recalculation by calling the function again
                setTimeout(() => {
                    const projectData = window.lastProjectData;
                    if (projectData) {
                        calculateAndDisplayCostPerMeter(projectData);
                    }
                }, 100);
            }
        }

        // Load project statistics
        async function loadProjectStatistics() {
            try {
                // Load project statistics (includes both project data and units statistics)
                const response = await fetch(`${API_BASE}Project/statistics/`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Project Statistics API Response:', data);
                    // Store data globally for recalculation
                    window.lastProjectData = data;
                    displayProjectStatistics(data);
                } else {
                    console.error('Error loading project statistics');
                }

            } catch (error) {
                console.error('Error loading project statistics:', error);
            }
        }

        // Display project statistics
        function displayProjectStatistics(data) {
            // Format numbers with English locale and 3-digit separators
            const formatNumber = (num) => {
                return new Intl.NumberFormat('en-US').format(Math.round(num));
            };

            // Display units statistics
            if (data.units_statistics) {
                document.getElementById('totalUnits').textContent = formatNumber(data.units_statistics.total_units);
                document.getElementById('totalArea').textContent = formatNumber(data.units_statistics.total_area);
                document.getElementById('totalValue').textContent = formatNumber(data.units_statistics.total_price);
            }

            // Display project infrastructure
            if (data.project && data.project.total_infrastructure) {
                document.getElementById('totalInfrastructure').textContent = formatNumber(data.project.total_infrastructure);
            }

            // Calculate and display cost per meter
            calculateAndDisplayCostPerMeter(data);

            // Show the project statistics cards
            document.getElementById('projectStatsCards').style.display = 'flex';
        }

        // Calculate cost per meter (net and gross) and value per meter
        function calculateAndDisplayCostPerMeter(data) {
            // Get final cost from financial summary
            const finalCostElement = document.getElementById('finalCost');
            const finalCostText = finalCostElement ? finalCostElement.textContent : '0';
            const finalCost = parseFloat(finalCostText.replace(/,/g, '')) || 0;

            // Get total area (net)
            const totalArea = data.units_statistics ? data.units_statistics.total_area : 0;
            
            // Get total infrastructure (gross)
            const totalInfrastructure = data.project ? data.project.total_infrastructure : 0;

            // Get total value (building value)
            const totalValue = data.units_statistics ? data.units_statistics.total_price : 0;

            // Calculate cost per meter net (final cost / total area)
            let costPerMeterNet = 0;
            if (totalArea > 0) {
                costPerMeterNet = finalCost / totalArea;
            }

            // Calculate cost per meter gross (final cost / total infrastructure)
            let costPerMeterGross = 0;
            if (totalInfrastructure > 0) {
                costPerMeterGross = finalCost / totalInfrastructure;
            }

            // Calculate value per meter (total value / total area)
            let valuePerMeter = 0;
            if (totalArea > 0) {
                valuePerMeter = totalValue / totalArea;
            }


            // Calculate final profit amount (total value - final cost)
            let finalProfitAmount = 0;
            finalProfitAmount = totalValue - finalCost;

            // Calculate total profit percentage ((final profit amount / final cost) * 100)
            let totalProfitPercentage = 0;
            if (finalCost > 0) {
                totalProfitPercentage = (finalProfitAmount / finalCost) * 100;
            }

            // Format and display
            const formatNumber = (num) => {
                return new Intl.NumberFormat('en-US').format(Math.round(num));
            };

            const formatPercentage = (num) => {
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(num);
            };

            // Safely update elements if they exist
            const costPerMeterNetEl = document.getElementById('costPerMeterNet');
            if (costPerMeterNetEl) costPerMeterNetEl.textContent = formatNumber(costPerMeterNet);
            
            const costPerMeterGrossEl = document.getElementById('costPerMeterGross');
            if (costPerMeterGrossEl) costPerMeterGrossEl.textContent = formatNumber(costPerMeterGross);
            
            const valuePerMeterEl = document.getElementById('valuePerMeter');
            if (valuePerMeterEl) valuePerMeterEl.textContent = formatNumber(valuePerMeter);
            
            
            const finalProfitAmountEl = document.getElementById('finalProfitAmount');
            if (finalProfitAmountEl) finalProfitAmountEl.textContent = formatNumber(finalProfitAmount);
            
            const totalProfitPercentageEl = document.getElementById('totalProfitPercentage');
            if (totalProfitPercentageEl) totalProfitPercentageEl.textContent = formatPercentage(totalProfitPercentage);
            
            // Calculate average construction period
            calculateAverageConstructionPeriod();

            console.log('Cost and Value Calculations:', {
                finalCost,
                totalArea,
                totalInfrastructure,
                totalValue,
                costPerMeterNet,
                costPerMeterGross,
                valuePerMeter,
                finalProfitAmount,
                totalProfitPercentage
            });
        }

        // Calculate annual profit percentage
        function calculateAnnualProfitPercentage(averagePeriod) {
            try {
                // Get total profit percentage from the card
                const totalProfitPercentageEl = document.getElementById('totalProfitPercentage');
                if (!totalProfitPercentageEl) {
                    console.warn('Total profit percentage element not found');
                    return;
                }
                
                const totalProfitPercentageText = totalProfitPercentageEl.textContent;
                const totalProfitPercentage = parseFloat(totalProfitPercentageText.replace(/,/g, '')) || 0;
                
                let annualProfitPercentage = 0;
                if (averagePeriod > 0) {
                    // Formula: (Total Profit Percentage / Average Construction Period) * 12
                    annualProfitPercentage = (totalProfitPercentage / averagePeriod) * 12;
                }
                
                // Format and display
                const formatNumber = (num) => {
                    return new Intl.NumberFormat('en-US', {
                        minimumFractionDigits: 1,
                        maximumFractionDigits: 1
                    }).format(num);
                };
                
                const annualProfitPercentageEl = document.getElementById('annualProfitPercentage');
                if (annualProfitPercentageEl) {
                    annualProfitPercentageEl.textContent = formatNumber(annualProfitPercentage);
                }
                
                console.log('Annual Profit Percentage Calculation:', {
                    totalProfitPercentage,
                    averagePeriod,
                    annualProfitPercentage
                });
                
                // Calculate monthly and daily profit percentages
                calculateMonthlyAndDailyProfitPercentage(annualProfitPercentage);
                
            } catch (error) {
                console.error('Error calculating annual profit percentage:', error);
            }
        }

        // Calculate monthly and daily profit percentages
        async function calculateMonthlyAndDailyProfitPercentage(annualProfitPercentage) {
            try {
                // Calculate monthly profit percentage: Annual / 12
                const monthlyProfitPercentage = annualProfitPercentage / 12;
                
                // Get correction factor from project statistics
                let correctionFactor = 1.0; // Default value
                try {
                    const response = await fetch(`${API_BASE}Project/statistics/`);
                    if (response.ok) {
                        const data = await response.json();
                        correctionFactor = parseFloat(data.correction_factor) || 1.0;
                    }
                } catch (error) {
                    console.warn('Could not fetch correction factor, using default:', error);
                }
                
                // Calculate daily profit percentage: (Annual / 365) * correction_factor
                const dailyProfitPercentage = (annualProfitPercentage / 365) * correctionFactor;
                
                // Format and display monthly profit percentage
                const formatNumber = (num) => {
                    return new Intl.NumberFormat('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(num);
                };
                
                const monthlyProfitPercentageEl = document.getElementById('monthlyProfitPercentage');
                if (monthlyProfitPercentageEl) {
                    monthlyProfitPercentageEl.textContent = formatNumber(monthlyProfitPercentage);
                }
                
                // Format and display daily profit percentage with 8 decimal places
                const formatDailyNumber = (num) => {
                    return new Intl.NumberFormat('en-US', {
                        minimumFractionDigits: 8,
                        maximumFractionDigits: 8
                    }).format(num);
                };
                
                const dailyProfitPercentageEl = document.getElementById('dailyProfitPercentage');
                if (dailyProfitPercentageEl) {
                    dailyProfitPercentageEl.textContent = formatDailyNumber(dailyProfitPercentage);
                }
                
                console.log('Monthly and Daily Profit Percentage Calculation:', {
                    annualProfitPercentage,
                    monthlyProfitPercentage,
                    correctionFactor,
                    dailyProfitPercentage
                });
                
            } catch (error) {
                console.error('Error calculating monthly and daily profit percentages:', error);
            }
        }

        // Calculate average construction period
        async function calculateAverageConstructionPeriod() {
            try {
                // Load expenses data with period information
                const response = await fetch(`${API_BASE}Expense/with_periods/`);
                if (response.ok) {
                    const data = await response.json();
                    const expenses = data.expenses || [];
                    
                    console.log('API Response:', {
                        total_count: data.total_count,
                        expenses_with_period: data.expenses_with_period,
                        expenses_without_period: data.expenses_without_period,
                        active_project: data.active_project
                    });
                    
                    // Group expenses by period and calculate weighted average
                    const periodData = {};
                    let totalWeightedCost = 0;
                    let totalCost = 0;
                    
                    let expensesWithoutPeriod = 0;
                    let expensesWithPeriod = 0;
                    
                    expenses.forEach(expense => {
                        const periodId = expense.period;
                        const amount = parseFloat(expense.amount) || 0;
                        const weight = parseFloat(expense.period_weight) || 0;
                        
                        // Skip if period is null or undefined
                        if (!periodId) {
                            expensesWithoutPeriod++;
                            console.warn('Expense without period:', {
                                id: expense.id,
                                amount: expense.amount,
                                expense_type: expense.expense_type,
                                period: expense.period,
                                period_weight: expense.period_weight
                            });
                            return;
                        }
                        
                        expensesWithPeriod++;
                        
                        if (!periodData[periodId]) {
                            periodData[periodId] = {
                                totalAmount: 0,
                                weight: weight,
                                count: 0
                            };
                        }
                        
                        periodData[periodId].totalAmount += amount;
                        periodData[periodId].count += 1;
                    });
                    
                    console.log('Period Statistics:', {
                        totalExpenses: expenses.length,
                        expensesWithPeriod,
                        expensesWithoutPeriod
                    });
                    
                    // Calculate weighted average
                    Object.values(periodData).forEach(period => {
                        const weightedCost = period.totalAmount * period.weight;
                        totalWeightedCost += weightedCost;
                        totalCost += period.totalAmount;
                    });
                    
                    let averagePeriod = 0;
                    if (totalCost > 0) {
                        averagePeriod = totalWeightedCost / totalCost;
                    }
                    
                    // Format and display
                    const formatNumber = (num) => {
                        return new Intl.NumberFormat('en-US', {
                            minimumFractionDigits: 1,
                            maximumFractionDigits: 1
                        }).format(num);
                    };
                    
                    const averagePeriodEl = document.getElementById('averageConstructionPeriod');
                    if (averagePeriodEl) {
                        averagePeriodEl.textContent = formatNumber(averagePeriod);
                    }
                    
                    // Calculate annual profit percentage
                    calculateAnnualProfitPercentage(averagePeriod);
                    
                    console.log('Average Construction Period Calculation:', {
                        totalExpenses: expenses.length,
                        sampleExpenses: expenses.slice(0, 3), // Show first 3 expenses for debugging
                        periodData,
                        totalWeightedCost,
                        totalCost,
                        averagePeriod
                    });
                    
                } else {
                    console.error('Error loading expenses for period calculation');
                }
            } catch (error) {
                console.error('Error calculating average construction period:', error);
            }
        }

        // Display rates in table
        function displayRates() {
            const tbody = document.getElementById('ratesTableBody');
            const table = document.getElementById('ratesTable');
            const emptyState = document.getElementById('emptyState');

            if (rates.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            tbody.innerHTML = rates.map(rate => `
                <tr>
                    <td>
                        <span class="rate-percentage">${(rate.rate * 100).toFixed(6)}%</span>
                    </td>
                    <td>
                        <span class="date-display">${rate.effective_date_display || rate.effective_date || 'نامشخص'}</span>
                    </td>
                    <td>
                        <span class="status-badge ${rate.is_active ? 'status-active' : 'status-inactive'}">
                            ${rate.is_active ? 'فعال' : 'غیرفعال'}
                        </span>
                    </td>
                    <td>${rate.description || '-'}</td>
                    <td>
                        <span class="date-display">${new Date(rate.created_at).toLocaleDateString('fa-IR')}</span>
                    </td>
                </tr>
            `).join('');
        }

        // Show loading spinner
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        // Show alert
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // Initialize tooltips
        function initializeTooltips() {
            const infoIcons = document.querySelectorAll('.info-icon');
            
            infoIcons.forEach(icon => {
                const tooltipText = icon.getAttribute('data-tooltip');
                if (tooltipText) {
                    // Create tooltip element
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = tooltipText;
                    
                    // Add tooltip to body to avoid overflow issues
                    document.body.appendChild(tooltip);
                    
                    // Add click event to show/hide tooltip
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // Hide all other tooltips
                        document.querySelectorAll('.tooltip.show').forEach(t => {
                            t.classList.remove('show');
                        });
                        
                        // Get icon position
                        const iconRect = icon.getBoundingClientRect();
                        
                        // Position tooltip below the icon
                        tooltip.style.left = (iconRect.left - 50) + 'px';
                        tooltip.style.top = (iconRect.bottom + 10) + 'px';
                        
                        // Toggle current tooltip
                        tooltip.classList.toggle('show');
                    });
                }
            });
            
            // Hide tooltips when clicking outside
            document.addEventListener('click', function() {
                document.querySelectorAll('.tooltip.show').forEach(tooltip => {
                    tooltip.classList.remove('show');
                });
            });
            
            // Hide tooltips on scroll
            window.addEventListener('scroll', function() {
                document.querySelectorAll('.tooltip.show').forEach(tooltip => {
                    tooltip.classList.remove('show');
                });
            });
            
            // Hide tooltips on window resize
            window.addEventListener('resize', function() {
                document.querySelectorAll('.tooltip.show').forEach(tooltip => {
                    tooltip.classList.remove('show');
                });
            });
        }
    </script>
</body>
</html>