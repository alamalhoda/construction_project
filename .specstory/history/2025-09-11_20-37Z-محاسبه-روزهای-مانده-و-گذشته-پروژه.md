<!-- Generated by SpecStory -->

<!-- cursor Session 78bf02e3-632b-464d-a2a6-8446fd267bb8 (2025-09-11 20:37Z) -->

# محاسبه روزهای مانده و گذشته پروژه (2025-09-11 20:37Z)

_**User (2025-09-11 16:09Z)**_

سلام. میخواهم پروژه قابلیت این رو داشته باشد که با توجه به تاریخ امروز بتواند تعداد روز مانده تا پایان پروزه و تعدادد روز گذشته از از ابتدای پروژه را محاسبه کند و از طریق api در اختیار قرار دهد.
این دو عدد را در صفحه داشبورد مالی یعنی project-dashboard.html به عنوان ۲ کارت نمایش دهد

---

_**Assistant (default)**_

سلام! من این قابلیت را برای شما پیاده‌سازی می‌کنم. ابتدا بیایید کد موجود را بررسی کنم تا بفهمم ساختار فعلی چگونه است.


---

Tool use: **todo_write**

## Todo List

- [-] بررسی مدل‌های موجود و API های فعلی
- [ ] اضافه کردن endpoint جدید به API برای محاسبه روزهای مانده و گذشته
- [ ] اضافه کردن کارت‌های جدید در project-dashboard.html
- [ ] تست کردن قابلیت جدید

---

Tool use: **read_file**

Read file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/construction/models.py

---

Tool use: **read_file**

Read file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/construction/api.py

---

Tool use: **read_file**

Read file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html

---

Tool use: **todo_write**

## Todo List

- [x] بررسی مدل‌های موجود و API های فعلی
- [ ] اضافه کردن endpoint جدید به API برای محاسبه روزهای مانده و گذشته
- [ ] اضافه کردن کارت‌های جدید در project-dashboard.html
- [ ] تست کردن قابلیت جدید

---

عالی! حالا ساختار موجود را بررسی کردم. می‌بینم که در مدل `Transaction` قبلاً منطق محاسبه روزهای مانده و گذشته وجود دارد، اما این فقط برای تراکنش‌ها است. حالا باید یک API endpoint جدید ایجاد کنم که این محاسبات را برای تاریخ امروز انجام دهد.


---

Tool use: **todo_write**

## Todo List

- [x] بررسی مدل‌های موجود و API های فعلی
- [-] اضافه کردن endpoint جدید به API برای محاسبه روزهای مانده و گذشته
- [ ] اضافه کردن کارت‌های جدید در project-dashboard.html
- [ ] تست کردن قابلیت جدید

---

حالا یک endpoint جدید به API اضافه می‌کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/construction/api.py</summary>

**Chunk 1**
Lines added: 72, lines removed: undefined

```diff
@@ -345,4 +345,76 @@
              return Response({'error': f'خطا در تنظیم پروژه فعال: {str(e)}'}, status=500)
  
+     @action(detail=False, methods=['get'])
+     def project_timeline(self, request):
+         """محاسبه روزهای مانده و گذشته پروژه بر اساس تاریخ امروز"""
+         from datetime import date
+         
+         try:
+             # دریافت پروژه فعال
+             active_project = models.Project.get_active_project()
+             if not active_project:
+                 return Response({
+                     'error': 'هیچ پروژه فعالی یافت نشد'
+                 }, status=400)
+ 
+             # تاریخ امروز
+             today = date.today()
+             
+             # محاسبه روزهای مانده تا پایان پروژه
+             days_remaining = 0
+             if active_project.end_date_gregorian:
+                 end_date = active_project.end_date_gregorian
+                 if isinstance(end_date, str):
+                     from datetime import datetime
+                     end_date = datetime.strptime(end_date, '%Y-%m-%d').date()
+                 days_remaining = (end_date - today).days
+             
+             # محاسبه روزهای گذشته از ابتدای پروژه
+             days_from_start = 0
+             if active_project.start_date_gregorian:
+                 start_date = active_project.start_date_gregorian
+                 if isinstance(start_date, str):
+                     from datetime import datetime
+                     start_date = datetime.strptime(start_date, '%Y-%m-%d').date()
+                 days_from_start = (today - start_date).days
+             
+             # محاسبه مدت کل پروژه
+             total_project_days = 0
+             if (active_project.start_date_gregorian and 
+                 active_project.end_date_gregorian):
+                 start_date = active_project.start_date_gregorian
+                 end_date = active_project.end_date_gregorian
+                 if isinstance(start_date, str):
+                     from datetime import datetime
+                     start_date = datetime.strptime(start_date, '%Y-%m-%d').date()
+                 if isinstance(end_date, str):
+                     from datetime import datetime
+                     end_date = datetime.strptime(end_date, '%Y-%m-%d').date()
+                 total_project_days = (end_date - start_date).days
+ 
+             return Response({
+                 'success': True,
+                 'project': {
+                     'id': active_project.id,
+                     'name': active_project.name,
+                     'start_date_shamsi': str(active_project.start_date_shamsi),
+                     'end_date_shamsi': str(active_project.end_date_shamsi),
+                     'start_date_gregorian': str(active_project.start_date_gregorian),
+                     'end_date_gregorian': str(active_project.end_date_gregorian)
+                 },
+                 'today': str(today),
+                 'timeline': {
+                     'days_remaining': days_remaining,
+                     'days_from_start': days_from_start,
+                     'total_project_days': total_project_days,
+                     'progress_percentage': round((days_from_start / total_project_days * 100), 2) if total_project_days > 0 else 0
+                 }
+             })
+ 
+         except Exception as e:
+             return Response({
+                 'error': f'خطا در محاسبه زمان‌بندی پروژه: {str(e)}'
+             }, status=500)
+ 
  
  class TransactionViewSet(viewsets.ModelViewSet):
```

</details>

---

Tool use: **todo_write**

## Todo List

- [x] بررسی مدل‌های موجود و API های فعلی
- [x] اضافه کردن endpoint جدید به API برای محاسبه روزهای مانده و گذشته
- [-] اضافه کردن کارت‌های جدید در project-dashboard.html
- [ ] تست کردن قابلیت جدید

---

حالا باید کارت‌های جدید را به صفحه داشبورد اضافه کنم. ابتدا بخش stats-grid را بررسی می‌کنم:


---

Tool use: **read_file**

Read file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html

---

حالا دو کارت جدید برای روزهای مانده و گذشته اضافه می‌کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html</summary>

**Chunk 1**
Lines added: 10, lines removed: undefined

```diff
@@ -545,4 +545,14 @@
                      <p>مجموع کل هزینه‌ها (میلیون تومان)</p>
                  </div>
+                 <div class="stat-card timeline-card">
+                     <i class="fas fa-clock"></i>
+                     <h3 id="daysRemaining">-</h3>
+                     <p>روز مانده تا پایان پروژه</p>
+                 </div>
+                 <div class="stat-card timeline-card">
+                     <i class="fas fa-history"></i>
+                     <h3 id="daysFromStart">-</h3>
+                     <p>روز گذشته از ابتدای پروژه</p>
+                 </div>
              </div>
  
```

</details>

---

حالا باید JavaScript کد را اضافه کنم تا داده‌ها را از API دریافت کرده و در کارت‌ها نمایش دهد. ابتدا بخش JavaScript را پیدا می‌کنم:


---

Tool use: **read_file**

Read file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html

---

بیایید بخش loadData function را پیدا کنم:


---

Tool use: **grep**

<details>
<summary>Grep for "function loadData" in "/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html" • 1 match</summary>

Output mode: content


| Content | Line |
|------|------|
| `async function loadData() \{` | L628 |


</details>

---

حالا باید API call جدید را به loadData function اضافه کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -631,5 +631,5 @@
                  
                  // بارگذاری موازی همه داده‌ها
-                 const [transactionsResponse, investorsResponse, projectsResponse, interestRateResponse, expensesResponse] = await Promise.all([
+                 const [transactionsResponse, investorsResponse, projectsResponse, interestRateResponse, expensesResponse, timelineResponse] = await Promise.all([
                      fetch('/construction/api/v1/Transaction/'),
                      fetch('/construction/api/v1/Investor/'),
```

**Chunk 2**
Lines added: 4, lines removed: undefined

```diff
@@ -645,4 +645,8 @@
                          console.warn('خطا در دسترسی به API هزینه‌ها:', err);
                          return { ok: false, status: 404 }; // fallback response
+                     }),
+                     fetch('/construction/api/v1/Project/project_timeline/').catch(err => {
+                         console.warn('خطا در دسترسی به API زمان‌بندی پروژه:', err);
+                         return { ok: false, status: 404 }; // fallback response
                      })
                  ]);
```

</details>

---

حالا باید بخش پردازش timeline response را اضافه کنم:


---

Tool use: **grep**

<details>
<summary>Grep for "timelineResponse" in "/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html" • 1 match</summary>

Output mode: content


| Content | Line |
|------|------|
| `const [transactionsResponse, investorsResponse, projectsResponse, interestRateResponse, expensesResponse, timelineResponse] = await Promise.all([` | L633 |


</details>

---

بیایید بخش پردازش response ها را پیدا کنم:


---

Tool use: **grep**

<details>
<summary>Grep for "expensesResponse.json" in "/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html" • 1 match</summary>

Output mode: content


| Content | Line |
|------|------|
| `expensesData = await expensesResponse.json();` | L694 |


</details>

---

حالا بخش پردازش timeline response را اضافه می‌کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html</summary>

**Chunk 1**
Lines added: 9, lines removed: undefined

```diff
@@ -698,4 +698,13 @@
                      expensesData = null;
                  }
+                 
+                 // اگر timeline API دسترسی داشت، آن را بارگذاری کن
+                 let timelineData = null;
+                 if (timelineResponse.ok) {
+                     timelineData = await timelineResponse.json();
+                     console.log('داده‌های زمان‌بندی پروژه بارگذاری شدند:', timelineData);
+                 } else {
+                     console.warn('API زمان‌بندی پروژه دسترسی ندارد');
+                 }
                  
                  console.log('داده‌ها بارگذاری شدند:', {
```

</details>

---

حالا باید بخش نمایش داده‌ها در کارت‌ها را پیدا کنم و timeline data را اضافه کنم:


---

Tool use: **grep**

---

بیایید بخش نمایش آمار را پیدا کنم:


---

Tool use: **grep**

---

بیایید بخش نمایش آمار را پیدا کنم:


---

Tool use: **grep**

<details>
<summary>Grep for "getElementById.*totalPrincipal" in "/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html" • 1 match</summary>

Output mode: content


| Content | Line |
|------|------|
| `document.getElementById('totalPrincipal').textContent = (currentCapital / BASE_AMOUNT).toFixed(1);` | L826 |


</details>

---

عالی! حالا بخش به‌روزرسانی آمار را پیدا کردم. حالا timeline data را به آن اضافه می‌کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html</summary>

**Chunk 1**
Lines added: 22, lines removed: undefined

```diff
@@ -829,4 +829,26 @@
              document.getElementById('startDate').textContent = projectStartDate;
              document.getElementById('endDate').textContent = projectEndDate === '-' ? 'ادامه دارد' : projectEndDate;
+             
+             // به‌روزرسانی timeline data اگر موجود باشد
+             if (timelineData && timelineData.success && timelineData.timeline) {
+                 const daysRemaining = timelineData.timeline.days_remaining;
+                 const daysFromStart = timelineData.timeline.days_from_start;
+                 
+                 document.getElementById('daysRemaining').textContent = daysRemaining.toLocaleString('fa-IR');
+                 document.getElementById('daysFromStart').textContent = daysFromStart.toLocaleString('fa-IR');
+                 
+                 // تغییر رنگ کارت روزهای مانده بر اساس مقدار
+                 const daysRemainingCard = document.querySelector('#daysRemaining').closest('.stat-card');
+                 if (daysRemaining > 30) {
+                     daysRemainingCard.style.borderColor = '#28a745'; // سبز
+                 } else if (daysRemaining > 0) {
+                     daysRemainingCard.style.borderColor = '#ffc107'; // زرد
+                 } else {
+                     daysRemainingCard.style.borderColor = '#dc3545'; // قرمز
+                 }
+             } else {
+                 document.getElementById('daysRemaining').textContent = '-';
+                 document.getElementById('daysFromStart').textContent = '-';
+             }
              
              // نمایش نرخ سود روزانه فعال با دقت کامل
```

</details>

---

حالا باید متغیر timelineData را در scope function قرار دهم. بیایید بخش function signature را پیدا کنم:


---

Tool use: **grep**

---

بیایید function signature را پیدا کنم:


---

Tool use: **grep**

<details>
<summary>Grep for "function.*updateStats" in "/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html" • 1 match</summary>

Output mode: content


| Content | Line |
|------|------|
| `function updateStats() \{` | L774 |


</details>

---

حالا باید timelineData را به function updateStats پاس دهم. ابتدا بیایید ببینم کجا updateStats فراخوانی می‌شود:


---

Tool use: **grep**

<details>
<summary>Grep for "updateStats\(\)" in "/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html" • 2 matches</summary>

Output mode: content


| Content | Line |
|------|------|
| `updateStats();` | L762 |
| `function updateStats() \{` | L774 |


</details>

---

حالا باید timelineData را به عنوان global variable تعریف کنم و در updateStats استفاده کنم. ابتدا بیایید بخش تعریف متغیرهای global را پیدا کنم:


---

Tool use: **grep**

<details>
<summary>Grep for "let.*chartData" in "/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html" • 1 match</summary>

Output mode: content


| Content | Line |
|------|------|
| `let chartData = null;` | L617 |


</details>

---

عالی! حالا timelineData را به متغیرهای global اضافه می‌کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -621,4 +621,5 @@
          let expensesData = null;
          let currentInterestRate = null;
+         let timelineData = null;
  
          // متغیر برای تبدیل مبالغ (10 میلیون)
```

</details>

---

حالا باید timelineData را در loadData function تنظیم کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -701,10 +701,10 @@
                  
                  // اگر timeline API دسترسی داشت، آن را بارگذاری کن
-                 let timelineData = null;
                  if (timelineResponse.ok) {
                      timelineData = await timelineResponse.json();
                      console.log('داده‌های زمان‌بندی پروژه بارگذاری شدند:', timelineData);
                  } else {
                      console.warn('API زمان‌بندی پروژه دسترسی ندارد');
+                     timelineData = null;
                  }
                  
```

</details>

---

حالا باید CSS برای کارت‌های timeline اضافه کنم. ابتدا بخش CSS را پیدا می‌کنم:


---

Tool use: **grep**

---

بیایید بخش CSS را پیدا کنم:


---

Tool use: **grep**

<details>
<summary>Grep for "\.stat-card" in "/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html" • 20 matches</summary>

Output mode: content


| Content | Line |
|------|------|
| `.stat-card.interest-rate-card \{` | L237 |
| `.stat-card.interest-rate-card i \{` | L245 |
| `.stat-card.interest-rate-card h3 \{` | L250 |
| `.stat-card.interest-rate-card p \{` | L256 |
| `.stat-card.expenses-card \{` | L261 |
| `.stat-card.expenses-card i \{` | L268 |
| `.stat-card.expenses-card h3 \{` | L273 |
| `.stat-card.expenses-card p \{` | L279 |
| `.stat-card \{` | L284 |
| `.stat-card:hover \{` | L294 |
| `.stat-card i \{` | L299 |
| `.stat-card h3 \{` | L305 |
| `.stat-card p \{` | L311 |
| `.stat-card.interest-rate-card \{` | L437 |
| `.stat-card.interest-rate-card i \{` | L442 |
| `.stat-card.interest-rate-card h3 \{` | L446 |
| `.stat-card.expenses-card \{` | L450 |
| `.stat-card.expenses-card i \{` | L455 |
| `.stat-card.expenses-card h3 \{` | L459 |
| `const daysRemainingCard = document.querySelector('#daysRemaining').closest('.stat-card');` | L842 |


</details>

---

حالا CSS برای timeline-card ها اضافه می‌کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html</summary>

**Chunk 1**
Lines added: 23, lines removed: undefined

```diff
@@ -281,4 +281,27 @@
              font-size: 1.1rem;
          }
+ 
+         .stat-card.timeline-card {
+             background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
+             color: white;
+             transform: scale(1.05);
+             box-shadow: 0 12px 40px rgba(78, 205, 196, 0.3);
+         }
+ 
+         .stat-card.timeline-card i {
+             color: white;
+             font-size: 3rem;
+         }
+ 
+         .stat-card.timeline-card h3 {
+             color: white;
+             font-size: 2.5rem;
+             font-weight: bold;
+         }
+ 
+         .stat-card.timeline-card p {
+             color: rgba(255, 255, 255, 0.9);
+             font-size: 1.1rem;
+         }
  
          .stat-card {
```

</details>

---

حالا CSS responsive را نیز اضافه می‌کنم:


---

Tool use: **search_replace**


<details><summary>Edit file: /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html</summary>

**Chunk 1**
Lines added: 13, lines removed: undefined

```diff
@@ -483,4 +483,17 @@
                  font-size: 2rem;
              }
+ 
+             .stat-card.timeline-card {
+                 grid-column: span 1;
+                 transform: scale(1);
+             }
+ 
+             .stat-card.timeline-card i {
+                 font-size: 2.5rem;
+             }
+ 
+             .stat-card.timeline-card h3 {
+                 font-size: 2rem;
+             }
          }
      </style>
```

</details>

---

Tool use: **todo_write**

## Todo List

- [x] بررسی مدل‌های موجود و API های فعلی
- [x] اضافه کردن endpoint جدید به API برای محاسبه روزهای مانده و گذشته
- [x] اضافه کردن کارت‌های جدید در project-dashboard.html
- [-] تست کردن قابلیت جدید

---

حالا بیایید lint errors را بررسی کنم:


---

Tool use: **read_lints**

<details>
          <summary>Read lints for 2 files</summary>
      
Lint paths:

- `/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/construction/api.py`
- `/Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project/dashboard/view/project_dashboard.html`

Lint results


**No lint errors found**
</details>

---

عالی! حالا بیایید یک تست ساده انجام دهم تا مطمئن شوم همه چیز کار می‌کند:


---

Tool use: **run_terminal_cmd**

```bash
cd /Users/alamalhoda/Projects/Arash_Project/djangobuilder/construction_project && python manage.py shell -c "
from construction.models import Project
from datetime import date, timedelta

# بررسی اینکه آیا پروژه فعالی وجود دارد
active_project = Project.get_active_project()
if active_project:
    print(f'پروژه فعال: {active_project.name}')
    print(f'تاریخ شروع: {active_project.start_date_gregorian}')
    print(f'تاریخ پایان: {active_project.end_date_gregorian}')
    
    # محاسبه روزهای مانده و گذشته
    today = date.today()
    if active_project.end_date_gregorian:
        days_remaining = (active_project.end_date_gregorian - today).days
        print(f'روزهای مانده تا پایان: {days_remaining}')
    
    if active_project.start_date_gregorian:
        days_from_start = (today - active_project.start_date_gregorian).days
        print(f'روزهای گذشته از ابتدا: {days_from_start}')
else:
    print('هیچ پروژه فعالی یافت نشد')
"
```

```
zsh: command not found: python
```

---



---

